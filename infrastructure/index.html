<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure â€” Command Center</title>
    <meta name="version" content="1.0.0">
    <meta name="gs-app-id" content="cc-infrastructure">
    <link rel="stylesheet" href="../shared/cc-shared.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="../shared/cc-shared.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;"><div style="text-align:center;">Loading Infrastructure...</div></div></div>

    <script type="text/babel">
    console.log('Infrastructure Satellite v1.0.0 starting...');

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    
    const fb = initFirebase();
    const firebaseAuth = fb ? fb.auth : null;
    const firebaseDb = fb ? fb.db : null;
    
    const isFileProtocol = window.location.protocol === 'file:';


    // =========================================================================
    // ICONS (subset needed by Infrastructure views)
    // =========================================================================
    
    const Icons = {
        Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
        Database: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>,
        Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
        Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
        Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
        File: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        Folder: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>,
        Play: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
        Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
    };


    // =========================================================================
    // FIREBASE ADMIN SERVICE
    // =========================================================================

    class FirebaseAdmin {
        constructor() {
            this.serviceAccount = null;
            this.cachedToken = null;
            this.tokenExpiry = null;
            this.loadServiceAccount();
        }
        
        // Load service account JSON from localStorage
        loadServiceAccount() {
            try {
                const stored = localStorage.getItem('gs_firebase_sa') || localStorage.getItem('cc_firebase_sa');
                if (stored) {
                    this.serviceAccount = JSON.parse(stored);
                    console.log('Firebase SA loaded:', this.serviceAccount.client_email);
                }
            } catch (e) {
                console.error('Failed to load service account:', e);
                this.serviceAccount = null;
            }
        }
        
        // Save service account JSON to localStorage
        saveServiceAccount(saJson) {
            try {
                const sa = typeof saJson === 'string' ? JSON.parse(saJson) : saJson;
                // Validate required fields
                const required = ['type', 'project_id', 'private_key', 'client_email'];
                const missing = required.filter(f => !sa[f]);
                if (missing.length > 0) {
                    throw new Error(`Missing required fields: ${missing.join(', ')}`);
                }
                if (sa.type !== 'service_account') {
                    throw new Error(`Invalid type "${sa.type}" â€” expected "service_account"`);
                }
                // Validate private key format
                if (!sa.private_key.includes('BEGIN') || !sa.private_key.includes('PRIVATE KEY')) {
                    throw new Error('Invalid private key format');
                }
                this.serviceAccount = sa;
                localStorage.setItem('cc_firebase_sa', JSON.stringify(sa));
                localStorage.setItem('gs_firebase_sa', JSON.stringify(sa));
                this.cachedToken = null;
                this.tokenExpiry = null;
                console.log('Firebase SA saved:', sa.client_email);
                return { success: true, email: sa.client_email, project: sa.project_id };
            } catch (e) {
                console.error('Failed to save service account:', e);
                return { success: false, error: e.message };
            }
        }
        
        // Remove service account from localStorage
        clearServiceAccount() {
            this.serviceAccount = null;
            this.cachedToken = null;
            this.tokenExpiry = null;
            localStorage.removeItem('cc_firebase_sa');
            localStorage.removeItem('gs_firebase_sa');
            console.log('Firebase SA cleared');
        }
        
        // Check if configured
        isConfigured() {
            return this.serviceAccount !== null && !!this.serviceAccount.private_key;
        }
        
        // Get summary info (safe to display)
        getInfo() {
            if (!this.serviceAccount) return null;
            return {
                email: this.serviceAccount.client_email,
                projectId: this.serviceAccount.project_id,
                keyId: this.serviceAccount.private_key_id?.slice(0, 8) + '...',
                tokenCached: !!this.cachedToken,
                tokenExpiry: this.tokenExpiry ? new Date(this.tokenExpiry).toLocaleTimeString() : null,
                tokenValid: this.cachedToken && this.tokenExpiry && Date.now() < this.tokenExpiry
            };
        }
        
        // Parse PEM private key to CryptoKey for RS256 signing
        async importPrivateKey(pemKey) {
            // Strip PEM header/footer and whitespace
            const pemContents = pemKey
                .replace(/-----BEGIN (RSA )?PRIVATE KEY-----/, '')
                .replace(/-----END (RSA )?PRIVATE KEY-----/, '')
                .replace(/\s/g, '');
            
            // Decode base64 to ArrayBuffer
            const binaryStr = atob(pemContents);
            const bytes = new Uint8Array(binaryStr.length);
            for (let i = 0; i < binaryStr.length; i++) {
                bytes[i] = binaryStr.charCodeAt(i);
            }
            
            // Import as PKCS8 key
            return await crypto.subtle.importKey(
                'pkcs8',
                bytes.buffer,
                { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
                false,
                ['sign']
            );
        }
        
        // Base64url encode (no padding, URL-safe)
        base64url(data) {
            if (typeof data === 'string') {
                data = new TextEncoder().encode(data);
            }
            const bytes = new Uint8Array(data);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binary);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        
        // Create and sign a JWT for Google OAuth2
        async createSignedJWT(scopes) {
            const sa = this.serviceAccount;
            if (!sa) throw new Error('No service account configured');
            
            const now = Math.floor(Date.now() / 1000);
            
            const header = { alg: 'RS256', typ: 'JWT' };
            if (sa.private_key_id) header.kid = sa.private_key_id;
            
            const payload = {
                iss: sa.client_email,
                scope: Array.isArray(scopes) ? scopes.join(' ') : scopes,
                aud: 'https://oauth2.googleapis.com/token',
                iat: now,
                exp: now + 3600 // 1 hour
            };
            
            const headerB64 = this.base64url(JSON.stringify(header));
            const payloadB64 = this.base64url(JSON.stringify(payload));
            const signingInput = `${headerB64}.${payloadB64}`;
            
            // Import key and sign
            const cryptoKey = await this.importPrivateKey(sa.private_key);
            const signature = await crypto.subtle.sign(
                'RSASSA-PKCS1-v1_5',
                cryptoKey,
                new TextEncoder().encode(signingInput)
            );
            
            const signatureB64 = this.base64url(signature);
            return `${signingInput}.${signatureB64}`;
        }
        
        // Exchange signed JWT for a Google OAuth2 access token
        async getAccessToken(scopes = [
            'https://www.googleapis.com/auth/userinfo.email',
            'https://www.googleapis.com/auth/firebase.database',
            'https://www.googleapis.com/auth/cloud-platform'
        ]) {
            // Return cached token if still valid (with 5 min buffer)
            if (this.cachedToken && this.tokenExpiry && Date.now() < (this.tokenExpiry - 300000)) {
                return this.cachedToken;
            }
            
            const jwt = await this.createSignedJWT(scopes);
            
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                    assertion: jwt
                })
            });
            
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(`Token exchange failed: ${err.error_description || err.error || response.status}`);
            }
            
            const data = await response.json();
            this.cachedToken = data.access_token;
            this.tokenExpiry = Date.now() + ((data.expires_in || 3600) * 1000);
            console.log('Firebase admin token obtained, expires:', new Date(this.tokenExpiry).toLocaleTimeString());
            return this.cachedToken;
        }
        
        // Invalidate cached token
        clearToken() {
            this.cachedToken = null;
            this.tokenExpiry = null;
        }
        
        // ---- RTDB Rules API ----
        
        // Get current RTDB security rules
        async getRules() {
            const token = await this.getAccessToken();
            const dbUrl = FIREBASE_CONFIG.databaseURL;
            const response = await fetch(`${dbUrl}/.settings/rules.json?access_token=${encodeURIComponent(token)}`);
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to fetch rules: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }
        
        // Deploy new RTDB security rules
        async putRules(rules) {
            const token = await this.getAccessToken();
            const dbUrl = FIREBASE_CONFIG.databaseURL;
            const body = typeof rules === 'string' ? rules : JSON.stringify(rules);
            const response = await fetch(`${dbUrl}/.settings/rules.json?access_token=${encodeURIComponent(token)}`, {
                method: 'PUT',
                body: body
            });
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to deploy rules: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }
        
        // ---- Firebase Auth Config API (Identity Toolkit v2) ----
        
        // Get Firebase Auth project config (includes authorizedDomains)
        async getAuthConfig() {
            const token = await this.getAccessToken();
            const projectId = this.serviceAccount.project_id;
            const response = await fetch(
                `https://identitytoolkit.googleapis.com/v2/projects/${projectId}/config`,
                { headers: { 'Authorization': `Bearer ${token}` } }
            );
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to fetch auth config: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }
        
        // Get current authorized domains list
        async getAuthorizedDomains() {
            const config = await this.getAuthConfig();
            return config.authorizedDomains || [];
        }
        
        // Update authorized domains (replaces entire list â€” always include existing domains)
        async updateAuthorizedDomains(domains) {
            const token = await this.getAccessToken();
            const projectId = this.serviceAccount.project_id;
            const response = await fetch(
                `https://identitytoolkit.googleapis.com/v2/projects/${projectId}/config?updateMask=authorizedDomains`,
                {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${token}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ authorizedDomains: domains })
                }
            );
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to update authorized domains: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }
        
        // Add a domain to authorized domains (safe â€” reads current list first)
        async addAuthorizedDomain(domain) {
            const current = await this.getAuthorizedDomains();
            if (current.includes(domain)) {
                console.log(`[FirebaseAdmin] Domain ${domain} already authorized`);
                return { authorizedDomains: current, alreadyExists: true };
            }
            const updated = [...current, domain];
            const result = await this.updateAuthorizedDomains(updated);
            console.log(`[FirebaseAdmin] Added ${domain} to authorized domains`);
            return { authorizedDomains: result.authorizedDomains || updated, alreadyExists: false };
        }
        
        // Remove a domain from authorized domains
        async removeAuthorizedDomain(domain) {
            const current = await this.getAuthorizedDomains();
            const updated = current.filter(d => d !== domain);
            if (updated.length === current.length) {
                console.log(`[FirebaseAdmin] Domain ${domain} not found in authorized domains`);
                return { authorizedDomains: current, notFound: true };
            }
            const result = await this.updateAuthorizedDomains(updated);
            console.log(`[FirebaseAdmin] Removed ${domain} from authorized domains`);
            return { authorizedDomains: result.authorizedDomains || updated, notFound: false };
        }
        
        // ---- Cloud Functions API ----
        
        // List all Cloud Functions in the project
        async listFunctions(location = 'us-central1') {
            const token = await this.getAccessToken();
            const projectId = this.serviceAccount.project_id;
            const url = `https://cloudfunctions.googleapis.com/v1/projects/${projectId}/locations/${location}/functions`;
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(`Failed to list functions: ${err.error?.message || response.status}`);
            }
            const data = await response.json();
            return data.functions || [];
        }
        
        // ---- Cloud Logging API ----
        
        // Fetch recent logs (filtered by severity, function name, etc.)
        async getLogs(options = {}) {
            const token = await this.getAccessToken();
            const projectId = this.serviceAccount.project_id;
            const {
                filter = 'resource.type="cloud_function"',
                orderBy = 'timestamp desc',
                pageSize = 50
            } = options;
            
            const url = 'https://logging.googleapis.com/v2/entries:list';
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    resourceNames: [`projects/${projectId}`],
                    filter,
                    orderBy,
                    pageSize
                })
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(`Failed to fetch logs: ${err.error?.message || response.status}`);
            }
            const data = await response.json();
            return data.entries || [];
        }
        
        // Quick test â€” tries to read RTDB rules to verify admin access
        async testConnection() {
            const results = { token: false, rules: false, functions: false, authConfig: false, errors: [] };
            
            try {
                await this.getAccessToken();
                results.token = true;
            } catch (e) {
                results.errors.push(`Token: ${e.message}`);
                return results;
            }
            
            try {
                const rules = await this.getRules();
                results.rules = rules && typeof rules === 'object';
            } catch (e) {
                results.errors.push(`Rules: ${e.message}`);
            }
            
            try {
                const fns = await this.listFunctions();
                results.functions = Array.isArray(fns);
                results.functionCount = fns.length;
            } catch (e) {
                results.errors.push(`Functions: ${e.message}`);
            }
            
            try {
                const domains = await this.getAuthorizedDomains();
                results.authConfig = Array.isArray(domains);
                results.authorizedDomains = domains;
            } catch (e) {
                results.errors.push(`Auth Config: ${e.message}`);
            }
            
            return results;
        }
    }

    const firebaseAdmin = new FirebaseAdmin();

    // =========================================================================
    // DOMAIN SERVICES (Porkbun, GoDaddy, Registry)
    // =========================================================================

    const PorkbunService = {
        CONFIG_KEY: 'cc_domain_config',
        PRICE_CACHE_KEY: 'cc_tld_prices',
        HEALTH_CACHE_KEY: 'cc_domain_health',
        BASE_URL: 'https://api.porkbun.com/api/json/v3',
        PROXY_URL: 'https://us-central1-word-boxing.cloudfunctions.net/domainProxy',
        
        // GitHub Pages IP addresses (current as of 2025)
        GITHUB_PAGES_IPS: [
            '185.199.108.153',
            '185.199.109.153',
            '185.199.110.153',
            '185.199.111.153'
        ],
        
        // Preferred TLDs for domain search (ordered by relevance for dev tools)
        PREFERRED_TLDS: ['com', 'dev', 'app', 'io', 'co', 'ai', 'sh', 'tools', 'site', 'net'],
        
        // â”€â”€â”€ Configuration â”€â”€â”€
        
        getConfig() {
            try { return JSON.parse(localStorage.getItem(this.CONFIG_KEY) || '{}'); }
            catch { return {}; }
        },
        
        saveConfig(config) {
            localStorage.setItem(this.CONFIG_KEY, JSON.stringify(config));
        },
        
        isConfigured() {
            const cfg = this.getConfig();
            return !!(cfg.apiKey && cfg.secretApiKey);
        },
        
        // â”€â”€â”€ Core API Call (via Firebase proxy to avoid CORS) â”€â”€â”€
        
        async _call(endpoint, extraBody = {}) {
            const cfg = this.getConfig();
            if (!cfg.apiKey || !cfg.secretApiKey) {
                throw new Error('Porkbun API keys not configured. Go to Settings â†’ Domain Registrar.');
            }
            
            const response = await fetch(this.PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: 'porkbun',
                    endpoint: endpoint,
                    method: 'POST',
                    body: {
                        apikey: cfg.apiKey,
                        secretapikey: cfg.secretApiKey,
                        ...extraBody
                    }
                })
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Porkbun API error (${response.status}): ${text}`);
            }
            
            const data = await response.json();
            if (data.status === 'ERROR') {
                throw new Error(data.message || 'Porkbun API returned an error');
            }
            return data;
        },
        
        // â”€â”€â”€ Connection Test â”€â”€â”€
        
        async ping() {
            return await this._call('/ping');
            // Returns: { status: "SUCCESS", yourIp: "x.x.x.x" }
        },
        
        // â”€â”€â”€ Domain Operations â”€â”€â”€
        
        async listDomains() {
            const data = await this._call('/domain/listAll');
            return data.domains || [];
            // Returns: [{ domain, status, tld, createDate, expireDate, autoRenew, ... }]
        },
        
        async checkAvailability(domain) {
            const data = await this._call(`/domain/checkDomain/${domain}`);
            return {
                domain,
                available: data.response?.avail === 'yes',
                price: parseFloat(data.response?.price || 0),
                regularPrice: parseFloat(data.response?.regularPrice || 0),
                renewalPrice: parseFloat(data.response?.additional?.renewal?.price || 0),
                premium: data.response?.premium === 'yes',
                firstYearPromo: data.response?.firstYearPromo === 'yes',
                limits: data.limits
            };
        },
        
        async checkMultipleTLDs(keyword) {
            // Check availability across preferred TLDs
            // Rate limited: 1 check per 10 seconds at Porkbun
            const results = [];
            for (const tld of this.PREFERRED_TLDS) {
                const domain = keyword.includes('.') ? keyword : `${keyword}.${tld}`;
                try {
                    const result = await this.checkAvailability(domain);
                    results.push(result);
                } catch (e) {
                    results.push({ domain, available: false, error: e.message });
                }
                // Respect rate limits
                if (results.length < this.PREFERRED_TLDS.length) {
                    await this._rateLimit(10500); // 10.5s between checks
                }
            }
            return results;
        },
        
        async registerDomain(domain, costInPennies) {
            return await this._call(`/domain/create/${domain}`, {
                cost: costInPennies,
                agreeToTerms: 'yes'
            });
            // Returns: { status, domain, cost, orderId, balance }
        },
        
        async updateAutoRenew(domain, on = true) {
            return await this._call(`/domain/updateAutoRenew/${domain}`, {
                status: on ? 'on' : 'off'
            });
        },
        
        // â”€â”€â”€ DNS Record Management â”€â”€â”€
        
        async listDNSRecords(domain) {
            const data = await this._call(`/dns/retrieve/${domain}`);
            return data.records || [];
            // Returns: [{ id, name, type, content, ttl, prio, notes }]
        },
        
        async createDNSRecord(domain, type, name, content, ttl = 600, prio = null) {
            const body = { type, content, ttl: String(ttl) };
            if (name) body.name = name;
            if (prio !== null) body.prio = String(prio);
            const data = await this._call(`/dns/create/${domain}`, body);
            return { id: data.id, type, name: name || '@', content };
        },
        
        async editDNSRecord(domain, recordId, type, name, content, ttl = 600) {
            return await this._call(`/dns/edit/${domain}/${recordId}`, {
                type, content, ttl: String(ttl),
                ...(name ? { name } : {})
            });
        },
        
        async deleteDNSRecord(domain, recordId, allRecords) {
            // allRecords param unused â€” Porkbun supports individual record delete by ID
            return await this._call(`/dns/delete/${domain}/${recordId}`);
        },
        
        async deleteDNSByType(domain, type, subdomain) {
            const endpoint = subdomain 
                ? `/dns/deleteByNameType/${domain}/${type}/${subdomain}`
                : `/dns/deleteByNameType/${domain}/${type}`;
            return await this._call(endpoint);
        },
        
        // â”€â”€â”€ TLD Pricing (cached) â”€â”€â”€
        
        async getTLDPrices(forceRefresh = false) {
            // Check cache first
            if (!forceRefresh) {
                try {
                    const cached = JSON.parse(localStorage.getItem(this.PRICE_CACHE_KEY) || '{}');
                    if (cached.timestamp && Date.now() - cached.timestamp < 24 * 60 * 60 * 1000) {
                        return cached.prices;
                    }
                } catch {}
            }
            
            // Pricing endpoint via proxy (no auth needed but still has CORS issues)
            const response = await fetch(this.PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: 'porkbun',
                    endpoint: '/pricing/get',
                    method: 'POST',
                    body: {}
                })
            });
            const data = await response.json();
            
            if (data.status === 'SUCCESS' && data.pricing) {
                localStorage.setItem(this.PRICE_CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    prices: data.pricing
                }));
                return data.pricing;
            }
            throw new Error('Failed to fetch TLD pricing');
        },
        
        // â”€â”€â”€ GitHub Pages DNS Configuration â”€â”€â”€
        
        async configureForGitHubPages(domain, githubUsername) {
            const results = [];
            const log = [];
            
            // Step 1: Get existing records and remove conflicting ones
            log.push('Fetching existing DNS records...');
            const existing = await this.listDNSRecords(domain);
            
            // Delete existing A, AAAA, and root CNAME records that would conflict
            for (const record of existing) {
                const isRoot = record.name === domain || record.name === '';
                const isWww = record.name === `www.${domain}` || record.name === 'www';
                if ((isRoot && (record.type === 'A' || record.type === 'AAAA' || record.type === 'CNAME' || record.type === 'ALIAS')) ||
                    (isWww && record.type === 'CNAME')) {
                    log.push(`Deleting conflicting ${record.type} record: ${record.content}`);
                    await this.deleteDNSRecord(domain, record.id);
                    await this._rateLimit(1100);
                }
            }
            
            // Step 2: Create 4 A records for apex domain
            for (const ip of this.GITHUB_PAGES_IPS) {
                log.push(`Creating A record â†’ ${ip}`);
                const result = await this.createDNSRecord(domain, 'A', '', ip, 600);
                results.push(result);
                await this._rateLimit(1100);
            }
            
            // Step 3: Create CNAME for www â†’ username.github.io
            log.push(`Creating CNAME www â†’ ${githubUsername}.github.io`);
            const cnameResult = await this.createDNSRecord(
                domain, 'CNAME', 'www', `${githubUsername}.github.io`, 600
            );
            results.push(cnameResult);
            
            return { 
                success: true, 
                recordsCreated: results.length, 
                records: results,
                log
            };
        },
        
        // â”€â”€â”€ Domain Health Caching â”€â”€â”€
        
        getHealthCache() {
            try { return JSON.parse(localStorage.getItem(this.HEALTH_CACHE_KEY) || '{}'); }
            catch { return {}; }
        },
        
        setHealthCache(domain, result) {
            const cache = this.getHealthCache();
            cache[domain] = { lastCheck: new Date().toISOString(), result };
            localStorage.setItem(this.HEALTH_CACHE_KEY, JSON.stringify(cache));
        },
        
        // â”€â”€â”€ Utility â”€â”€â”€
        
        _rateLimit(ms = 1100) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },
        
        // Format price from string to display
        formatPrice(price) {
            const num = typeof price === 'string' ? parseFloat(price) : price;
            return isNaN(num) ? 'â€”' : `$${num.toFixed(2)}`;
        }
    };

    const GoDaddyService = {
        CONFIG_KEY: 'cc_godaddy_config',
        BASE_URL: 'https://api.godaddy.com/v1',
        PROXY_URL: 'https://us-central1-word-boxing.cloudfunctions.net/domainProxy',
        
        GITHUB_PAGES_IPS: [
            '185.199.108.153',
            '185.199.109.153',
            '185.199.110.153',
            '185.199.111.153'
        ],
        
        // â”€â”€â”€ Configuration â”€â”€â”€
        
        getConfig() {
            try { return JSON.parse(localStorage.getItem(this.CONFIG_KEY) || '{}'); }
            catch { return {}; }
        },
        
        saveConfig(config) {
            localStorage.setItem(this.CONFIG_KEY, JSON.stringify(config));
        },
        
        isConfigured() {
            const cfg = this.getConfig();
            return !!(cfg.apiKey && cfg.apiSecret);
        },
        
        // â”€â”€â”€ Core API Call (via Firebase proxy to avoid CORS) â”€â”€â”€
        
        async _call(endpoint, method = 'GET', body = null) {
            const cfg = this.getConfig();
            if (!cfg.apiKey || !cfg.apiSecret) {
                throw new Error('GoDaddy API keys not configured. Go to Settings â†’ Domain Registrar.');
            }
            
            const proxyBody = {
                provider: 'godaddy',
                endpoint: endpoint,
                method: method,
                headers: {
                    'Authorization': `sso-key ${cfg.apiKey}:${cfg.apiSecret}`
                }
            };
            if (body && ['POST', 'PUT', 'PATCH'].includes(method)) {
                proxyBody.body = body;
            }
            
            const response = await fetch(this.PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(proxyBody)
            });
            
            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.message || `GoDaddy API error (${response.status})`);
            }
            
            const text = await response.text();
            return text ? JSON.parse(text) : { status: 'SUCCESS' };
        },
        
        // â”€â”€â”€ Connection Test â”€â”€â”€
        
        async ping() {
            // GoDaddy has no explicit ping â€” we list domains as a test
            const domains = await this._call('/domains?limit=1');
            return { status: 'SUCCESS', yourIp: 'N/A', domainCount: domains.length };
        },
        
        // â”€â”€â”€ Domain Operations â”€â”€â”€
        
        async listDomains() {
            const data = await this._call('/domains');
            // Normalize to match PorkbunService format
            return data.map(d => ({
                domain: d.domain,
                status: d.status,
                tld: d.domain.split('.').pop(),
                createDate: d.createdAt,
                expireDate: d.expires,
                autoRenew: d.renewAuto,
                provider: 'godaddy'
            }));
        },
        
        // â”€â”€â”€ DNS Record Management â”€â”€â”€
        // GoDaddy uses type+name to identify records, NOT unique IDs
        // Records have: type, name, data (not content), ttl, priority
        
        async listDNSRecords(domain) {
            const data = await this._call(`/domains/${domain}/records`);
            // Normalize to match Porkbun format
            return data.map((r, i) => ({
                id: `${r.type}-${r.name}-${i}`,  // Synthetic ID (GoDaddy has none)
                name: r.name === '@' ? domain : `${r.name}.${domain}`,
                type: r.type,
                content: r.data,
                ttl: String(r.ttl),
                prio: r.priority ? String(r.priority) : '0',
                notes: '',
                _gdName: r.name,  // Keep original GoDaddy name for API calls
                _gdData: r.data
            }));
        },
        
        async createDNSRecord(domain, type, name, content, ttl = 600, prio = null) {
            // GoDaddy uses PATCH to add records (append)
            const record = {
                type,
                name: name || '@',
                data: content,
                ttl: parseInt(ttl) || 600
            };
            if (prio !== null) record.priority = parseInt(prio);
            
            await this._call(`/domains/${domain}/records`, 'PATCH', [record]);
            return { id: `${type}-${name || '@'}-new`, type, name: name || '@', content };
        },
        
        async deleteDNSRecord(domain, recordId, allRecords) {
            // GoDaddy has no individual delete â€” we must replace all records of that type/name
            // OR replace ALL records minus the one we want to remove
            // We need the full record list to do this
            if (!allRecords) {
                allRecords = await this.listDNSRecords(domain);
            }
            
            const toKeep = allRecords.filter(r => r.id !== recordId);
            
            // Rebuild in GoDaddy's format
            const gdRecords = toKeep
                .filter(r => !['NS', 'SOA'].includes(r.type)) // Can't replace NS/SOA
                .map(r => ({
                    type: r.type,
                    name: r._gdName || (r.name === domain ? '@' : r.name.replace(`.${domain}`, '')),
                    data: r._gdData || r.content,
                    ttl: parseInt(r.ttl) || 600,
                    ...(r.prio && r.prio !== '0' ? { priority: parseInt(r.prio) } : {})
                }));
            
            if (gdRecords.length === 0) {
                throw new Error('Cannot delete all records. At least one record must remain.');
            }
            
            await this._call(`/domains/${domain}/records`, 'PUT', gdRecords);
            return { status: 'SUCCESS' };
        },
        
        // â”€â”€â”€ GitHub Pages DNS Configuration â”€â”€â”€
        
        async configureForGitHubPages(domain, githubUsername) {
            const log = [];
            
            // Step 1: Get existing records
            log.push('Fetching existing DNS records...');
            const existing = await this.listDNSRecords(domain);
            
            // Step 2: Build new record set â€” keep non-conflicting, replace A/CNAME
            const keepRecords = existing
                .filter(r => !['NS', 'SOA'].includes(r.type))
                .filter(r => {
                    const isRoot = r._gdName === '@' || r.name === domain;
                    const isWww = r._gdName === 'www';
                    if (isRoot && (r.type === 'A' || r.type === 'AAAA' || r.type === 'CNAME' || r.type === 'ALIAS')) {
                        log.push(`Removing conflicting ${r.type} record: ${r.content}`);
                        return false;
                    }
                    if (isWww && r.type === 'CNAME') {
                        log.push(`Removing conflicting CNAME www record: ${r.content}`);
                        return false;
                    }
                    return true;
                })
                .map(r => ({
                    type: r.type,
                    name: r._gdName || '@',
                    data: r._gdData || r.content,
                    ttl: parseInt(r.ttl) || 600,
                    ...(r.prio && r.prio !== '0' ? { priority: parseInt(r.prio) } : {})
                }));
            
            // Step 3: Add GitHub Pages records
            const ghRecords = this.GITHUB_PAGES_IPS.map(ip => {
                log.push(`Adding A record â†’ ${ip}`);
                return { type: 'A', name: '@', data: ip, ttl: 600 };
            });
            
            log.push(`Adding CNAME www â†’ ${githubUsername}.github.io`);
            ghRecords.push({ type: 'CNAME', name: 'www', data: `${githubUsername}.github.io`, ttl: 600 });
            
            // Step 4: Replace all records at once (GoDaddy's approach)
            const allRecords = [...keepRecords, ...ghRecords];
            await this._call(`/domains/${domain}/records`, 'PUT', allRecords);
            
            return {
                success: true,
                recordsCreated: ghRecords.length,
                records: ghRecords.map(r => ({ type: r.type, name: r.name, content: r.data })),
                log
            };
        },
        
        // â”€â”€â”€ Utility â”€â”€â”€
        formatPrice(price) {
            const num = typeof price === 'string' ? parseFloat(price) : price;
            return isNaN(num) ? 'â€”' : `$${num.toFixed(2)}`;
        }
    };

    const DomainProviderRegistry = {
        PROVIDERS: {
            porkbun: {
                id: 'porkbun',
                name: 'Porkbun',
                icon: 'ðŸ·',
                service: PorkbunService,
                configKey: PorkbunService.CONFIG_KEY,
                keyFields: [
                    { key: 'apiKey', label: 'API Key', placeholder: 'pk1_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' },
                    { key: 'secretApiKey', label: 'Secret API Key', placeholder: 'sk1_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' }
                ],
                setupUrl: 'https://porkbun.com/account/api',
                setupNote: 'Generate API keys, then enable API access per domain in Domain Management â†’ Details.',
                hasRegistration: true
            },
            godaddy: {
                id: 'godaddy',
                name: 'GoDaddy',
                icon: 'ðŸŸ¢',
                service: GoDaddyService,
                configKey: GoDaddyService.CONFIG_KEY,
                keyFields: [
                    { key: 'apiKey', label: 'API Key', placeholder: 'Your GoDaddy API Key' },
                    { key: 'apiSecret', label: 'API Secret', placeholder: 'Your GoDaddy API Secret' }
                ],
                setupUrl: 'https://developer.godaddy.com/keys',
                setupNote: 'Requires 10+ domains or Domain Pro Plan. Create a Production API key (not OTE/Test).',
                hasRegistration: false
            }
        },
        
        getAll() {
            return Object.values(this.PROVIDERS);
        },
        
        get(providerId) {
            return this.PROVIDERS[providerId] || null;
        },
        
        getService(providerId) {
            const provider = this.get(providerId);
            return provider ? provider.service : null;
        },
        
        // Get all configured providers
        getConfigured() {
            return this.getAll().filter(p => p.service.isConfigured());
        },
        
        // Get all domains across all configured providers
        async getAllDomains() {
            const results = [];
            for (const provider of this.getConfigured()) {
                try {
                    const domains = await provider.service.listDomains();
                    domains.forEach(d => {
                        d.provider = provider.id;
                        d.providerName = provider.name;
                        d.providerIcon = provider.icon;
                    });
                    results.push(...domains);
                } catch (e) {
                    console.warn(`Failed to fetch domains from ${provider.name}:`, e);
                }
            }
            return results;
        },
        
        // Get the service for a specific domain (by checking which provider owns it)
        getServiceForDomain(domain, allDomains) {
            const match = allDomains.find(d => d.domain === domain);
            if (match) return this.getService(match.provider);
            // Default to first configured
            const configured = this.getConfigured();
            return configured.length > 0 ? configured[0].service : null;
        }
    };

    // =========================================================================
    // GITHUB API
    // =========================================================================

    class GitHubAPI {
        constructor(token) {
            this.token = token;
            this.baseUrl = 'https://api.github.com';
        }
        
        // Helper: Clean base64 content from GitHub (remove newlines)
        cleanBase64(content) {
            return content ? content.replace(/[\r\n\s]/g, '') : '';
        }
        
        // Helper: Decode base64 content from GitHub to UTF-8 string
        decodeContent(content) {
            const clean = this.cleanBase64(content);
            return decodeURIComponent(escape(atob(clean)));
        }
        
        async request(endpoint, options = {}) {
            const url = `${this.baseUrl}${endpoint}`;
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                // Track rate limit from response headers
                const remaining = response.headers.get('X-RateLimit-Remaining');
                const limit = response.headers.get('X-RateLimit-Limit');
                const resetTime = response.headers.get('X-RateLimit-Reset');
                
                if (remaining !== null) {
                    this.rateLimit = { remaining: parseInt(remaining), limit: parseInt(limit), resetTime: parseInt(resetTime) * 1000 };
                    if (parseInt(remaining) < 100) {
                        console.warn(`âš ï¸ GitHub API rate limit low: ${remaining}/${limit} remaining. Resets at ${new Date(this.rateLimit.resetTime).toLocaleTimeString()}`);
                    }
                }
                
                // Handle rate limit exceeded
                if (response.status === 403 && remaining === '0') {
                    const resetDate = new Date(parseInt(resetTime) * 1000);
                    throw new Error(`GitHub API rate limit exceeded. Resets at ${resetDate.toLocaleTimeString()}. Please wait and try again.`);
                }
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    console.error('GitHub API Error:', {
                        url,
                        status: response.status,
                        error,
                        body: options.body ? JSON.parse(options.body) : null
                    });
                    throw new Error(error.message || `GitHub API error: ${response.status}`);
                }
                return response.json();
            } catch (e) {
                console.error('Request failed:', url, e);
                throw e;
            }
        }
        
        // Get current rate limit status
        getRateLimit() {
            return this.rateLimit || { remaining: null, limit: null, resetTime: null };
        }
        
        async listRepos() {
            const repos = await this.request('/user/repos?per_page=100&sort=updated');
            return repos.map(r => ({ fullName: r.full_name, name: r.name, owner: r.owner.login }));
        }
        
        async getFile(repo, path) {
            try {
                const [owner, repoName] = repo.split('/');
                // Add timestamp to bust GitHub API cache
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?_=${Date.now()}`);
            } catch { return null; }
        }
        
        // Get file content - handles large files (>1MB) that GitHub API doesn't return content for
        async getFileContent(repo, path) {
            try {
                const file = await this.getFile(repo, path);
                if (!file) return null;
                
                // For large files (>1MB), GitHub API doesn't return content - use download_url
                if (!file.content && file.download_url) {
                    console.log(`Large file detected (${path}), using download_url`);
                    // Add cache-busting to download_url
                    const cacheBustUrl = file.download_url + (file.download_url.includes('?') ? '&' : '?') + '_=' + Date.now();
                    const response = await fetch(cacheBustUrl);
                    const content = await response.text();
                    return { ...file, content: null, textContent: content };
                }
                
                // Normal file - decode base64 content
                const textContent = this.decodeContent(file.content);
                return { ...file, textContent };
            } catch (e) {
                console.warn(`Failed to get file content for ${path}:`, e);
                return null;
            }
        }
        
        // Get file content at specific commit - handles large files
        async getFileContentAtCommit(repo, path, commitSha) {
            try {
                const file = await this.getFileAtCommit(repo, path, commitSha);
                if (!file) return null;
                
                // For large files, use raw URL with commit ref
                if (!file.content && file.download_url) {
                    console.log(`Large file detected at commit (${path}), using download_url`);
                    const response = await fetch(file.download_url);
                    const content = await response.text();
                    return { ...file, content: null, textContent: content };
                }
                
                // Normal file - decode base64 content
                const textContent = this.decodeContent(file.content);
                return { ...file, textContent };
            } catch (e) {
                console.warn(`Failed to get file content at commit for ${path}:`, e);
                return null;
            }
        }
        
        async getFileAtCommit(repo, path, commitSha) {
            try {
                const [owner, repoName] = repo.split('/');
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?ref=${commitSha}`);
            } catch { return null; }
        }
        
        // Get blob content directly via Git Blob API - bypasses CDN caching
        async getBlobContent(repo, sha) {
            try {
                const [owner, repoName] = repo.split('/');
                const blob = await this.request(`/repos/${owner}/${repoName}/git/blobs/${sha}?_=${Date.now()}`);
                if (blob && blob.content) {
                    return {
                        content: blob.content,
                        encoding: blob.encoding,
                        size: blob.size
                    };
                }
                return null;
            } catch (e) {
                console.warn(`Failed to get blob ${sha}:`, e);
                return null;
            }
        }
        
        async listRepoContents(repo, path = '') {
            try {
                const [owner, repoName] = repo.split('/');
                const endpoint = path 
                    ? `/repos/${owner}/${repoName}/contents/${path}`
                    : `/repos/${owner}/${repoName}/contents`;
                // Add timestamp to bust any caching
                const cacheBuster = `?_=${Date.now()}`;
                const contents = await this.request(endpoint + cacheBuster);
                return Array.isArray(contents) ? contents : [contents];
            } catch { return []; }
        }
        
        // Get all files in a repo recursively
        async getRepoFiles(repo, path = '') {
            const allFiles = [];
            try {
                const contents = await this.listRepoContents(repo, path);
                for (const item of contents) {
                    if (item.type === 'file') {
                        allFiles.push({
                            type: 'file',
                            path: item.path,
                            sha: item.sha,
                            size: item.size
                        });
                    } else if (item.type === 'dir') {
                        // Recursively get files from subdirectories
                        const subFiles = await this.getRepoFiles(repo, item.path);
                        allFiles.push(...subFiles);
                    }
                }
            } catch (e) {
                console.log(`Error getting files at ${path}:`, e);
            }
            return allFiles;
        }
        
        async createOrUpdateFile(repo, path, content, message, sha = null, branch = 'main') {
            const [owner, repoName] = repo.split('/');
            const body = {
                message,
                content: btoa(unescape(encodeURIComponent(content))),
                committer: { name: 'Command Center', email: 'deploy@gameshelf.app' },
                branch
            };
            if (sha) body.sha = sha;
            
            const url = `/repos/${owner}/${repoName}/contents/${path}`;
            console.log('createOrUpdateFile request:', { 
                url,
                repo, 
                path, 
                sha, 
                branch,
                messageLength: message.length, 
                contentLength: content.length,
                base64Length: body.content.length
            });
            
            try {
                return await this.request(url, { method: 'PUT', body: JSON.stringify(body) });
            } catch (error) {
                console.error('createOrUpdateFile failed:', {
                    url,
                    error: error.message,
                    sha,
                    bodyPreview: JSON.stringify(body).substring(0, 200)
                });
                throw error;
            }
        }
        
        async deleteFile(repo, path, message, sha) {
            const [owner, repoName] = repo.split('/');
            return this.request(`/repos/${owner}/${repoName}/contents/${path}`, {
                method: 'DELETE',
                body: JSON.stringify({
                    message,
                    sha,
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
        }
        
        async createTag(repo, tagName, sha, message) {
            const [owner, repoName] = repo.split('/');
            
            // Check if tag already exists
            try {
                await this.request(`/repos/${owner}/${repoName}/git/ref/tags/${tagName}`);
                console.log(`Tag ${tagName} already exists, skipping`);
                return { existing: true, tag: tagName };
            } catch {
                // Tag doesn't exist, create it
            }
            
            const tagObj = await this.request(`/repos/${owner}/${repoName}/git/tags`, {
                method: 'POST',
                body: JSON.stringify({
                    tag: tagName, message, object: sha, type: 'commit',
                    tagger: { name: 'Command Center', email: 'deploy@gameshelf.app', date: new Date().toISOString() }
                })
            });
            await this.request(`/repos/${owner}/${repoName}/git/refs`, {
                method: 'POST',
                body: JSON.stringify({ ref: `refs/tags/${tagName}`, sha: tagObj.sha })
            });
            return tagObj;
        }
        
        async enablePages(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                await this.request(`/repos/${owner}/${repoName}/pages`);
                return { alreadyEnabled: true };
            } catch {}
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages`, {
                method: 'POST',
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: { branch: 'main', path: '/' } })
            });
            if (!response.ok) throw new Error(`Failed to enable Pages`);
            return { enabled: true };
        }
        
        // v8.35.0: Custom domain configuration for GitHub Pages
        async updatePagesConfig(repo, cname, enforceHttps = false) {
            const [owner, repoName] = repo.split('/');
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cname: cname,
                    https_enforced: enforceHttps,
                    source: { branch: 'main', path: '/' }
                })
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.message || `Failed to update Pages config (${response.status})`);
            }
            return await response.json();
        }
        
        // v8.35.0: Check GitHub Pages health/DNS status
        async checkPagesHealth(repo) {
            const [owner, repoName] = repo.split('/');
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages/health`, {
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            // First call may return 202 (async check in progress)
            if (response.status === 202) return { pending: true };
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.message || `Pages health check failed (${response.status})`);
            }
            return await response.json();
        }
        
        // Create a new repository
        async createRepo(name, description = '', isPrivate = false) {
            const response = await fetch(`${this.baseUrl}/user/repos`, {
                method: 'POST',
                headers: { 
                    'Authorization': `token ${this.token}`, 
                    'Accept': 'application/vnd.github.v3+json', 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    name,
                    description,
                    private: isPrivate,
                    auto_init: true, // Creates with README so we have a main branch
                    has_issues: false,
                    has_projects: false,
                    has_wiki: false
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to create repository');
            }
            
            const repo = await response.json();
            return {
                fullName: repo.full_name,
                name: repo.name,
                owner: repo.owner.login,
                url: repo.html_url,
                pagesUrl: `https://${repo.owner.login}.github.io/${repo.name}/`
            };
        }
        
        // Check if a repo exists
        async repoExists(owner, repoName) {
            try {
                await this.request(`/repos/${owner}/${repoName}`);
                return true;
            } catch {
                return false;
            }
        }
        
        // Delete a repository (requires delete_repo scope on token)
        async deleteRepo(fullName) {
            const [owner, repoName] = fullName.split('/');
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}`, {
                method: 'DELETE',
                headers: { 
                    'Authorization': `token ${this.token}`, 
                    'Accept': 'application/vnd.github.v3+json' 
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Token lacks delete_repo permission. Generate a new token with delete_repo scope.');
                }
                throw new Error(`Failed to delete repository: ${response.status}`);
            }
            
            return { deleted: true, repo: fullName };
        }
        
        async getPagesDeploymentStatus(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                // Get latest pages build
                const build = await this.request(`/repos/${owner}/${repoName}/pages/builds/latest`);
                return {
                    status: build.status, // 'queued', 'building', 'built', 'errored'
                    createdAt: build.created_at,
                    updatedAt: build.updated_at,
                    commitSha: build.commit,
                    duration: build.duration,
                    error: build.error?.message
                };
            } catch (e) {
                console.error('Failed to get pages status:', e);
                return null;
            }
        }
        
        async triggerPagesBuild(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                await this.request(`/repos/${owner}/${repoName}/pages/builds`, {
                    method: 'POST'
                });
                return true;
            } catch (e) {
                console.error('Failed to trigger pages build:', e);
                return false;
            }
        }
        
        async waitForPagesDeployment(repo, commitSha, maxWaitMs = 120000, onStatus = null) {
            const startTime = Date.now();
            let lastStatus = null;
            
            while (Date.now() - startTime < maxWaitMs) {
                const status = await this.getPagesDeploymentStatus(repo);
                
                if (status && status.status !== lastStatus) {
                    lastStatus = status.status;
                    if (onStatus) onStatus(status);
                }
                
                if (status?.status === 'built') {
                    // Verify it's the right commit
                    if (!commitSha || status.commitSha === commitSha) {
                        return { success: true, status };
                    }
                }
                
                if (status?.status === 'errored') {
                    return { success: false, error: status.error, status };
                }
                
                // Wait 3 seconds before checking again
                await new Promise(r => setTimeout(r, 3000));
            }
            
            return { success: false, error: 'Timeout waiting for deployment', status: lastStatus };
        }
        
        // Get recent workflow runs for a repo
        async getWorkflowRuns(repo, options = {}) {
            const [owner, repoName] = repo.split('/');
            const params = new URLSearchParams();
            if (options.per_page) params.append('per_page', options.per_page);
            if (options.branch) params.append('branch', options.branch);
            if (options.event) params.append('event', options.event);
            if (options.status) params.append('status', options.status);
            
            const queryString = params.toString();
            const endpoint = `/repos/${owner}/${repoName}/actions/runs${queryString ? '?' + queryString : ''}`;
            
            try {
                const result = await this.request(endpoint);
                return result.workflow_runs || [];
            } catch (e) {
                console.error('Failed to get workflow runs:', e);
                return [];
            }
        }
        
        // Get a specific workflow run
        async getWorkflowRun(repo, runId) {
            const [owner, repoName] = repo.split('/');
            try {
                return await this.request(`/repos/${owner}/${repoName}/actions/runs/${runId}`);
            } catch (e) {
                console.error('Failed to get workflow run:', e);
                return null;
            }
        }
        
        // Get workflow run logs URL (returns URL, not content - logs require redirect)
        async getWorkflowRunLogsUrl(repo, runId) {
            const [owner, repoName] = repo.split('/');
            return `https://github.com/${owner}/${repoName}/actions/runs/${runId}`;
        }
        
        // Monitor a workflow run until completion
        async waitForWorkflowRun(repo, runId, maxWaitMs = 300000, onStatus = null) {
            const startTime = Date.now();
            let lastStatus = null;
            
            while (Date.now() - startTime < maxWaitMs) {
                const run = await this.getWorkflowRun(repo, runId);
                
                if (run && run.status !== lastStatus) {
                    lastStatus = run.status;
                    if (onStatus) onStatus(run);
                }
                
                // Terminal states
                if (run?.status === 'completed') {
                    return { 
                        success: run.conclusion === 'success',
                        conclusion: run.conclusion, // success, failure, cancelled, skipped
                        run,
                        logsUrl: await this.getWorkflowRunLogsUrl(repo, runId)
                    };
                }
                
                // Wait 5 seconds before checking again
                await new Promise(r => setTimeout(r, 5000));
            }
            
            return { 
                success: false, 
                error: 'Timeout waiting for workflow', 
                logsUrl: await this.getWorkflowRunLogsUrl(repo, runId)
            };
        }
        
        // Find a workflow run triggered after a specific time
        async findRecentWorkflowRun(repo, afterTime, maxWaitMs = 30000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitMs) {
                const runs = await this.getWorkflowRuns(repo, { per_page: 5 });
                
                // Find a run that started after our commit
                const recentRun = runs.find(run => {
                    const runTime = new Date(run.created_at).getTime();
                    return runTime >= afterTime - 5000; // 5 second tolerance
                });
                
                if (recentRun) {
                    return recentRun;
                }
                
                // Wait 3 seconds before checking again
                await new Promise(r => setTimeout(r, 3000));
            }
            
            return null;
        }
        
        // Batch commit multiple files in one commit
        async batchCommit(repo, files, message) {
            const [owner, repoName] = repo.split('/');
            
            console.log('=== BATCH COMMIT START ===');
            console.log('Repo:', repo);
            console.log('Message:', message);
            console.log('Files to commit:', files.map(f => ({ path: f.path, contentLength: f.content?.length, encoding: f.encoding })));
            
            // Get current commit SHA
            const ref = await this.request(`/repos/${owner}/${repoName}/git/ref/heads/main`);
            const commitSha = ref.object.sha;
            console.log('Current commit SHA:', commitSha);
            
            // Get current tree
            const commit = await this.request(`/repos/${owner}/${repoName}/git/commits/${commitSha}`);
            const treeSha = commit.tree.sha;
            console.log('Current tree SHA:', treeSha);
            
            // Create blobs for each file
            const treeItems = await Promise.all(files.map(async (file) => {
                console.log('Creating blob for:', file.path);
                const blob = await this.request(`/repos/${owner}/${repoName}/git/blobs`, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: file.content,
                        encoding: file.encoding || 'utf-8'
                    })
                });
                console.log('Blob created:', file.path, '-> SHA:', blob.sha);
                return {
                    path: file.path,
                    mode: '100644',
                    type: 'blob',
                    sha: blob.sha
                };
            }));
            
            console.log('Tree items:', treeItems);
            
            // Create new tree
            const treePayload = {
                base_tree: treeSha,
                tree: treeItems
            };
            console.log('Creating tree with payload:', JSON.stringify(treePayload, null, 2));
            
            const newTree = await this.request(`/repos/${owner}/${repoName}/git/trees`, {
                method: 'POST',
                body: JSON.stringify(treePayload)
            });
            console.log('New tree SHA:', newTree.sha);
            
            // Create commit
            const newCommit = await this.request(`/repos/${owner}/${repoName}/git/commits`, {
                method: 'POST',
                body: JSON.stringify({
                    message,
                    tree: newTree.sha,
                    parents: [commitSha],
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
            console.log('New commit SHA:', newCommit.sha);
            
            // Update ref (force: true handles non-fast-forward cases)
            const updatedRef = await this.request(`/repos/${owner}/${repoName}/git/refs/heads/main`, {
                method: 'PATCH',
                body: JSON.stringify({ sha: newCommit.sha, force: true })
            });
            console.log('Ref updated:', updatedRef);
            console.log('=== BATCH COMMIT COMPLETE ===');
            
            return newCommit;
        }
    }

    // =========================================================================
    // SERVICE STUBS (lightweight replacements for CC Core services)
    // =========================================================================
    
    // DeployService stub â€” CleanupView reads deploy history to find recently deployed apps
    const DeployService = {
        load() {
            try { return JSON.parse(localStorage.getItem('cc_history_v2') || '[]'); } catch { return []; }
        }
    };

    // =========================================================================
    // VIEW: Firebase (Data Browser, Rules, Functions, Logs)
    // =========================================================================

    function FirebaseView({ showAlert, showConfirm, showPrompt }) {
        const [activeTab, setActiveTab] = React.useState('data');
        
        const tabs = [
            { id: 'data', label: 'ðŸ—„ï¸ Data Browser' },
            { id: 'rules', label: 'ðŸ”’ Rules' },
            { id: 'functions', label: 'âš¡ Functions' },
            { id: 'logs', label: 'ðŸ“‹ Logs' },
        ];
        
        return (
            <div className="space-y-6">
                {/* Tab Navigation */}
                <div className="flex gap-1 bg-slate-800 rounded-xl p-1 border border-slate-700">
                    {tabs.map(tab => (
                        <button 
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${
                                activeTab === tab.id 
                                    ? 'bg-indigo-600 text-white shadow-lg' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-700'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {activeTab === 'data' && (
                    <FirebaseDataBrowser showAlert={showAlert} showConfirm={showConfirm} showPrompt={showPrompt} />
                )}
                
                {activeTab === 'rules' && (
                    <FirebaseRulesManager showAlert={showAlert} showConfirm={showConfirm} />
                )}
                
                {activeTab === 'functions' && (
                    <FirebaseFunctionsDashboard showAlert={showAlert} />
                )}
                
                {activeTab === 'logs' && (
                    <FirebaseLogViewer showAlert={showAlert} />
                )}
            </div>
        );
    }
    
    // =========================================================================
    // FIREBASE DATA BROWSER (was the original FirebaseView content)
    // =========================================================================
    
    function FirebaseDataBrowser({ showAlert, showConfirm, showPrompt }) {
        const [user, setUser] = React.useState(null);
        const [authLoading, setAuthLoading] = React.useState(true);
        const [dbPath, setDbPath] = React.useState('');
        const [dbData, setDbData] = React.useState(null);
        const [dbLoading, setDbLoading] = React.useState(false);
        const [dbError, setDbError] = React.useState(null);
        const [expandedPaths, setExpandedPaths] = React.useState(new Set());
        const [editingPath, setEditingPath] = React.useState(null);
        const [editValue, setEditValue] = React.useState('');
        const [realtimeEnabled, setRealtimeEnabled] = React.useState(false);
        const [realtimeUnsubscribe, setRealtimeUnsubscribe] = React.useState(null);
        const [manualUid, setManualUid] = React.useState(() => {
            try { return localStorage.getItem('cc_firebase_uid') || ''; } catch { return ''; }
        });
        const [showManualAuth, setShowManualAuth] = React.useState(false);
        
        // Detect if running from file:// protocol
        const isFileProtocol = window.location.protocol === 'file:';
        
        // Quick paths for common data
        const quickPaths = [
            { label: 'Users', path: 'users' },
            { label: 'Battles', path: 'battles' },
            { label: 'Friends', path: 'friends' },
            { label: 'Gameshelf Public', path: 'gameshelf-public' },
            { label: 'Reported Issues', path: 'reported-issues' },
            { label: 'Game Suggestions', path: 'game-suggestions' },
            { label: 'Test Results', path: 'test-results' },
            { label: 'Root', path: '' },
        ];
        
        // Listen for auth state changes
        React.useEffect(() => {
            if (!firebaseAuth) {
                setAuthLoading(false);
                return;
            }
            
            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                setUser(u);
                setAuthLoading(false);
                if (u) {
                    console.log('Firebase auth state:', u.email, 'UID:', u.uid);
                    // Save UID for manual auth fallback
                    try { localStorage.setItem('cc_firebase_uid', u.uid); localStorage.setItem('gs_firebase_uid', u.uid); } catch {}
                    setManualUid(u.uid);
                } else {
                    console.log('Firebase auth state: signed out');
                }
            });
            
            return () => unsubscribe();
        }, []);
        
        // Cleanup realtime listener on unmount
        React.useEffect(() => {
            return () => {
                if (realtimeUnsubscribe) {
                    realtimeUnsubscribe();
                }
            };
        }, [realtimeUnsubscribe]);
        
        const signInWithGoogle = async () => {
            if (isFileProtocol) {
                showAlert('Google Sign-in requires HTTPS. Please open this app from GitHub Pages or a web server.\n\nOr use the "Manual UID" option below for read-only access to public data.', 'HTTPS Required');
                return;
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebaseAuth.signInWithPopup(provider);
            } catch (e) {
                console.error('Sign in error:', e);
                if (e.code === 'auth/operation-not-supported-in-this-environment') {
                    showAlert('Google Sign-in not supported here. Please:\n\n1. Open from GitHub Pages URL, or\n2. Use "Manual UID" for limited access', 'Sign-in Not Supported');
                } else {
                    showAlert('Sign in failed: ' + e.message, 'Sign-in Error');
                }
            }
        };
        
        const signOut = async () => {
            try {
                await firebaseAuth.signOut();
                setDbData(null);
            } catch (e) {
                console.error('Sign out error:', e);
            }
        };
        
        const fetchData = async (path = dbPath) => {
            if (!firebaseDb) return;
            
            // Stop any existing realtime listener
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                setRealtimeUnsubscribe(null);
            }
            
            setDbLoading(true);
            setDbError(null);
            
            try {
                const ref = firebaseDb.ref(path || '/');
                const snapshot = await ref.once('value');
                setDbData(snapshot.val());
                setDbPath(path);
                console.log('Fetched data at', path || '/', snapshot.val());
            } catch (e) {
                console.error('Fetch error:', e);
                setDbError(e.message);
            }
            
            setDbLoading(false);
        };
        
        const enableRealtime = () => {
            if (!firebaseDb || !dbPath) return;
            
            // Stop existing listener
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
            
            const ref = firebaseDb.ref(dbPath || '/');
            const callback = ref.on('value', (snapshot) => {
                setDbData(snapshot.val());
                console.log('Realtime update at', dbPath || '/');
            }, (error) => {
                setDbError(error.message);
            });
            
            setRealtimeUnsubscribe(() => () => ref.off('value', callback));
            setRealtimeEnabled(true);
        };
        
        const disableRealtime = () => {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                setRealtimeUnsubscribe(null);
            }
            setRealtimeEnabled(false);
        };
        
        const updateValue = async (path, value) => {
            if (!firebaseDb) return;
            
            try {
                // Try to parse as JSON, otherwise use as string
                let parsedValue;
                try {
                    parsedValue = JSON.parse(value);
                } catch {
                    parsedValue = value;
                }
                
                await firebaseDb.ref(path).set(parsedValue);
                setEditingPath(null);
                fetchData(dbPath);
            } catch (e) {
                showAlert('Update failed: ' + e.message, 'Update Error');
            }
        };
        
        const deleteValue = async (path) => {
            if (!firebaseDb) return;
            const confirmed = await showConfirm(`Delete data at "${path}"?`, 'Confirm Delete');
            if (!confirmed) return;
            
            try {
                await firebaseDb.ref(path).remove();
                fetchData(dbPath);
            } catch (e) {
                showAlert('Delete failed: ' + e.message, 'Delete Error');
            }
        };
        
        const copyToClipboard = (data) => {
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        };
        
        const toggleExpand = (path) => {
            setExpandedPaths(prev => {
                const newSet = new Set(prev);
                if (newSet.has(path)) {
                    newSet.delete(path);
                } else {
                    newSet.add(path);
                }
                return newSet;
            });
        };
        
        // Render a data node recursively
        const renderData = (data, path = '') => {
            if (data === null || data === undefined) {
                return <span className="text-slate-500 italic">null</span>;
            }
            
            if (typeof data !== 'object') {
                // Primitive value
                const isEditing = editingPath === path;
                
                return (
                    <div className="flex items-center gap-2">
                        {isEditing ? (
                            <>
                                <input 
                                    type="text" 
                                    value={editValue}
                                    onChange={e => setEditValue(e.target.value)}
                                    className="flex-1 bg-slate-900 border border-indigo-500 rounded px-2 py-1 text-sm font-mono"
                                    autoFocus
                                />
                                <button onClick={() => updateValue(path, editValue)} className="px-2 py-1 bg-green-600 rounded text-xs">Save</button>
                                <button onClick={() => setEditingPath(null)} className="px-2 py-1 bg-slate-600 rounded text-xs">Cancel</button>
                            </>
                        ) : (
                            <>
                                <span className={`font-mono ${
                                    typeof data === 'string' ? 'text-green-400' :
                                    typeof data === 'number' ? 'text-blue-400' :
                                    typeof data === 'boolean' ? 'text-amber-400' : 'text-white'
                                }`}>
                                    {typeof data === 'string' ? `"${data}"` : String(data)}
                                </span>
                                <button onClick={() => { setEditingPath(path); setEditValue(typeof data === 'string' ? data : JSON.stringify(data)); }} 
                                    className="p-1 hover:bg-slate-600 rounded opacity-50 hover:opacity-100">
                                    <Icons.Edit />
                                </button>
                            </>
                        )}
                    </div>
                );
            }
            
            // Object or array
            const entries = Object.entries(data);
            const isArray = Array.isArray(data);
            const isExpanded = expandedPaths.has(path) || path === '';
            
            return (
                <div className="ml-4 border-l border-slate-700 pl-3">
                    {entries.length === 0 ? (
                        <span className="text-slate-500 italic">{isArray ? '[]' : '{}'}</span>
                    ) : (
                        entries.slice(0, isExpanded ? undefined : 5).map(([key, value]) => {
                            const childPath = path ? `${path}/${key}` : key;
                            const isObject = value && typeof value === 'object';
                            const childCount = isObject ? Object.keys(value).length : 0;
                            
                            return (
                                <div key={key} className="my-1">
                                    <div className="flex items-center gap-2">
                                        {isObject && (
                                            <button onClick={() => toggleExpand(childPath)} className="text-slate-400 hover:text-white">
                                                {expandedPaths.has(childPath) ? 'â–¼' : 'â–¶'}
                                            </button>
                                        )}
                                        <span className={`${isArray ? 'text-slate-500' : 'text-indigo-400'} font-mono text-sm`}>
                                            {isArray ? `[${key}]` : key}:
                                        </span>
                                        {isObject ? (
                                            <span className="text-slate-500 text-xs">
                                                {Array.isArray(value) ? `Array(${childCount})` : `Object(${childCount})`}
                                            </span>
                                        ) : null}
                                        <button onClick={() => copyToClipboard(value)} className="p-1 hover:bg-slate-600 rounded opacity-50 hover:opacity-100" title="Copy">
                                            <Icons.Copy />
                                        </button>
                                        <button onClick={() => deleteValue(childPath)} className="p-1 hover:bg-red-900/50 rounded opacity-50 hover:opacity-100 text-red-400" title="Delete">
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                    {(!isObject || expandedPaths.has(childPath)) && (
                                        <div className="ml-4">
                                            {renderData(value, childPath)}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                    {!isExpanded && entries.length > 5 && (
                        <button onClick={() => toggleExpand(path)} className="text-indigo-400 text-sm hover:underline">
                            ... {entries.length - 5} more items
                        </button>
                    )}
                </div>
            );
        };
        
        return (
            <div className="space-y-6">
                {/* Protocol Warning */}
                {isFileProtocol && (
                    <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-4">
                        <div className="flex items-start gap-3">
                            <span className="text-2xl">âš ï¸</span>
                            <div>
                                <div className="font-semibold text-amber-400">Running from local file</div>
                                <p className="text-sm text-slate-300 mt-1">
                                    Google Sign-in requires HTTPS. For full functionality:
                                </p>
                                <ol className="text-sm text-slate-400 mt-2 list-decimal list-inside space-y-1">
                                    <li>Deploy this file to your <strong>command-center-test</strong> repo</li>
                                    <li>Open from GitHub Pages URL</li>
                                    <li>Sign in with Google there</li>
                                </ol>
                                <p className="text-sm text-slate-400 mt-2">
                                    Or use <strong>Manual UID</strong> below for read-only access to public data.
                                </p>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Auth Section */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.Database /> Firebase Realtime Database
                    </h2>
                    
                    <div className="flex items-center gap-4 mb-4">
                        <div className="flex-1">
                            <div className="text-xs text-slate-400 mb-1">Project</div>
                            <div className="font-mono text-sm">{FIREBASE_CONFIG.projectId}</div>
                        </div>
                        
                        {authLoading ? (
                            <div className="text-slate-400">Loading auth...</div>
                        ) : user ? (
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="text-sm font-medium">{user.displayName || user.email}</div>
                                    <div className="text-xs text-slate-400">{user.email}</div>
                                    <div className="text-xs text-slate-500 font-mono">UID: {user.uid}</div>
                                </div>
                                {user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full" />}
                                <button onClick={signOut} className="px-3 py-1.5 bg-slate-700 rounded text-sm">Sign Out</button>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2">
                                <button onClick={signInWithGoogle} 
                                    className={`px-4 py-2 rounded flex items-center gap-2 ${isFileProtocol ? 'bg-slate-600 text-slate-400' : 'bg-indigo-600'}`}>
                                    <Icons.User /> Sign in with Google
                                </button>
                                <button onClick={() => setShowManualAuth(!showManualAuth)} 
                                    className="px-3 py-2 bg-slate-700 rounded text-sm">
                                    {showManualAuth ? 'Hide' : 'Manual UID'}
                                </button>
                            </div>
                        )}
                    </div>
                    
                    {/* Manual UID Input (for file:// or debugging) */}
                    {!user && showManualAuth && (
                        <div className="mt-4 p-4 bg-slate-900 rounded-lg border border-slate-600">
                            <div className="text-sm text-slate-400 mb-2">
                                <strong>Manual UID Access</strong> - Enter a UID to access public data (read-only without auth)
                            </div>
                            <div className="flex gap-2">
                                <input 
                                    type="text"
                                    value={manualUid}
                                    onChange={e => setManualUid(e.target.value)}
                                    placeholder="Firebase UID (e.g., abc123xyz...)"
                                    className="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 font-mono text-sm"
                                />
                                <button onClick={() => {
                                    try { localStorage.setItem('cc_firebase_uid', manualUid); localStorage.setItem('gs_firebase_uid', manualUid); } catch {}
                                    showAlert('UID saved. You can now query public data paths.', 'UID Saved');
                                }} className="px-4 py-2 bg-indigo-600 rounded">
                                    Save
                                </button>
                            </div>
                            <div className="text-xs text-slate-500 mt-2">
                                Tip: Sign in from GitHub Pages once to get your UID, then use it here.
                            </div>
                        </div>
                    )}
                    
                    {!user && !showManualAuth && (
                        <div className="text-slate-400 text-sm">
                            Sign in to access protected data, or click "Manual UID" for limited access.
                        </div>
                    )}
                </div>
                
                {/* Query Section */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 className="font-semibold mb-4">Query Data</h3>
                    
                    <div className="flex gap-2 mb-4 flex-wrap">
                        {quickPaths.map(qp => (
                            <button key={qp.path} onClick={() => { setDbPath(qp.path); fetchData(qp.path); }}
                                className={`px-3 py-1.5 rounded text-sm ${dbPath === qp.path ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                {qp.label}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            value={dbPath}
                            onChange={e => setDbPath(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && fetchData()}
                            placeholder="Path (e.g., users/abc123)"
                            className="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 font-mono text-sm"
                        />
                        <button onClick={() => fetchData()} disabled={dbLoading} className="px-4 py-2 bg-indigo-600 rounded">
                            {dbLoading ? '...' : 'Fetch'}
                        </button>
                        <button 
                            onClick={() => realtimeEnabled ? disableRealtime() : enableRealtime()} 
                            className={`px-4 py-2 rounded flex items-center gap-2 ${realtimeEnabled ? 'bg-green-600' : 'bg-slate-700'}`}
                            title={realtimeEnabled ? 'Disable realtime updates' : 'Enable realtime updates'}
                        >
                            {realtimeEnabled ? 'ðŸ”´ Live' : 'âšª Live'}
                        </button>
                    </div>
                    
                    {dbError && (
                        <div className="mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                            Error: {dbError}
                        </div>
                    )}
                </div>
                
                {/* Data Display */}
                {dbData !== null && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold">
                                Data at <span className="font-mono text-indigo-400">/{dbPath || ''}</span>
                                {realtimeEnabled && <span className="ml-2 text-green-400 text-sm">â— Live</span>}
                            </h3>
                            <div className="flex gap-2">
                                <button onClick={() => copyToClipboard(dbData)} className="px-3 py-1 bg-slate-700 rounded text-sm flex items-center gap-1">
                                    <Icons.Copy /> Copy All
                                </button>
                                <button onClick={() => setExpandedPaths(new Set())} className="px-3 py-1 bg-slate-700 rounded text-sm">
                                    Collapse All
                                </button>
                            </div>
                        </div>
                        
                        <div className="bg-slate-900 rounded p-4 max-h-[600px] overflow-auto">
                            {renderData(dbData, dbPath)}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // FIREBASE RULES MANAGER (v8.10.0 â€” Phase 2)
    // =========================================================================
    
    function FirebaseRulesManager({ showAlert, showConfirm }) {
        const [rules, setRules] = React.useState(null);
        const [editedRules, setEditedRules] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [deploying, setDeploying] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [isEditing, setIsEditing] = React.useState(false);
        const [parseError, setParseError] = React.useState(null);
        const [history, setHistory] = React.useState(() => {
            try {
                return JSON.parse(localStorage.getItem('cc_rulesHistory') || '[]');
            } catch { return []; }
        });
        const [showHistory, setShowHistory] = React.useState(false);
        const [selectedSnapshot, setSelectedSnapshot] = React.useState(null);
        const [diffView, setDiffView] = React.useState(false);
        const [hasChanges, setHasChanges] = React.useState(false);
        
        const configured = firebaseAdmin.isConfigured();
        
        // Fetch current rules
        const fetchRules = async () => {
            if (!configured) return;
            setLoading(true);
            setError(null);
            try {
                const result = await firebaseAdmin.getRules();
                setRules(result);
                const formatted = JSON.stringify(result, null, 2);
                setEditedRules(formatted);
                setIsEditing(false);
                setHasChanges(false);
                setParseError(null);
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        // Validate JSON on edit
        const handleEditChange = (value) => {
            setEditedRules(value);
            setParseError(null);
            try {
                const parsed = JSON.parse(value);
                if (!parsed.rules) {
                    setParseError('Rules JSON must have a top-level "rules" key');
                }
            } catch (e) {
                setParseError(e.message);
            }
            // Check if different from fetched rules
            try {
                const currentStr = JSON.stringify(rules, null, 2);
                setHasChanges(value.trim() !== currentStr.trim());
            } catch {
                setHasChanges(true);
            }
        };
        
        // Save snapshot to history
        const saveSnapshot = (rulesObj, label = 'Before deploy') => {
            const snapshot = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                label,
                rules: rulesObj,
                size: JSON.stringify(rulesObj).length
            };
            const updated = [snapshot, ...history].slice(0, 20); // Keep last 20
            setHistory(updated);
            try {
                localStorage.setItem('cc_rulesHistory', JSON.stringify(updated));
                // Firebase dual-write
                if (FirebaseConfigSync.initialized) {
                    FirebaseConfigSync.pushRulesHistory(updated).catch(() => {});
                }
            } catch (e) {
                console.warn('Failed to save rules history:', e);
            }
            return snapshot;
        };
        
        // Deploy rules
        const handleDeploy = async () => {
            if (parseError) {
                showAlert('Cannot deploy â€” there are JSON errors:\n\n' + parseError, 'Validation Error');
                return;
            }
            
            let parsed;
            try {
                parsed = JSON.parse(editedRules);
            } catch (e) {
                showAlert('Invalid JSON: ' + e.message, 'Validation Error');
                return;
            }
            
            if (!parsed.rules) {
                showAlert('Rules JSON must have a top-level "rules" key.\n\nExample:\n{\n  "rules": {\n    ".read": false,\n    ".write": false\n  }\n}', 'Invalid Rules Structure');
                return;
            }
            
            // Count paths for context
            const countPaths = (obj, depth = 0) => {
                if (!obj || typeof obj !== 'object') return 0;
                return Object.keys(obj).reduce((sum, key) => sum + 1 + countPaths(obj[key], depth + 1), 0);
            };
            const pathCount = countPaths(parsed.rules);
            
            const confirmed = await showConfirm(
                `Deploy security rules to ${FIREBASE_CONFIG.projectId}?\n\nThis will OVERWRITE all existing rules (${pathCount} paths/properties).\n\nA snapshot of the current rules will be saved to history before deploying.`,
                'Deploy Rules'
            );
            if (!confirmed) return;
            
            setDeploying(true);
            setError(null);
            
            try {
                // Snapshot current rules before overwriting
                if (rules) {
                    saveSnapshot(rules, 'Before deploy');
                }
                
                const result = await firebaseAdmin.putRules(parsed);
                setRules(result);
                const formatted = JSON.stringify(result, null, 2);
                setEditedRules(formatted);
                setIsEditing(false);
                setHasChanges(false);
                showAlert('Rules deployed successfully!', 'Deploy Complete');
            } catch (e) {
                setError('Deploy failed: ' + e.message);
            }
            
            setDeploying(false);
        };
        
        // Restore from snapshot
        const handleRestore = async (snapshot) => {
            const confirmed = await showConfirm(
                `Restore rules from ${new Date(snapshot.timestamp).toLocaleString()}?\n\nThis will replace the editor content. You still need to click "Deploy" to push to Firebase.`,
                'Restore Snapshot'
            );
            if (!confirmed) return;
            
            const formatted = JSON.stringify(snapshot.rules, null, 2);
            setEditedRules(formatted);
            setIsEditing(true);
            setHasChanges(true);
            setParseError(null);
            setShowHistory(false);
            setSelectedSnapshot(null);
        };
        
        // Delete a snapshot
        const handleDeleteSnapshot = (snapshotId) => {
            const updated = history.filter(h => h.id !== snapshotId);
            setHistory(updated);
            try {
                localStorage.setItem('cc_rulesHistory', JSON.stringify(updated));
                // Firebase dual-write
                if (FirebaseConfigSync.initialized) {
                    FirebaseConfigSync.pushRulesHistory(updated).catch(() => {});
                }
            } catch {}
            if (selectedSnapshot?.id === snapshotId) {
                setSelectedSnapshot(null);
            }
        };
        
        // Compute simple line-by-line diff
        const computeDiff = (oldText, newText) => {
            const oldLines = oldText.split('\n');
            const newLines = newText.split('\n');
            const maxLen = Math.max(oldLines.length, newLines.length);
            const result = [];
            for (let i = 0; i < maxLen; i++) {
                const oldLine = oldLines[i];
                const newLine = newLines[i];
                if (oldLine === newLine) {
                    result.push({ type: 'same', line: oldLine, num: i + 1 });
                } else {
                    if (oldLine !== undefined) result.push({ type: 'removed', line: oldLine, num: i + 1 });
                    if (newLine !== undefined) result.push({ type: 'added', line: newLine, num: i + 1 });
                }
            }
            return result;
        };
        
        // Not configured state
        if (!configured) {
            return (
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ðŸ”’ Security Rules Manager
                    </h2>
                    <div className="p-4 bg-amber-900/20 border border-amber-700 rounded-lg">
                        <p className="text-amber-400 font-medium">Service account required</p>
                        <p className="text-sm text-slate-400 mt-2">
                            To manage Firebase security rules, configure a service account key in 
                            <strong className="text-white"> Configure â†’ Settings â†’ Firebase Admin</strong>.
                        </p>
                    </div>
                </div>
            );
        }
        
        return (
            <div className="space-y-6">
                {/* Header & Actions */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold flex items-center gap-2">
                            ðŸ”’ Security Rules â€” <span className="font-mono text-indigo-400">{FIREBASE_CONFIG.projectId}</span>
                        </h2>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setShowHistory(!showHistory)}
                                className={`px-3 py-1.5 rounded text-sm flex items-center gap-1.5 ${
                                    showHistory ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'
                                }`}
                            >
                                ðŸ“œ History ({history.length})
                            </button>
                            <button 
                                onClick={fetchRules} 
                                disabled={loading}
                                className="px-4 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm flex items-center gap-1.5"
                            >
                                {loading ? 'â³' : 'ðŸ”„'} {loading ? 'Loading...' : 'Fetch Rules'}
                            </button>
                        </div>
                    </div>
                    
                    {/* Admin info */}
                    {(() => {
                        const info = firebaseAdmin.getInfo();
                        return info ? (
                            <div className="text-xs text-slate-500 flex items-center gap-4">
                                <span>SA: {info.email}</span>
                                <span>Token: {info.tokenValid ? 'ðŸŸ¢ Active' : info.tokenCached ? 'ðŸŸ¡ Expired' : 'âšª Not requested'}</span>
                            </div>
                        ) : null;
                    })()}
                    
                    {error && (
                        <div className="mt-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                            {error}
                        </div>
                    )}
                </div>
                
                {/* History Panel */}
                {showHistory && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h3 className="font-semibold mb-4 flex items-center gap-2">
                            ðŸ“œ Rules History
                            <span className="text-xs text-slate-500 font-normal">({history.length} snapshots, stored in localStorage)</span>
                        </h3>
                        
                        {history.length === 0 ? (
                            <p className="text-slate-500 text-sm">No snapshots yet. A snapshot is saved automatically before each deploy.</p>
                        ) : (
                            <div className="space-y-2">
                                {history.map((snap) => (
                                    <div key={snap.id} className={`flex items-center justify-between p-3 rounded-lg border transition-colors ${
                                        selectedSnapshot?.id === snap.id 
                                            ? 'bg-indigo-900/30 border-indigo-600' 
                                            : 'bg-slate-900 border-slate-700 hover:border-slate-600'
                                    }`}>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm font-medium">{snap.label}</span>
                                                <span className="text-xs text-slate-500">
                                                    {(snap.size / 1024).toFixed(1)} KB
                                                </span>
                                            </div>
                                            <div className="text-xs text-slate-500 mt-0.5">
                                                {new Date(snap.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 ml-4">
                                            <button 
                                                onClick={() => setSelectedSnapshot(selectedSnapshot?.id === snap.id ? null : snap)}
                                                className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs"
                                            >
                                                {selectedSnapshot?.id === snap.id ? 'Hide' : 'View'}
                                            </button>
                                            <button 
                                                onClick={() => handleRestore(snap)}
                                                className="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-xs"
                                            >
                                                Restore
                                            </button>
                                            <button 
                                                onClick={() => handleDeleteSnapshot(snap.id)}
                                                className="px-2 py-1 hover:bg-red-900/50 rounded text-xs text-red-400"
                                                title="Delete snapshot"
                                            >
                                                âœ•
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* Snapshot preview */}
                        {selectedSnapshot && (
                            <div className="mt-4">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className="text-sm font-medium text-slate-300">
                                        Snapshot: {new Date(selectedSnapshot.timestamp).toLocaleString()}
                                    </h4>
                                    {rules && (
                                        <button 
                                            onClick={() => setDiffView(!diffView)}
                                            className={`px-2 py-1 rounded text-xs ${diffView ? 'bg-amber-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                                        >
                                            {diffView ? 'Raw View' : 'Diff vs Current'}
                                        </button>
                                    )}
                                </div>
                                {diffView && rules ? (
                                    <div className="bg-slate-900 rounded p-4 max-h-[400px] overflow-auto font-mono text-xs">
                                        {computeDiff(
                                            JSON.stringify(selectedSnapshot.rules, null, 2),
                                            JSON.stringify(rules, null, 2)
                                        ).map((line, i) => (
                                            <div key={i} className={`${
                                                line.type === 'removed' ? 'bg-red-900/30 text-red-400' :
                                                line.type === 'added' ? 'bg-green-900/30 text-green-400' :
                                                'text-slate-500'
                                            }`}>
                                                <span className="inline-block w-8 text-right mr-3 text-slate-600 select-none">{line.num}</span>
                                                <span>{line.type === 'removed' ? '- ' : line.type === 'added' ? '+ ' : '  '}</span>
                                                {line.line}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <pre className="bg-slate-900 rounded p-4 max-h-[400px] overflow-auto font-mono text-xs text-slate-300 whitespace-pre-wrap">
                                        {JSON.stringify(selectedSnapshot.rules, null, 2)}
                                    </pre>
                                )}
                            </div>
                        )}
                    </div>
                )}
                
                {/* Rules Editor */}
                {rules !== null && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold flex items-center gap-2">
                                {isEditing ? 'âœï¸ Editing Rules' : 'ðŸ“„ Current Rules'}
                                {hasChanges && (
                                    <span className="px-2 py-0.5 bg-amber-600/30 text-amber-400 text-xs rounded-full">
                                        Unsaved changes
                                    </span>
                                )}
                            </h3>
                            <div className="flex items-center gap-2">
                                {!isEditing ? (
                                    <>
                                        <button 
                                            onClick={() => {
                                                navigator.clipboard.writeText(editedRules);
                                                showAlert('Rules copied to clipboard', 'Copied');
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            ðŸ“‹ Copy
                                        </button>
                                        <button 
                                            onClick={() => {
                                                saveSnapshot(rules, 'Manual snapshot');
                                                showAlert('Snapshot saved to history', 'Snapshot Saved');
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            ðŸ“¸ Snapshot
                                        </button>
                                        <button 
                                            onClick={() => setIsEditing(true)}
                                            className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm"
                                        >
                                            âœï¸ Edit
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button 
                                            onClick={() => {
                                                setEditedRules(JSON.stringify(rules, null, 2));
                                                setIsEditing(false);
                                                setHasChanges(false);
                                                setParseError(null);
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            onClick={() => {
                                                // Format / prettify
                                                try {
                                                    const parsed = JSON.parse(editedRules);
                                                    setEditedRules(JSON.stringify(parsed, null, 2));
                                                    setParseError(null);
                                                } catch (e) {
                                                    setParseError(e.message);
                                                }
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            ðŸ§¹ Format
                                        </button>
                                        <button 
                                            onClick={handleDeploy}
                                            disabled={deploying || !!parseError || !hasChanges}
                                            className={`px-4 py-1.5 rounded text-sm font-medium flex items-center gap-1.5 ${
                                                deploying || !!parseError || !hasChanges
                                                    ? 'bg-slate-600 text-slate-400 cursor-not-allowed'
                                                    : 'bg-green-600 hover:bg-green-500 text-white'
                                            }`}
                                        >
                                            {deploying ? 'â³ Deploying...' : 'ðŸš€ Deploy Rules'}
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        {/* Parse error banner */}
                        {parseError && (
                            <div className="mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-sm">
                                <span className="text-red-400 font-medium">JSON Error: </span>
                                <span className="text-red-300 font-mono">{parseError}</span>
                            </div>
                        )}
                        
                        {/* Editor area */}
                        {isEditing ? (
                            <textarea
                                value={editedRules}
                                onChange={e => handleEditChange(e.target.value)}
                                className={`w-full bg-slate-900 border rounded p-4 font-mono text-sm text-slate-300 leading-relaxed resize-y ${
                                    parseError ? 'border-red-600' : 'border-slate-600 focus:border-indigo-500'
                                } focus:outline-none`}
                                style={{ minHeight: '400px', maxHeight: '700px', tabSize: 2 }}
                                spellCheck={false}
                                onKeyDown={e => {
                                    // Tab support in textarea
                                    if (e.key === 'Tab') {
                                        e.preventDefault();
                                        const start = e.target.selectionStart;
                                        const end = e.target.selectionEnd;
                                        const val = e.target.value;
                                        const newVal = val.substring(0, start) + '  ' + val.substring(end);
                                        handleEditChange(newVal);
                                        // Set cursor position after React re-renders
                                        requestAnimationFrame(() => {
                                            e.target.selectionStart = e.target.selectionEnd = start + 2;
                                        });
                                    }
                                }}
                            />
                        ) : (
                            <div className="relative">
                                <pre className="bg-slate-900 border border-slate-700 rounded p-4 font-mono text-sm text-slate-300 leading-relaxed overflow-auto max-h-[600px] whitespace-pre-wrap">
                                    {editedRules}
                                </pre>
                                <div className="absolute top-3 right-3 text-xs text-slate-600">
                                    {(editedRules.length / 1024).toFixed(1)} KB Â· {editedRules.split('\n').length} lines
                                </div>
                            </div>
                        )}
                        
                        {/* Editor stats */}
                        {isEditing && (
                            <div className="mt-2 flex items-center justify-between text-xs text-slate-500">
                                <div className="flex items-center gap-3">
                                    <span>{editedRules.split('\n').length} lines</span>
                                    <span>{(editedRules.length / 1024).toFixed(1)} KB</span>
                                    {!parseError && <span className="text-green-500">âœ“ Valid JSON</span>}
                                </div>
                                <div>Tab inserts spaces Â· Ctrl+Z to undo</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Empty state â€” no rules loaded yet */}
                {rules === null && !loading && !error && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <div className="text-4xl mb-3">ðŸ”’</div>
                        <p className="text-slate-400 mb-4">Click <strong>Fetch Rules</strong> to load the current security rules from Firebase.</p>
                        <button 
                            onClick={fetchRules}
                            className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium"
                        >
                            Fetch Rules
                        </button>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // FIREBASE FUNCTIONS DASHBOARD (v8.11.0 â€” Phase 3)
    // =========================================================================
    
    function FirebaseFunctionsDashboard({ showAlert }) {
        const [functions, setFunctions] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [pinging, setPinging] = React.useState({});
        const [pingResults, setPingResults] = React.useState({});
        const [errorCounts, setErrorCounts] = React.useState({});
        const [loadingErrors, setLoadingErrors] = React.useState(false);
        const [lastRefresh, setLastRefresh] = React.useState(null);
        
        const configured = firebaseAdmin.isConfigured();
        const FUNCTIONS_BASE = 'https://us-central1-word-boxing.cloudfunctions.net';
        
        // Fetch functions list
        const fetchFunctions = async () => {
            if (!configured) return;
            setLoading(true);
            setError(null);
            try {
                const fns = await firebaseAdmin.listFunctions();
                setFunctions(fns);
                setLastRefresh(new Date());
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        // Fetch error counts per function (last 24h)
        const fetchErrorCounts = async () => {
            if (!configured) return;
            setLoadingErrors(true);
            try {
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                const logs = await firebaseAdmin.getLogs({
                    filter: `resource.type="cloud_function" AND severity>=ERROR AND timestamp>="${oneDayAgo}"`,
                    pageSize: 200
                });
                
                // Group by function name
                const counts = {};
                logs.forEach(entry => {
                    const fnName = entry.resource?.labels?.function_name || 'unknown';
                    counts[fnName] = (counts[fnName] || 0) + 1;
                });
                setErrorCounts(counts);
            } catch (e) {
                console.warn('Failed to fetch error counts:', e);
            }
            setLoadingErrors(false);
        };
        
        // Ping a function's HTTPS endpoint
        const pingFunction = async (fn) => {
            const entryPoint = fn.entryPoint || fn.name.split('/').pop();
            setPinging(prev => ({ ...prev, [entryPoint]: true }));
            
            const start = Date.now();
            try {
                // Use a simple POST with empty data â€” most callable functions will respond with an auth error
                // but that still proves the function is alive and responsive
                const response = await fetch(`${FUNCTIONS_BASE}/${entryPoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: {} })
                });
                
                const elapsed = Date.now() - start;
                const isHealthy = response.status < 500; // 4xx = auth error but function is alive, 5xx = broken
                
                setPingResults(prev => ({
                    ...prev,
                    [entryPoint]: {
                        status: response.status,
                        elapsed,
                        healthy: isHealthy,
                        message: isHealthy 
                            ? `${response.status} in ${elapsed}ms` 
                            : `${response.status} error in ${elapsed}ms`,
                        timestamp: new Date()
                    }
                }));
            } catch (e) {
                const elapsed = Date.now() - start;
                setPingResults(prev => ({
                    ...prev,
                    [entryPoint]: {
                        status: 0,
                        elapsed,
                        healthy: false,
                        message: `Failed: ${e.message}`,
                        timestamp: new Date()
                    }
                }));
            }
            setPinging(prev => ({ ...prev, [entryPoint]: false }));
        };
        
        // Ping all functions
        const pingAll = async () => {
            if (!functions) return;
            for (const fn of functions) {
                await pingFunction(fn);
            }
        };
        
        // Load on mount
        React.useEffect(() => {
            if (configured) {
                fetchFunctions().then(() => fetchErrorCounts());
            }
        }, []);
        
        // Helper: extract short name from full function path
        const getShortName = (fn) => fn.entryPoint || fn.name.split('/').pop();
        
        // Helper: format time ago
        const timeAgo = (dateStr) => {
            if (!dateStr) return 'unknown';
            const diff = Date.now() - new Date(dateStr).getTime();
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'just now';
        };
        
        // Not configured
        if (!configured) {
            return (
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">âš¡ Functions Dashboard</h2>
                    <div className="p-4 bg-amber-900/20 border border-amber-700 rounded-lg">
                        <p className="text-amber-400 font-medium">Service account required</p>
                        <p className="text-sm text-slate-400 mt-2">
                            Configure a service account key in <strong className="text-white">Configure â†’ Settings â†’ Firebase Admin</strong> to view Cloud Functions.
                        </p>
                    </div>
                </div>
            );
        }
        
        // Compute summary stats
        const activeFunctions = functions ? functions.filter(f => f.status === 'ACTIVE').length : 0;
        const totalFunctions = functions ? functions.length : 0;
        const totalErrors24h = Object.values(errorCounts).reduce((sum, c) => sum + c, 0);
        const latestDeploy = functions ? functions.reduce((latest, fn) => {
            if (!fn.updateTime) return latest;
            return !latest || new Date(fn.updateTime) > new Date(latest) ? fn.updateTime : latest;
        }, null) : null;
        
        return (
            <div className="space-y-6">
                {/* Summary Cards */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 text-center">
                        <div className={`text-3xl font-bold ${activeFunctions === totalFunctions ? 'text-green-400' : 'text-amber-400'}`}>
                            {loading ? '...' : activeFunctions}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                            Active / {totalFunctions} Functions
                        </div>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 text-center">
                        <div className={`text-3xl font-bold ${totalErrors24h === 0 ? 'text-green-400' : 'text-red-400'}`}>
                            {loadingErrors ? '...' : totalErrors24h}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">Errors (24h)</div>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 text-center">
                        <div className="text-3xl font-bold text-indigo-400">
                            {latestDeploy ? timeAgo(latestDeploy) : 'â€”'}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">Last Deploy</div>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 text-center">
                        <div className="text-3xl font-bold text-slate-400">
                            {lastRefresh ? lastRefresh.toLocaleTimeString() : 'â€”'}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">Last Refresh</div>
                    </div>
                </div>
                
                {/* Actions */}
                <div className="flex items-center justify-between">
                    <h2 className="text-lg font-semibold flex items-center gap-2">
                        âš¡ Cloud Functions â€” <span className="font-mono text-indigo-400">{FIREBASE_CONFIG.projectId}</span>
                    </h2>
                    <div className="flex gap-2">
                        <button 
                            onClick={pingAll}
                            disabled={!functions || Object.values(pinging).some(Boolean)}
                            className="px-3 py-1.5 bg-amber-600 hover:bg-amber-500 rounded text-sm disabled:opacity-50"
                        >
                            ðŸ“ Ping All
                        </button>
                        <button 
                            onClick={() => { fetchFunctions(); fetchErrorCounts(); }}
                            disabled={loading}
                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                        >
                            {loading ? 'â³' : 'ðŸ”„'} Refresh
                        </button>
                    </div>
                </div>
                
                {error && (
                    <div className="p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                        {error}
                    </div>
                )}
                
                {/* Functions Table */}
                {functions && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="border-b border-slate-700 text-left">
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Function</th>
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Status</th>
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Runtime</th>
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Memory</th>
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Errors 24h</th>
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Last Deploy</th>
                                    <th className="px-4 py-3 text-xs text-slate-400 uppercase tracking-wide">Health</th>
                                </tr>
                            </thead>
                            <tbody>
                                {functions.map(fn => {
                                    const name = getShortName(fn);
                                    const ping = pingResults[name];
                                    const errors = errorCounts[name] || 0;
                                    const isPinging = pinging[name];
                                    
                                    return (
                                        <tr key={fn.name} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                            <td className="px-4 py-3">
                                                <div className="font-mono text-indigo-400">{name}</div>
                                                {fn.httpsTrigger?.url && (
                                                    <div className="text-xs text-slate-600 truncate max-w-[250px]" title={fn.httpsTrigger.url}>
                                                        {fn.httpsTrigger.url}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${
                                                    fn.status === 'ACTIVE' 
                                                        ? 'bg-green-900/40 text-green-400' 
                                                        : fn.status === 'DEPLOY_IN_PROGRESS'
                                                        ? 'bg-amber-900/40 text-amber-400'
                                                        : 'bg-red-900/40 text-red-400'
                                                }`}>
                                                    <span className={`w-1.5 h-1.5 rounded-full ${
                                                        fn.status === 'ACTIVE' ? 'bg-green-400' :
                                                        fn.status === 'DEPLOY_IN_PROGRESS' ? 'bg-amber-400' : 'bg-red-400'
                                                    }`}></span>
                                                    {fn.status}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-xs text-slate-400">{fn.runtime || 'â€”'}</td>
                                            <td className="px-4 py-3 text-xs text-slate-400">{fn.availableMemoryMb ? `${fn.availableMemoryMb}MB` : 'â€”'}</td>
                                            <td className="px-4 py-3">
                                                <span className={`text-xs font-medium ${errors > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                    {loadingErrors ? '...' : errors}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-xs text-slate-400">
                                                {fn.updateTime ? timeAgo(fn.updateTime) : 'â€”'}
                                            </td>
                                            <td className="px-4 py-3">
                                                {isPinging ? (
                                                    <span className="text-xs text-amber-400 animate-pulse">pinging...</span>
                                                ) : ping ? (
                                                    <div className="flex items-center gap-1.5">
                                                        <span className={`w-2 h-2 rounded-full ${ping.healthy ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                                        <span className={`text-xs ${ping.healthy ? 'text-green-400' : 'text-red-400'}`}>
                                                            {ping.message}
                                                        </span>
                                                    </div>
                                                ) : (
                                                    <button 
                                                        onClick={() => pingFunction(fn)}
                                                        className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                                    >
                                                        ðŸ“ Ping
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
                
                {/* Empty state */}
                {!functions && !loading && !error && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <div className="text-4xl mb-3">âš¡</div>
                        <p className="text-slate-400 mb-4">Click <strong>Refresh</strong> to load Cloud Functions from Firebase.</p>
                        <button onClick={fetchFunctions} className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium">
                            Load Functions
                        </button>
                    </div>
                )}
            </div>
        );
    }
    
    // =========================================================================
    // FIREBASE LOG VIEWER (v8.11.0 â€” Phase 3)
    // =========================================================================
    
    function FirebaseLogViewer({ showAlert }) {
        const [logs, setLogs] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [severityFilter, setSeverityFilter] = React.useState('ALL');
        const [functionFilter, setFunctionFilter] = React.useState('ALL');
        const [searchText, setSearchText] = React.useState('');
        const [pageSize, setPageSize] = React.useState(50);
        const [autoRefresh, setAutoRefresh] = React.useState(false);
        const [lastRefresh, setLastRefresh] = React.useState(null);
        const autoRefreshRef = React.useRef(null);
        
        const configured = firebaseAdmin.isConfigured();
        
        const severityLevels = [
            { id: 'ALL', label: 'All', color: 'text-slate-400' },
            { id: 'DEBUG', label: 'Debug', color: 'text-slate-500' },
            { id: 'INFO', label: 'Info', color: 'text-blue-400' },
            { id: 'WARNING', label: 'Warning', color: 'text-amber-400' },
            { id: 'ERROR', label: 'Error', color: 'text-red-400' },
            { id: 'CRITICAL', label: 'Critical', color: 'text-red-500 font-bold' }
        ];
        
        // Build filter string
        const buildFilter = () => {
            const parts = ['resource.type="cloud_function"'];
            if (severityFilter !== 'ALL') {
                if (severityFilter === 'ERROR') {
                    parts.push('severity>=ERROR');
                } else {
                    parts.push(`severity="${severityFilter}"`);
                }
            }
            if (functionFilter !== 'ALL') {
                parts.push(`resource.labels.function_name="${functionFilter}"`);
            }
            if (searchText.trim()) {
                parts.push(`textPayload:"${searchText.trim()}"`);
            }
            return parts.join(' AND ');
        };
        
        // Fetch logs
        const fetchLogs = async () => {
            if (!configured) return;
            setLoading(true);
            setError(null);
            try {
                const entries = await firebaseAdmin.getLogs({
                    filter: buildFilter(),
                    orderBy: 'timestamp desc',
                    pageSize
                });
                setLogs(entries);
                setLastRefresh(new Date());
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        // Auto-refresh
        React.useEffect(() => {
            if (autoRefresh) {
                autoRefreshRef.current = setInterval(fetchLogs, 30000); // 30s
            }
            return () => {
                if (autoRefreshRef.current) clearInterval(autoRefreshRef.current);
            };
        }, [autoRefresh, severityFilter, functionFilter, searchText, pageSize]);
        
        // Load on mount
        React.useEffect(() => {
            if (configured) fetchLogs();
        }, []);
        
        // Get unique function names from logs
        const functionNames = React.useMemo(() => {
            const names = new Set();
            logs.forEach(entry => {
                const name = entry.resource?.labels?.function_name;
                if (name) names.add(name);
            });
            return Array.from(names).sort();
        }, [logs]);
        
        // Severity badge
        const SeverityBadge = ({ severity }) => {
            const styles = {
                DEBUG: 'bg-slate-700 text-slate-400',
                DEFAULT: 'bg-slate-700 text-slate-400',
                INFO: 'bg-blue-900/40 text-blue-400',
                NOTICE: 'bg-blue-900/40 text-blue-300',
                WARNING: 'bg-amber-900/40 text-amber-400',
                ERROR: 'bg-red-900/40 text-red-400',
                CRITICAL: 'bg-red-900/60 text-red-300 font-bold',
                ALERT: 'bg-red-900/60 text-red-300 font-bold',
                EMERGENCY: 'bg-red-800 text-white font-bold'
            };
            return (
                <span className={`inline-block px-2 py-0.5 rounded text-xs font-mono ${styles[severity] || styles.DEFAULT}`}>
                    {severity || 'DEFAULT'}
                </span>
            );
        };
        
        // Get log message text
        const getLogText = (entry) => {
            if (entry.textPayload) return entry.textPayload;
            if (entry.jsonPayload) {
                if (entry.jsonPayload.message) return entry.jsonPayload.message;
                return JSON.stringify(entry.jsonPayload, null, 2);
            }
            return '(empty)';
        };
        
        // Not configured
        if (!configured) {
            return (
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">ðŸ“‹ Log Viewer</h2>
                    <div className="p-4 bg-amber-900/20 border border-amber-700 rounded-lg">
                        <p className="text-amber-400 font-medium">Service account required</p>
                        <p className="text-sm text-slate-400 mt-2">
                            Configure a service account key in <strong className="text-white">Configure â†’ Settings â†’ Firebase Admin</strong> to view logs.
                        </p>
                    </div>
                </div>
            );
        }
        
        // Count by severity
        const severityCounts = React.useMemo(() => {
            const counts = {};
            logs.forEach(entry => {
                const sev = entry.severity || 'DEFAULT';
                counts[sev] = (counts[sev] || 0) + 1;
            });
            return counts;
        }, [logs]);
        
        return (
            <div className="space-y-6">
                {/* Controls */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold flex items-center gap-2">
                            ðŸ“‹ Cloud Logging â€” <span className="font-mono text-indigo-400">{FIREBASE_CONFIG.projectId}</span>
                        </h2>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setAutoRefresh(!autoRefresh)}
                                className={`px-3 py-1.5 rounded text-sm ${autoRefresh ? 'bg-green-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                            >
                                {autoRefresh ? 'ðŸ”´ Auto (30s)' : 'âšª Auto'}
                            </button>
                            <button 
                                onClick={fetchLogs}
                                disabled={loading}
                                className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                            >
                                {loading ? 'â³' : 'ðŸ”„'} Refresh
                            </button>
                        </div>
                    </div>
                    
                    {/* Filter Row */}
                    <div className="flex flex-wrap gap-3 items-center">
                        {/* Severity Filter */}
                        <div className="flex items-center gap-1.5">
                            <span className="text-xs text-slate-500">Severity:</span>
                            <select 
                                value={severityFilter} 
                                onChange={e => setSeverityFilter(e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm"
                            >
                                {severityLevels.map(s => (
                                    <option key={s.id} value={s.id}>{s.label}</option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Function Filter */}
                        <div className="flex items-center gap-1.5">
                            <span className="text-xs text-slate-500">Function:</span>
                            <select 
                                value={functionFilter} 
                                onChange={e => setFunctionFilter(e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm"
                            >
                                <option value="ALL">All</option>
                                {functionNames.map(name => (
                                    <option key={name} value={name}>{name}</option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Text Search */}
                        <div className="flex-1 min-w-[200px]">
                            <input 
                                type="text"
                                value={searchText}
                                onChange={e => setSearchText(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && fetchLogs()}
                                placeholder="Search log text..."
                                className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm"
                            />
                        </div>
                        
                        {/* Page Size */}
                        <div className="flex items-center gap-1.5">
                            <span className="text-xs text-slate-500">Show:</span>
                            <select 
                                value={pageSize} 
                                onChange={e => setPageSize(Number(e.target.value))}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm"
                            >
                                <option value={25}>25</option>
                                <option value={50}>50</option>
                                <option value={100}>100</option>
                                <option value={200}>200</option>
                            </select>
                        </div>
                        
                        <button 
                            onClick={fetchLogs}
                            className="px-4 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-sm"
                        >
                            Apply
                        </button>
                    </div>
                </div>
                
                {error && (
                    <div className="p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                        {error}
                    </div>
                )}
                
                {/* Severity Summary Bar */}
                {logs.length > 0 && (
                    <div className="flex gap-3 items-center text-xs">
                        <span className="text-slate-500">{logs.length} entries</span>
                        {Object.entries(severityCounts).sort().map(([sev, count]) => {
                            const level = severityLevels.find(s => s.id === sev) || { color: 'text-slate-400' };
                            return (
                                <button 
                                    key={sev} 
                                    onClick={() => { setSeverityFilter(sev); fetchLogs(); }}
                                    className={`${level.color} hover:underline`}
                                >
                                    {sev}: {count}
                                </button>
                            );
                        })}
                        {lastRefresh && (
                            <span className="text-slate-600 ml-auto">
                                Updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                    </div>
                )}
                
                {/* Log Entries */}
                {logs.length > 0 ? (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                        <div className="max-h-[600px] overflow-y-auto">
                            {logs.map((entry, i) => {
                                const fnName = entry.resource?.labels?.function_name || '';
                                const text = getLogText(entry);
                                const isError = entry.severity === 'ERROR' || entry.severity === 'CRITICAL';
                                
                                return (
                                    <div 
                                        key={i} 
                                        className={`px-4 py-2.5 border-b border-slate-700/50 text-sm hover:bg-slate-700/30 ${
                                            isError ? 'bg-red-900/10' : ''
                                        }`}
                                    >
                                        <div className="flex items-center gap-3 mb-1">
                                            <span className="text-xs text-slate-600 font-mono w-[150px] flex-shrink-0">
                                                {entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'â€”'}
                                            </span>
                                            <SeverityBadge severity={entry.severity} />
                                            {fnName && (
                                                <button 
                                                    onClick={() => { setFunctionFilter(fnName); fetchLogs(); }}
                                                    className="text-xs font-mono text-indigo-400 hover:underline"
                                                >
                                                    {fnName}
                                                </button>
                                            )}
                                        </div>
                                        <div className={`font-mono text-xs leading-relaxed whitespace-pre-wrap break-all ${
                                            isError ? 'text-red-300' : 'text-slate-300'
                                        }`}>
                                            {text}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                ) : !loading && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <div className="text-4xl mb-3">ðŸ“‹</div>
                        <p className="text-slate-400 mb-4">
                            {logs.length === 0 && lastRefresh 
                                ? 'No log entries match the current filters.'
                                : 'Click Refresh to load Cloud Logging entries.'
                            }
                        </p>
                        {!lastRefresh && (
                            <button onClick={fetchLogs} className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium">
                                Load Logs
                            </button>
                        )}
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // APPS VIEW
    // =========================================================================
    

    // =========================================================================
    // VIEW: GitHub (Repo Files)
    // =========================================================================

    function RepoFilesView({ apps, github, repoFiles, onLoadRepo, selectedRepo, onSelectRepo, selectedAppKey, onSelectAppKey, markedForDeletion, setMarkedForDeletion, onDeleteMarked, showAlert }) {
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        const allRepos = [...new Set(configuredApps.flatMap(a => [a.testRepo, a.prodRepo].filter(Boolean)))];
        
        // v8.35.0: Derive selected app and subPath from selectedAppKey
        const selectedAppId = selectedAppKey ? selectedAppKey.split('::')[0] : null;
        const selectedApp = selectedAppId ? configuredApps.find(a => a.id === selectedAppId) : null;
        const selectedSubPath = selectedApp?.subPath || '';
        const cacheKey = selectedRepo ? (selectedSubPath ? `${selectedRepo}::${selectedSubPath}` : selectedRepo) : null;
        
        const currentFiles = repoFiles[cacheKey]?.files || [];
        const isLoading = repoFiles[cacheKey]?.loading;
        
        const [versionAudit, setVersionAudit] = React.useState(null);
        const [expandedDirs, setExpandedDirs] = React.useState([]);
        
        const toggleMarkForDeletion = (file) => {
            const existing = markedForDeletion.find(m => m.repo === selectedRepo && m.path === file.path);
            if (existing) {
                setMarkedForDeletion(prev => prev.filter(m => !(m.repo === selectedRepo && m.path === file.path)));
            } else {
                setMarkedForDeletion(prev => [...prev, { repo: selectedRepo, path: file.path, sha: file.sha, name: file.name }]);
            }
        };
        
        const isMarked = (file) => markedForDeletion.some(m => m.repo === selectedRepo && m.path === file.path);
        
        // Download file to user's Downloads folder
        const downloadFile = async (file) => {
            try {
                // Fetch the raw file content
                const response = await fetch(file.download_url);
                const blob = await response.blob();
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name; // Forces download with filename
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Download failed:', err);
                showAlert('Download failed: ' + err.message, 'Download Error');
            }
        };
        
        // Download entire repo as deploy package zip
        const [downloadingPackage, setDownloadingPackage] = React.useState(false);
        
        const downloadDeployPackage = async () => {
            if (!selectedRepo || !github) return;
            
            setDownloadingPackage(true);
            try {
                // Get app info for naming and subPath
                // v8.35.0: Use selectedAppKey to find exact app (handles shared repos)
                let app = null;
                if (selectedAppKey) {
                    const appId = selectedAppKey.split('::')[0];
                    app = configuredApps.find(a => a.id === appId);
                }
                if (!app) {
                    // Fallback: When multiple apps share a repo, prefer ones with subPath (more specific)
                    const matchingApps = configuredApps.filter(a => a.testRepo === selectedRepo || a.prodRepo === selectedRepo);
                    app = matchingApps.find(a => a.subPath) || matchingApps[0];
                }
                const repoName = selectedRepo.split('/')[1];
                const subPath = app?.subPath || '';
                
                // WHITELIST: Only include files that belong in deploy packages
                // Based on gs-active skill deploy structure
                const deployFiles = [
                    'index.html',
                    'sw.js',
                    'manifest.json',
                    'manifest-test.json',  // Test environment manifest
                    'RELEASE_NOTES.txt'  // Optional but include if present
                ];
                
                // Valid icon files for deploy packages
                const validIcons = [
                    'icon-72.png', 'icon-96.png', 'icon-128.png', 'icon-144.png',
                    'icon-152.png', 'icon-192.png', 'icon-384.png', 'icon-512.png',
                    'icon-maskable-192.png', 'icon-maskable-512.png',
                    'icon-source.svg', 'apple-touch-icon.png'
                ];
                
                // Check if a file should be included in deploy package
                // v8.7.5: Handle subPath - strip it from path before checking
                const shouldInclude = (fullPath) => {
                    // Remove subPath prefix if present to get relative path
                    let path = fullPath;
                    if (subPath && fullPath.startsWith(subPath + '/')) {
                        path = fullPath.substring(subPath.length + 1);
                    }
                    const filename = path.split('/').pop();
                    // Root level deploy files (relative to app folder)
                    if (deployFiles.includes(filename) && !path.includes('/')) return true;
                    // Icons folder files (both prod and test)
                    if ((path.startsWith('icons/') || path.startsWith('icons-test/')) && validIcons.includes(filename)) return true;
                    return false;
                };
                
                // Fetch repo contents - v8.7.5: Start from subPath if set
                const fetchAllFiles = async (path = subPath) => {
                    const contents = await github.listRepoContents(selectedRepo, path);
                    let files = [];
                    
                    for (const item of contents) {
                        if (item.type === 'file') {
                            // Only include whitelisted deploy files
                            if (shouldInclude(item.path)) {
                                files.push(item);
                            }
                        } else if (item.type === 'dir' && (item.name === 'icons' || item.name === 'icons-test')) {
                            // Recurse into icons and icons-test folders
                            const subFiles = await fetchAllFiles(item.path);
                            files = files.concat(subFiles);
                        }
                    }
                    return files;
                };
                
                const allFiles = await fetchAllFiles();
                
                // Get version from index.html if present
                let version = 'unknown';
                const indexFile = allFiles.find(f => f.name === 'index.html');
                if (indexFile) {
                    try {
                        // For large files (>1MB), GitHub API doesn't return content
                        // Use download_url instead which always works
                        const response = await fetch(indexFile.download_url);
                        const content = await response.text();
                        version = extractVersionFromHTML(content) || 'unknown';
                    } catch (e) {
                        console.warn('Could not extract version:', e);
                    }
                }
                
                // Determine folder name for zip structure: {app}-latest/
                // v8.35.0: Use app name for zip folder, not repo name
                let appName = (app?.id || repoName).replace(/test$/i, '');
                const folderName = `${appName}-latest`;
                
                // Create zip with proper structure: {app}-latest/{files}
                const zip = new JSZip();
                const folder = zip.folder(folderName);
                
                for (const file of allFiles) {
                    try {
                        const response = await fetch(file.download_url);
                        const blob = await response.blob();
                        // v8.35.0: Strip subPath prefix for correct zip structure
                        let relativePath = file.path;
                        if (subPath && relativePath.startsWith(subPath + '/')) {
                            relativePath = relativePath.substring(subPath.length + 1);
                        }
                        folder.file(relativePath, blob);
                    } catch (e) {
                        console.warn(`Failed to fetch ${file.path}:`, e);
                    }
                }
                
                // Generate zip and download
                const versionStr = version.replace(/\./g, '_');
                const filename = `${appName}-deploy-v${versionStr}.zip`;
                
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setDownloadingPackage(false);
                
                // Show what was included
                const includedFiles = allFiles.map(f => f.path).join(', ');
                console.log(`Deploy package created: ${filename}`);
                console.log(`Included files: ${includedFiles}`);
                
            } catch (err) {
                console.error('Deploy package download failed:', err);
                showAlert('Deploy package download failed: ' + err.message, 'Download Error');
                setDownloadingPackage(false);
            }
        };
        
        const handleVersionAudit = async () => {
            if (!github || !selectedRepo) return;
            setVersionAudit({ loading: true });
            
            try {
                // v8.35.0: Use selectedAppKey to find exact app (handles shared repos)
                let app = null;
                if (selectedAppKey) {
                    const appId = selectedAppKey.split('::')[0];
                    app = configuredApps.find(a => a.id === appId);
                }
                if (!app) {
                    const matchingApps = configuredApps.filter(a => a.testRepo === selectedRepo || a.prodRepo === selectedRepo);
                    app = matchingApps.find(a => a.subPath) || matchingApps[0];
                }
                const indexPath = app?.subPath ? `${app.subPath}/index.html` : 'index.html';
                
                const fileData = await github.getFileContent(selectedRepo, indexPath);
                if (fileData) {
                    // Use textContent which handles both normal and large files
                    const content = fileData.textContent;
                    const versions = findAllVersionStrings(content);
                    const primary = extractVersionFromHTML(content);
                    
                    // Check for mismatches
                    const uniqueVersions = [...new Set(versions.map(v => v.value))];
                    const hasMismatch = uniqueVersions.length > 1;
                    
                    setVersionAudit({ loading: false, versions, primary, hasMismatch, uniqueVersions });
                } else {
                    setVersionAudit({ loading: false, error: 'index.html not found' });
                }
            } catch (e) {
                setVersionAudit({ loading: false, error: e.message });
            }
        };
        
        return (
            <div className="space-y-6">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.Folder /> App Files
                    </h2>
                    
                    <div className="flex gap-4 mb-4">
                        <select value={selectedAppKey || ''} onChange={e => {
                            const val = e.target.value;
                            if (!val) { onSelectRepo(''); onSelectAppKey(''); return; }
                            const appId = val.split('::')[0];
                            const repo = val.split('::').slice(2).join('::');
                            const app = configuredApps.find(a => a.id === appId);
                            const subPath = app?.subPath || '';
                            onSelectAppKey(val);
                            onSelectRepo(repo);
                            setExpandedDirs([]);
                            if (repo) onLoadRepo(repo, subPath);
                        }}
                            className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded">
                            <option value="">Select app...</option>
                            {configuredApps
                                .sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id))
                                .flatMap(app => {
                                    const options = [];
                                    if (app.prodRepo) options.push({ label: `${getAppEmoji(app.icon)} ${app.name || app.id} â€” PROD`, key: `${app.id}::prod::${app.prodRepo}` });
                                    if (app.testRepo) options.push({ label: `${getAppEmoji(app.icon)} ${app.name || app.id} â€” TEST`, key: `${app.id}::test::${app.testRepo}` });
                                    return options;
                                })
                                .map(opt => <option key={opt.key} value={opt.key}>{opt.label}</option>)
                            }
                        </select>
                        
                        {selectedRepo && (
                            <button onClick={() => onLoadRepo(selectedRepo, selectedSubPath)} className="px-4 py-2 bg-slate-700 rounded flex items-center gap-2">
                                <Icons.Refresh className={isLoading ? 'animate-spin' : ''} /> Refresh
                            </button>
                        )}
                    </div>
                    
                    {selectedRepo && (
                        <div className="flex gap-2 mb-4 flex-wrap">
                            <a href={getGitHubPagesUrl(selectedRepo)} target="_blank" 
                                className="px-3 py-1.5 bg-indigo-600 rounded text-sm flex items-center gap-1">
                                <Icons.Play /> Open Site
                            </a>
                            <a href={`https://github.com/${selectedRepo}`} target="_blank"
                                className="px-3 py-1.5 bg-slate-700 rounded text-sm flex items-center gap-1">
                                <Icons.ExternalLink /> GitHub
                            </a>
                            <button onClick={handleVersionAudit}
                                className="px-3 py-1.5 bg-amber-700 rounded text-sm flex items-center gap-1">
                                ðŸ” Version Audit
                            </button>
                            <button onClick={downloadDeployPackage} disabled={downloadingPackage}
                                className="px-3 py-1.5 bg-green-700 hover:bg-green-600 disabled:bg-green-900 disabled:cursor-wait rounded text-sm flex items-center gap-1">
                                {downloadingPackage ? (
                                    <><div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin" /> Creating...</>
                                ) : (
                                    <><Icons.Download /> Download Package</>
                                )}
                            </button>
                        </div>
                    )}
                    
                    {/* Version Audit Results */}
                    {versionAudit && (
                        <div className={`mb-4 p-4 rounded-lg border ${versionAudit.hasMismatch ? 'bg-red-900/30 border-red-700' : 'bg-slate-700/50 border-slate-600'}`}>
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-semibold flex items-center gap-2">
                                    {versionAudit.loading ? (
                                        <>
                                            <div className="w-4 h-4 border-2 border-amber-400 border-t-transparent rounded-full animate-spin" />
                                            Scanning...
                                        </>
                                    ) : versionAudit.hasMismatch ? (
                                        <><span className="text-red-400">âš ï¸ Version Mismatch Found!</span></>
                                    ) : (
                                        <><span className="text-green-400">âœ“ Versions Consistent</span></>
                                    )}
                                </h3>
                                <button onClick={() => setVersionAudit(null)} className="text-slate-400 hover:text-white">
                                    <Icons.X />
                                </button>
                            </div>
                            
                            {versionAudit.error && (
                                <div className="text-red-400 text-sm">{versionAudit.error}</div>
                            )}
                            
                            {versionAudit.versions && (
                                <>
                                    <div className="text-sm mb-2">
                                        <span className="text-slate-400">Primary version (meta tag): </span>
                                        <span className="font-mono text-green-400">{versionAudit.primary || 'Not found'}</span>
                                    </div>
                                    
                                    {versionAudit.hasMismatch && (
                                        <div className="text-sm mb-2 text-amber-400">
                                            Found {versionAudit.uniqueVersions.length} different versions: {versionAudit.uniqueVersions.join(', ')}
                                        </div>
                                    )}
                                    
                                    <div className="text-xs text-slate-400 mb-2">Found {versionAudit.versions.length} version string(s):</div>
                                    <div className="space-y-1 max-h-48 overflow-auto">
                                        {versionAudit.versions.map((v, i) => (
                                            <div key={i} className={`text-xs p-2 rounded ${v.value === versionAudit.primary ? 'bg-green-900/30' : 'bg-red-900/30'}`}>
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-mono ${v.value === versionAudit.primary ? 'text-green-400' : 'text-red-400'}`}>
                                                        {v.value}
                                                    </span>
                                                    <span className="text-slate-500">â† {v.source}</span>
                                                </div>
                                                <div className="text-slate-500 font-mono truncate mt-1">{v.context}</div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                    
                    {isLoading && (
                        <div className="text-center py-8 text-slate-400">
                            <div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-2" />
                            Loading files...
                        </div>
                    )}
                    
                    {!isLoading && currentFiles.length > 0 && (
                        <div className="space-y-1">
                            {/* Directories first */}
                            {currentFiles.filter(f => f.type === 'dir').map(dir => (
                                <div key={dir.path} className="bg-slate-700/30 rounded">
                                    <div className="p-2 flex items-center gap-3 cursor-pointer hover:bg-slate-700/50" 
                                        onClick={() => {
                                            const dirCacheKey = `${selectedRepo}::${dir.path}`;
                                            if (repoFiles[dirCacheKey]?.files) {
                                                setExpandedDirs(prev => prev.includes(dir.path) ? prev.filter(d => d !== dir.path) : [...prev, dir.path]);
                                            } else {
                                                onLoadRepo(selectedRepo, dir.path);
                                                setExpandedDirs(prev => [...prev, dir.path]);
                                            }
                                        }}>
                                        <span>{expandedDirs.includes(dir.path) ? 'ðŸ“‚' : 'ðŸ“'}</span>
                                        <span className="flex-1 font-mono text-sm font-semibold">{dir.name}/</span>
                                        <span className="text-xs text-slate-500">folder</span>
                                    </div>
                                    {expandedDirs.includes(dir.path) && (() => {
                                        const dirCacheKey = `${selectedRepo}::${dir.path}`;
                                        const dirFiles = repoFiles[dirCacheKey]?.files || [];
                                        const dirLoading = repoFiles[dirCacheKey]?.loading;
                                        return (
                                            <div className="ml-6 border-l border-slate-600 pl-2 pb-1">
                                                {dirLoading && <div className="p-2 text-xs text-slate-500">Loading...</div>}
                                                {dirFiles.filter(f => f.type === 'file').map(file => (
                                                    <div key={file.path} className={`p-1.5 rounded flex items-center gap-3 ${isMarked(file) ? 'bg-red-900/30 border border-red-700' : 'hover:bg-slate-700/50'}`}>
                                                        <span>{getFileIcon(file.name)}</span>
                                                        <span className="flex-1 font-mono text-sm">{file.name}</span>
                                                        <span className="text-xs text-slate-500">{formatBytes(file.size)}</span>
                                                        <div className="flex gap-1">
                                                            <a href={file.download_url} target="_blank" className="p-1 hover:bg-slate-600 rounded" title="View"><Icons.Eye /></a>
                                                            <button onClick={() => downloadFile(file)} className="p-1 hover:bg-slate-600 rounded" title="Download"><Icons.Download /></button>
                                                            <button onClick={() => toggleMarkForDeletion(file)} 
                                                                className={`p-1 rounded ${isMarked(file) ? 'bg-red-600 text-white' : 'hover:bg-red-900/50 text-slate-400 hover:text-red-400'}`}
                                                                title={isMarked(file) ? 'Unmark' : 'Mark for deletion'}><Icons.Trash /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                                {!dirLoading && dirFiles.length === 0 && <div className="p-2 text-xs text-slate-500">Empty</div>}
                                            </div>
                                        );
                                    })()}
                                </div>
                            ))}
                            {/* Then files */}
                            {currentFiles.filter(f => f.type === 'file').map(file => (
                                <div key={file.path} className={`p-2 rounded flex items-center gap-3 ${isMarked(file) ? 'bg-red-900/30 border border-red-700' : 'bg-slate-700/50 hover:bg-slate-700'}`}>
                                    <span>{getFileIcon(file.name)}</span>
                                    <span className="flex-1 font-mono text-sm">{file.name}</span>
                                    <span className="text-xs text-slate-500">{formatBytes(file.size)}</span>
                                    <div className="flex gap-1">
                                        <a href={file.download_url} target="_blank" className="p-1 hover:bg-slate-600 rounded" title="View">
                                            <Icons.Eye />
                                        </a>
                                        <button onClick={() => downloadFile(file)} className="p-1 hover:bg-slate-600 rounded" title="Download">
                                            <Icons.Download />
                                        </button>
                                        <button onClick={() => toggleMarkForDeletion(file)} 
                                            className={`p-1 rounded ${isMarked(file) ? 'bg-red-600 text-white' : 'hover:bg-red-900/50 text-slate-400 hover:text-red-400'}`}
                                            title={isMarked(file) ? 'Unmark' : 'Mark for deletion'}>
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {!isLoading && selectedRepo && currentFiles.length === 0 && (
                        <div className="text-center py-8 text-slate-400">No files found</div>
                    )}
                </div>
                
                {/* Marked for Deletion Panel */}
                {markedForDeletion.length > 0 && (
                    <div className="bg-red-900/20 border border-red-700 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-semibold text-red-400 flex items-center gap-2">
                                <Icons.Trash /> Marked for Deletion ({markedForDeletion.length})
                            </h3>
                            <div className="flex gap-2">
                                <button onClick={() => setMarkedForDeletion([])} className="px-3 py-1 bg-slate-700 rounded text-sm">
                                    Clear All
                                </button>
                                <button onClick={onDeleteMarked} className="px-3 py-1 bg-red-600 rounded text-sm flex items-center gap-1">
                                    <Icons.Trash /> Delete All
                                </button>
                            </div>
                        </div>
                        <div className="space-y-1">
                            {markedForDeletion.map((item, i) => (
                                <div key={i} className="text-sm flex items-center gap-2 text-slate-300">
                                    <Icons.File /> <span className="text-slate-500">{item.repo.split('/')[1]}/</span>{item.path}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // PORTFOLIO VIEW - Cross-app metrics, maturity, velocity, cost tracking
    // =========================================================================
    

    // =========================================================================
    // VIEW: GitHub (Repo Reset Panel)
    // =========================================================================

    function RepoResetPanel({ apps, github, showAlert, showConfirm }) {
        const [scanning, setScanning] = React.useState(false);
        const [scanProgress, setScanProgress] = React.useState('');
        const [results, setResults] = React.useState(null); // [{ appId, appName, appIcon, repo, target, expectedFiles, unexpectedFiles }]
        const [selected, setSelected] = React.useState(new Set()); // "repo:path" keys
        const [deleting, setDeleting] = React.useState(false);
        const [deleteLog, setDeleteLog] = React.useState([]);
        
        const scanAll = async () => {
            if (!github) return;
            setScanning(true);
            setResults(null);
            setSelected(new Set());
            setDeleteLog([]);
            
            const allResults = [];
            
            // Get recently deployed apps (last 30 days)
            let recentApps = new Set();
            try {
                const history = DeployService.load();
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                recentApps = new Set(
                    history.filter(d => d.status === 'success' && new Date(d.completedAt || d.startedAt) > thirtyDaysAgo).map(d => d.appId)
                );
            } catch {}
            
            // Fall back to all apps with repos if no recent deploys
            const appsToScan = Object.entries(apps).filter(([id, app]) => {
                if (recentApps.size > 0 && !recentApps.has(id)) return false;
                return (app.testRepo || app.repos?.test || app.prodRepo || app.repos?.prod);
            });
            
            for (let i = 0; i < appsToScan.length; i++) {
                const [appId, app] = appsToScan[i];
                const repos = [];
                const testRepo = app.testRepo || app.repos?.test;
                const prodRepo = app.prodRepo || app.repos?.prod;
                if (testRepo) repos.push({ repo: testRepo, target: 'test' });
                if (prodRepo) repos.push({ repo: prodRepo, target: 'prod' });
                
                for (const { repo, target } of repos) {
                    setScanProgress(`Scanning ${app.name} (${target})... ${i + 1}/${appsToScan.length}`);
                    
                    try {
                        const subPath = app.subPath || '';
                        const expected = new Set();
                        const addExp = (f) => expected.add(subPath ? `${subPath}/${f}` : f);
                        
                        addExp(app.targetPath || 'index.html');
                        if (app.hasServiceWorker) {
                            addExp(app.swPath || 'sw.js');
                            addExp('manifest.json');
                        }
                        
                        // Doc files for prod repos
                        if (target === 'prod') {
                            const docPath = subPath ? `${subPath}/docs` : '';
                            ['CONTEXT.md', 'PROJECT_PLAN.md', 'CHANGELOG.md', 'RELEASE_NOTES.txt', 'ARCHITECTURE.md', 'CLAUDE-PREP-STANDARD.md', 'DATA_MODEL.md'].forEach(doc => {
                                expected.add(docPath ? `${docPath}/${doc}` : doc);
                            });
                        }
                        
                        // Standard files
                        ['README.md', 'LICENSE', '.gitignore', 'CNAME'].forEach(f => expected.add(f));
                        // Expected directories
                        const iconsPrefix = subPath ? `${subPath}/icons` : 'icons';
                        expected.add(iconsPrefix);
                        expected.add('.github');
                        
                        // Fetch root contents only (lightweight)
                        const rootContents = await github.listRepoContents(repo, subPath || '');
                        
                        const expectedFiles = [];
                        const unexpectedFiles = [];
                        
                        for (const item of rootContents) {
                            const fullPath = subPath ? `${subPath}/${item.name}` : item.name;
                            const isExpected = expected.has(fullPath) || expected.has(item.name) ||
                                item.name.startsWith('.github') ||
                                (item.type === 'dir' && (item.name === 'icons' || item.name === '.github'));
                            
                            if (isExpected) {
                                expectedFiles.push({ path: fullPath, name: item.name, type: item.type, sha: item.sha, size: item.size });
                            } else {
                                unexpectedFiles.push({ path: fullPath, name: item.name, type: item.type, sha: item.sha, size: item.size });
                            }
                        }
                        
                        if (unexpectedFiles.length > 0) {
                            allResults.push({
                                appId, appName: app.name, appIcon: app.icon,
                                repo, target, expectedFiles, unexpectedFiles
                            });
                        }
                    } catch (e) {
                        // Skip repos we can't access
                        console.warn(`[RepoReset] Could not scan ${repo}:`, e.message);
                    }
                }
            }
            
            setResults(allResults);
            setScanProgress('');
            setScanning(false);
        };
        
        const deleteSelected = async () => {
            if (selected.size === 0 || !github) return;
            
            const confirmed = await showConfirm(
                `Delete ${selected.size} file${selected.size > 1 ? 's' : ''} across repos? This cannot be undone.`,
                'âš ï¸ Confirm Deletion'
            );
            if (!confirmed) return;
            
            setDeleting(true);
            setDeleteLog([]);
            
            // Group by repo for efficient deletion
            const byRepo = {};
            for (const key of selected) {
                const [repo, ...pathParts] = key.split('::');
                const path = pathParts.join('::');
                if (!byRepo[repo]) byRepo[repo] = [];
                byRepo[repo].push(path);
            }
            
            for (const [repo, paths] of Object.entries(byRepo)) {
                for (const path of paths) {
                    try {
                        const file = await github.getFile(repo, path);
                        if (file) {
                            // For directories, need to delete all files inside recursively
                            if (!file.content && !file.sha && Array.isArray(file)) {
                                // It's a directory listing
                                for (const item of file) {
                                    if (item.type === 'file') {
                                        await github.deleteFile(repo, item.path, `Cleanup: remove ${item.path} via CC Repo Reset`, item.sha);
                                        setDeleteLog(prev => [...prev, { msg: `âœ… ${repo}: ${item.path}`, type: 'success' }]);
                                    }
                                }
                            } else {
                                await github.deleteFile(repo, path, `Cleanup: remove ${path} via CC Repo Reset`, file.sha);
                                setDeleteLog(prev => [...prev, { msg: `âœ… ${repo}: ${path}`, type: 'success' }]);
                            }
                        }
                    } catch (e) {
                        // If it's a directory, try listing and deleting contents
                        try {
                            const contents = await github.listRepoContents(repo, path);
                            if (Array.isArray(contents)) {
                                for (const item of contents) {
                                    const itemPath = `${path}/${item.name}`;
                                    try {
                                        if (item.type === 'file') {
                                            await github.deleteFile(repo, itemPath, `Cleanup: remove ${itemPath} via CC Repo Reset`, item.sha);
                                            setDeleteLog(prev => [...prev, { msg: `âœ… ${repo}: ${itemPath}`, type: 'success' }]);
                                        } else if (item.type === 'dir') {
                                            // Recurse one level deeper
                                            const subContents = await github.listRepoContents(repo, itemPath);
                                            for (const sub of subContents) {
                                                if (sub.type === 'file') {
                                                    await github.deleteFile(repo, `${itemPath}/${sub.name}`, `Cleanup: remove ${itemPath}/${sub.name} via CC Repo Reset`, sub.sha);
                                                    setDeleteLog(prev => [...prev, { msg: `âœ… ${repo}: ${itemPath}/${sub.name}`, type: 'success' }]);
                                                }
                                            }
                                        }
                                    } catch (e2) {
                                        setDeleteLog(prev => [...prev, { msg: `âŒ ${repo}: ${itemPath} â€” ${e2.message}`, type: 'error' }]);
                                    }
                                }
                            }
                        } catch (e2) {
                            setDeleteLog(prev => [...prev, { msg: `âŒ ${repo}: ${path} â€” ${e.message}`, type: 'error' }]);
                        }
                    }
                }
            }
            
            setDeleteLog(prev => [...prev, { msg: `ðŸŽ‰ Done!`, type: 'success' }]);
            setDeleting(false);
            
            // Re-scan after cleanup
            setTimeout(() => scanAll(), 1500);
        };
        
        const totalUnexpected = results ? results.reduce((sum, r) => sum + r.unexpectedFiles.length, 0) : 0;
        
        const selectAll = () => {
            if (!results) return;
            const allKeys = new Set();
            results.forEach(r => r.unexpectedFiles.forEach(f => allKeys.add(`${r.repo}::${f.path}`)));
            setSelected(allKeys);
        };
        
        return (
            <div className="space-y-4">
                <div className="flex items-center justify-between">
                    <p className="text-sm text-slate-400">
                        Scans recently deployed app repos for unexpected files and directories.
                    </p>
                    <button onClick={scanAll} disabled={scanning || !github}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 rounded text-sm font-medium whitespace-nowrap">
                        {scanning ? `â³ ${scanProgress || 'Scanning...'}` : 'ðŸ” Scan All Repos'}
                    </button>
                </div>
                
                {results && (
                    <div className="space-y-4">
                        {/* Summary */}
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
                                <div className="text-2xl font-bold text-indigo-400">{results.length}</div>
                                <div className="text-xs text-slate-500">Repos with issues</div>
                            </div>
                            <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
                                <div className={`text-2xl font-bold ${totalUnexpected > 0 ? 'text-amber-400' : 'text-green-400'}`}>
                                    {totalUnexpected}
                                </div>
                                <div className="text-xs text-slate-500">Unexpected items</div>
                            </div>
                            <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
                                <div className="text-2xl font-bold text-slate-400">{selected.size}</div>
                                <div className="text-xs text-slate-500">Selected for deletion</div>
                            </div>
                        </div>
                        
                        {totalUnexpected === 0 ? (
                            <div className="bg-green-900/20 border border-green-700/50 rounded-lg p-4 text-center">
                                <div className="text-green-400 font-medium">âœ… All repos are clean</div>
                            </div>
                        ) : (
                            <>
                                {/* Bulk actions */}
                                <div className="flex gap-2">
                                    <button onClick={selectAll}
                                        className="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded font-medium">
                                        Select All ({totalUnexpected})
                                    </button>
                                    <button onClick={() => setSelected(new Set())}
                                        className="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded font-medium">
                                        Deselect All
                                    </button>
                                    {selected.size > 0 && (
                                        <button onClick={deleteSelected} disabled={deleting}
                                            className="px-4 py-1.5 text-xs bg-red-600 hover:bg-red-500 disabled:bg-slate-700 rounded font-medium ml-auto">
                                            {deleting ? 'â³ Deleting...' : `ðŸ—‘ï¸ Delete ${selected.size} item${selected.size > 1 ? 's' : ''}`}
                                        </button>
                                    )}
                                </div>
                                
                                {/* Per-repo results */}
                                {results.map((result, ri) => (
                                    <div key={ri} className="bg-slate-900/50 rounded-lg border border-slate-700">
                                        <div className="flex items-center justify-between p-3 border-b border-slate-700">
                                            <div className="flex items-center gap-2 text-sm font-medium">
                                                <span>{result.appIcon === 'gs-logo' ? 'ðŸŽ®' : result.appIcon}</span>
                                                <span>{result.appName}</span>
                                                <span className={`px-1.5 py-0.5 text-xs rounded ${result.target === 'test' ? 'bg-yellow-900/50 text-yellow-400' : 'bg-green-900/50 text-green-400'}`}>
                                                    {result.target.toUpperCase()}
                                                </span>
                                                <span className="text-xs text-slate-500 font-normal">{result.repo}</span>
                                            </div>
                                            <span className="text-xs text-amber-400">{result.unexpectedFiles.length} unexpected</span>
                                        </div>
                                        <div className="p-2 space-y-1">
                                            {result.unexpectedFiles.map(f => {
                                                const key = `${result.repo}::${f.path}`;
                                                return (
                                                    <label key={f.path} className={`flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer hover:bg-slate-800/50 ${
                                                        selected.has(key) ? 'bg-red-900/20' : ''
                                                    }`}>
                                                        <input type="checkbox" 
                                                            checked={selected.has(key)}
                                                            onChange={() => setSelected(prev => {
                                                                const next = new Set(prev);
                                                                next.has(key) ? next.delete(key) : next.add(key);
                                                                return next;
                                                            })}
                                                        />
                                                        <span className={`text-xs font-mono flex-1 ${f.type === 'dir' ? 'text-amber-400' : 'text-amber-400/70'}`}>
                                                            {f.type === 'dir' ? 'ðŸ“ ' : ''}{f.path}
                                                        </span>
                                                        <span className="text-xs text-slate-500">
                                                            {f.type === 'dir' ? 'dir' : f.size ? `${(f.size / 1024).toFixed(1)}KB` : ''}
                                                        </span>
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </>
                        )}
                        
                        {/* Delete log */}
                        {deleteLog.length > 0 && (
                            <div className="bg-slate-900 rounded-lg p-3 space-y-1 font-mono text-xs max-h-48 overflow-y-auto border border-slate-700">
                                {deleteLog.map((entry, i) => (
                                    <div key={i} className={entry.type === 'success' ? 'text-green-400' : 'text-red-400'}>{entry.msg}</div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }
    

    // =========================================================================
    // VIEW: GitHub (Cleanup â€” Files, Repos, Reset, History)
    // =========================================================================

    function CleanupView({ github, config, apps, availableRepos, showAlert, showConfirm, initialTab, onTabConsumed }) {
        const [activeTab, setActiveTab] = React.useState(initialTab || 'files');
        
        // Handle initialTab from parent (e.g. health check alert)
        React.useEffect(() => {
            if (initialTab) {
                setActiveTab(initialTab);
                if (onTabConsumed) onTabConsumed();
            }
        }, [initialTab]);
        const [scanning, setScanning] = React.useState(false);
        const [scanResults, setScanResults] = React.useState(null);
        const [selectedFiles, setSelectedFiles] = React.useState(new Set());
        const [selectedRepos, setSelectedRepos] = React.useState(new Set());
        const [deleting, setDeleting] = React.useState(false);
        const [deleteProgress, setDeleteProgress] = React.useState({ current: 0, total: 0 });
        const [restoring, setRestoring] = React.useState(false);
        const [fileFilter, setFileFilter] = React.useState('');
        
        // Deletion history - persisted to localStorage
        const [deletionHistory, setDeletionHistory] = React.useState(() => {
            try {
                return JSON.parse(localStorage.getItem('cc_deletion_history') || '[]');
            } catch { return []; }
        });
        
        // Save deletion history to localStorage + Firebase
        const saveDeletionHistory = (history) => {
            setDeletionHistory(history);
            try {
                localStorage.setItem('cc_deletion_history', JSON.stringify(history));
                // Firebase dual-write
                if (FirebaseConfigSync.initialized) {
                    FirebaseConfigSync.pushDeletionHistory(history).catch(() => {});
                }
            } catch (e) {
                console.error('Failed to save deletion history:', e);
            }
        };
        
        // Add to deletion history
        const addToDeletionHistory = (items) => {
            const newHistory = [
                ...items.map(item => ({
                    ...item,
                    deletedAt: new Date().toISOString(),
                    id: `${item.repo}:${item.path}:${Date.now()}`
                })),
                ...deletionHistory
            ].slice(0, 100); // Keep last 100 deletions
            saveDeletionHistory(newHistory);
        };
        
        // Remove from deletion history
        const removeFromHistory = (id) => {
            const newHistory = deletionHistory.filter(h => h.id !== id);
            saveDeletionHistory(newHistory);
        };
        
        // Clear all history
        const clearHistory = async () => {
            const confirmed = await showConfirm('Clear all deletion history? This only removes the history log, not the actual files.', 'Clear History');
            if (confirmed) {
                saveDeletionHistory([]);
            }
        };
        
        // Define base package files for each app type
        // Files/folders that should NEVER be flagged as stale in ANY repo
        const GLOBALLY_PROTECTED_PATHS = [
            '.github',           // GitHub Actions workflows, issue templates, etc.
            '.gitignore',
            'LICENSE',
            'README.md',
            'package.json',
            'package-lock.json',
            'node_modules',
            'firebase.json',
            '.firebaserc',
            '.env',
            '.env.example',
        ];

        const BASE_PACKAGES = {
            pwa: {
                required: ['index.html', 'sw.js', 'manifest.json'],
                optional: ['RELEASE_NOTES.txt', 'CNAME'],
                folders: ['icons']
            },
            gameshelf: {
                // v8.5.0: PWA now in /app/, landing at root
                required: ['index.html', 'sw.js', 'manifest.json', 'manifest-test.json'],
                optional: ['RELEASE_NOTES.txt', 'CNAME'],
                folders: ['icons', 'icons-test', 'quotle', 'slate', 'rungs', 'wordboxing', 'beta']
            },
            simple: {
                required: ['index.html'],
                optional: ['RELEASE_NOTES.txt', 'README.md', 'CNAME'],
                folders: []
            },
            'firebase-functions': {
                required: ['package.json'],
                optional: ['package-lock.json', 'firebase.json', '.firebaserc', '.env', '.env.example', 'README.md', '.gitignore'],
                folders: ['functions', '.github', 'node_modules']
            }
        };
        
        // Define which repos are consolidated (should contain subfolders)
        const CONSOLIDATED_REPOS = {
            // v8.5.0: Added 'app' for PWA location
            'gameshelf': ['app', 'quotle', 'slate', 'rungs', 'wordboxing', 'beta'],
            'gameshelftest': ['app', 'quotle', 'slate', 'rungs', 'wordboxing']
        };
        
        // Define legacy repos that may no longer be needed
        const LEGACY_REPO_PATTERNS = [
            // Individual game repos (now consolidated)
            /^quotle$/i, /^quotletest$/i,
            /^slate$/i, /^slatetest$/i,
            /^rungs$/i, /^rungstest$/i,
            /^wordboxing$/i, /^wordboxingtest$/i,
            /^word-boxing$/i,
            // Landing page repos (now at gameshelf root) - v8.5.0
            /^game-shelf-landing$/i, /^game-shelf-landing-test$/i,
            // Old naming patterns
            /^gameshelf-dev$/i, /^gameshelf-beta$/i,
            // Typos or experiments
            /test$/i
        ];
        
        // Get app type for a repo
        const getAppType = (repoName) => {
            const lower = repoName.toLowerCase();
            if (lower === 'gameshelf' || lower === 'gameshelftest') return 'gameshelf';
            if (lower.includes('command-center') || lower.includes('command') || lower.includes('testplan')) return 'simple';
            if (lower.includes('firebase-functions') || lower.includes('gameshelf-functions')) return 'firebase-functions';
            return 'pwa';
        };
        
        // Check if a file is part of the base package
        const isBaseFile = (filePath, appType) => {
            const pkg = BASE_PACKAGES[appType] || BASE_PACKAGES.pwa;
            const fileName = filePath.split('/').pop();
            const topLevel = filePath.split('/')[0];
            
            // Globally protected â€” never flag as stale in any repo
            if (GLOBALLY_PROTECTED_PATHS.includes(fileName) || GLOBALLY_PROTECTED_PATHS.includes(topLevel)) return true;
            
            // Check required files
            if (pkg.required.includes(fileName) && !filePath.includes('/')) return true;
            
            // Check optional files
            if (pkg.optional.includes(fileName) && !filePath.includes('/')) return true;
            
            // Check folders
            if (pkg.folders.some(f => topLevel === f || filePath.startsWith(f + '/'))) return true;
            
            // For consolidated repos, check subfolder structure
            if (appType === 'gameshelf') {
                const parts = filePath.split('/');
                if (parts.length >= 2) {
                    const subApp = parts[0];
                    if (['quotle', 'slate', 'rungs', 'wordboxing'].includes(subApp)) {
                        // Check if it's a valid file within the sub-app
                        const subPath = parts.slice(1).join('/');
                        return isBaseFile(subPath, 'pwa');
                    }
                }
            }
            
            return false;
        };
        
        // Check if a repo might be legacy/unused
        const isLegacyRepo = (repoName) => {
            // Check against legacy patterns
            for (const pattern of LEGACY_REPO_PATTERNS) {
                if (pattern.test(repoName)) {
                    // But exclude if it's an active configured repo
                    const isConfigured = Object.values(config.apps || {}).some(app => 
                        Object.values(app.repos || {}).some(r => r && r.includes(repoName))
                    );
                    if (!isConfigured) return true;
                }
            }
            return false;
        };
        
        // Scan all repos for stale files
        const scanForStaleFiles = async () => {
            if (!github) {
                await showAlert('GitHub token required', 'Error');
                return;
            }
            
            setScanning(true);
            setScanResults(null);
            setSelectedFiles(new Set());
            setSelectedRepos(new Set());
            
            const results = {
                staleFiles: [],
                legacyRepos: [],
                scannedRepos: 0,
                totalFiles: 0
            };
            
            try {
                // Get all repos
                const repos = availableRepos || [];
                
                for (const repo of repos) {
                    const repoName = repo.name;
                    const repoFullName = repo.fullName || `${repo.owner}/${repoName}`;
                    
                    // Check if this is a legacy repo
                    if (isLegacyRepo(repoName)) {
                        results.legacyRepos.push({
                            name: repoName,
                            fullName: repoFullName,
                            reason: 'Matches legacy pattern - may be obsolete after consolidation',
                            url: `https://github.com/${repoFullName}`
                        });
                    }
                    
                    // Scan repo files
                    try {
                        const files = await github.getRepoFiles(repoFullName);
                        const appType = getAppType(repoName);
                        
                        results.scannedRepos++;
                        results.totalFiles += files.length;
                        
                        for (const file of files) {
                            if (file.type === 'file' && !isBaseFile(file.path, appType)) {
                                results.staleFiles.push({
                                    repo: repoFullName,
                                    repoName: repoName,
                                    path: file.path,
                                    sha: file.sha,
                                    size: file.size,
                                    reason: 'Not part of standard package'
                                });
                            }
                        }
                    } catch (e) {
                        console.log(`Could not scan ${repoName}:`, e.message);
                    }
                }
                
                setScanResults(results);
            } catch (e) {
                await showAlert(`Scan failed: ${e.message}`, 'Error');
            }
            
            setScanning(false);
        };
        
        // Toggle file selection
        const toggleFileSelection = (fileKey) => {
            setSelectedFiles(prev => {
                const newSet = new Set(prev);
                if (newSet.has(fileKey)) {
                    newSet.delete(fileKey);
                } else {
                    newSet.add(fileKey);
                }
                return newSet;
            });
        };
        
        // Toggle repo selection
        const toggleRepoSelection = (repoName) => {
            setSelectedRepos(prev => {
                const newSet = new Set(prev);
                if (newSet.has(repoName)) {
                    newSet.delete(repoName);
                } else {
                    newSet.add(repoName);
                }
                return newSet;
            });
        };
        
        // Select all files
        const selectAllFiles = () => {
            if (!scanResults) return;
            const allKeys = scanResults.staleFiles.map(f => `${f.repo}:${f.path}`);
            setSelectedFiles(new Set(allKeys));
        };
        
        // Clear file selection
        const clearFileSelection = () => {
            setSelectedFiles(new Set());
        };
        
        // Select all repos
        const selectAllRepos = () => {
            if (!scanResults) return;
            const allRepos = scanResults.legacyRepos.map(r => r.fullName);
            setSelectedRepos(new Set(allRepos));
        };
        
        // Clear repo selection
        const clearRepoSelection = () => {
            setSelectedRepos(new Set());
        };
        
        // Delete selected files
        const deleteSelectedFiles = async () => {
            if (selectedFiles.size === 0) return;
            
            // Check for critical files that could break deployments
            const criticalPatterns = ['.github/', 'deploy.yml', 'package.json', 'firebase.json', '.firebaserc'];
            const criticalFiles = [...selectedFiles].filter(fileKey => {
                const path = fileKey.split(':').slice(1).join(':');
                return criticalPatterns.some(p => path.includes(p));
            });
            
            if (criticalFiles.length > 0) {
                const criticalNames = criticalFiles.map(f => f.split(':').slice(1).join(':')).join('\n  â€¢ ');
                const criticalConfirmed = await showConfirm(
                    `âš ï¸ CRITICAL FILES DETECTED âš ï¸\n\nThe following files are essential for CI/CD, builds, or deployments:\n  â€¢ ${criticalNames}\n\nDeleting these will break automated deployments. Are you SURE you want to proceed?`,
                    'ðŸš¨ Critical File Warning'
                );
                if (!criticalConfirmed) return;
            }
            
            const confirmed = await showConfirm(
                `Delete ${selectedFiles.size} file(s)?\n\nFiles can be restored from the History tab.`,
                'Confirm Deletion'
            );
            
            if (!confirmed) return;
            
            setDeleting(true);
            setDeleteProgress({ current: 0, total: selectedFiles.size });
            
            let deleted = 0;
            let failed = 0;
            const deletedItems = [];
            
            for (const fileKey of selectedFiles) {
                const [repo, ...pathParts] = fileKey.split(':');
                const path = pathParts.join(':');
                const file = scanResults.staleFiles.find(f => f.repo === repo && f.path === path);
                
                if (file) {
                    try {
                        // Get the commit SHA before deletion for restoration
                        const [owner, repoName] = repo.split('/');
                        let parentCommitSha = null;
                        try {
                            const commits = await github.request(`/repos/${owner}/${repoName}/commits?path=${encodeURIComponent(path)}&per_page=1`);
                            if (commits && commits.length > 0) {
                                parentCommitSha = commits[0].sha;
                            }
                        } catch (e) {
                            console.log('Could not get commit sha:', e);
                        }
                        
                        await github.deleteFile(repo, path, `Cleanup: Remove stale file ${path}`, file.sha);
                        
                        // Track successful deletion
                        deletedItems.push({
                            repo,
                            repoName: file.repoName,
                            path,
                            sha: file.sha,
                            size: file.size,
                            parentCommitSha,
                            reason: file.reason
                        });
                        
                        deleted++;
                    } catch (e) {
                        console.error(`Failed to delete ${path}:`, e);
                        failed++;
                    }
                }
                
                setDeleteProgress({ current: deleted + failed, total: selectedFiles.size });
            }
            
            // Save to deletion history
            if (deletedItems.length > 0) {
                addToDeletionHistory(deletedItems);
            }
            
            setDeleting(false);
            setSelectedFiles(new Set());
            
            await showAlert(
                `Deleted ${deleted} file(s)${failed > 0 ? `, ${failed} failed` : ''}\n\nFiles saved to History tab for potential restoration.`,
                'Deletion Complete'
            );
            
            // Re-scan to update results
            scanForStaleFiles();
        };
        
        // Restore a deleted file from git history
        const restoreFile = async (historyItem) => {
            if (!github) return;
            
            const confirmed = await showConfirm(
                `Restore "${historyItem.path}" to ${historyItem.repoName}?`,
                'Confirm Restore'
            );
            
            if (!confirmed) return;
            
            setRestoring(true);
            
            try {
                const [owner, repoName] = historyItem.repo.split('/');
                
                // Try to get the file content from the commit before deletion
                let content = null;
                
                if (historyItem.parentCommitSha) {
                    try {
                        // Get file content at the parent commit
                        const fileData = await github.request(
                            `/repos/${owner}/${repoName}/contents/${encodeURIComponent(historyItem.path)}?ref=${historyItem.parentCommitSha}`
                        );
                        if (fileData && fileData.content) {
                            content = fileData.content; // Already base64 encoded
                        }
                    } catch (e) {
                        console.log('Could not get file from parent commit:', e);
                    }
                }
                
                // Fallback: try to get from any commit in history
                if (!content) {
                    try {
                        const commits = await github.request(
                            `/repos/${owner}/${repoName}/commits?path=${encodeURIComponent(historyItem.path)}&per_page=5`
                        );
                        for (const commit of commits) {
                            try {
                                const fileData = await github.request(
                                    `/repos/${owner}/${repoName}/contents/${encodeURIComponent(historyItem.path)}?ref=${commit.sha}`
                                );
                                if (fileData && fileData.content) {
                                    content = fileData.content;
                                    break;
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                    } catch (e) {
                        console.log('Could not search commit history:', e);
                    }
                }
                
                if (!content) {
                    throw new Error('Could not find file content in git history');
                }
                
                // Restore the file
                await github.request(`/repos/${owner}/${repoName}/contents/${historyItem.path}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Restore: ${historyItem.path}`,
                        content: content.replace(/\n/g, ''), // Remove any newlines in base64
                        committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                    })
                });
                
                // Remove from history
                removeFromHistory(historyItem.id);
                
                await showAlert(`Successfully restored "${historyItem.path}"`, 'Restore Complete');
                
            } catch (e) {
                console.error('Restore failed:', e);
                await showAlert(`Failed to restore file: ${e.message}`, 'Restore Failed');
            }
            
            setRestoring(false);
        };
        
        // Delete selected repos
        const deleteSelectedRepos = async () => {
            if (selectedRepos.size === 0) return;
            
            const repoList = Array.from(selectedRepos).join('\nâ€¢ ');
            const confirmed = await showConfirm(
                `âš ï¸ DELETE ${selectedRepos.size} REPOSITORY(S)?\n\nâ€¢ ${repoList}\n\nThis will PERMANENTLY delete these repositories and all their contents!\n\nThis action CANNOT be undone.`,
                'ðŸš¨ Confirm Repository Deletion'
            );
            
            if (!confirmed) return;
            
            // Double confirm for repos
            const doubleConfirmed = await showConfirm(
                `Are you ABSOLUTELY SURE?\n\nType the number of repos to delete: ${selectedRepos.size}`,
                'Final Confirmation'
            );
            
            if (!doubleConfirmed) return;
            
            setDeleting(true);
            setDeleteProgress({ current: 0, total: selectedRepos.size });
            
            let deleted = 0;
            let failed = 0;
            
            for (const repoFullName of selectedRepos) {
                try {
                    await github.deleteRepo(repoFullName);
                    deleted++;
                } catch (e) {
                    console.error(`Failed to delete repo ${repoFullName}:`, e);
                    failed++;
                }
                
                setDeleteProgress({ current: deleted + failed, total: selectedRepos.size });
            }
            
            setDeleting(false);
            setSelectedRepos(new Set());
            
            await showAlert(
                `Deleted ${deleted} repo(s)${failed > 0 ? `, ${failed} failed` : ''}`,
                'Deletion Complete'
            );
            
            // Re-scan
            scanForStaleFiles();
        };
        
        // Format file size
        const formatSize = (bytes) => {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
        };
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        <Icons.Trash /> Repository Cleanup
                    </h2>
                    {activeTab !== 'reset' && (
                        <button
                            onClick={scanForStaleFiles}
                            disabled={scanning || !github}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                        >
                            {scanning ? (
                                <><Icons.Refresh className="animate-spin" /> Scanning...</>
                            ) : (
                                <><Icons.Search /> Scan Repositories</>
                            )}
                        </button>
                    )}
                </div>
                
                {!github && (
                    <div className="p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                        âš ï¸ GitHub token required for cleanup operations
                    </div>
                )}
                
                {/* Tab Navigation */}
                <div className="flex gap-2 border-b border-slate-700 pb-2">
                    {[
                        { id: 'files', label: `ðŸ“„ Stale Files ${scanResults ? `(${scanResults.staleFiles.length})` : ''}` },
                        { id: 'repos', label: `ðŸ“¦ Legacy Repos ${scanResults ? `(${scanResults.legacyRepos.length})` : ''}` },
                        { id: 'reset', label: 'ðŸ”„ Repo Reset' },
                        { id: 'history', label: `âª History ${deletionHistory.length > 0 ? `(${deletionHistory.length})` : ''}` }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                                activeTab === tab.id 
                                    ? 'bg-slate-700 text-white' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Scan Results Summary */}
                {scanResults && (
                    <div className="grid grid-cols-4 gap-4">
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-indigo-400">{scanResults.scannedRepos}</div>
                            <div className="text-xs text-slate-500">Repos Scanned</div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-slate-400">{scanResults.totalFiles}</div>
                            <div className="text-xs text-slate-500">Total Files</div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-amber-400">{scanResults.staleFiles.length}</div>
                            <div className="text-xs text-slate-500">Stale Files</div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-red-400">{scanResults.legacyRepos.length}</div>
                            <div className="text-xs text-slate-500">Legacy Repos</div>
                        </div>
                    </div>
                )}
                
                {/* Stale Files Tab */}
                {activeTab === 'files' && (
                    <div className="space-y-4">
                        {scanResults && scanResults.staleFiles.length > 0 && (
                            <>
                                {/* Filter Input */}
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-400">
                                        <Icons.Search />
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="Filter by filename or repo..."
                                        value={fileFilter}
                                        onChange={(e) => setFileFilter(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-10 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                    />
                                    {fileFilter && (
                                        <button
                                            onClick={() => setFileFilter('')}
                                            className="absolute inset-y-0 right-3 flex items-center text-slate-400 hover:text-white"
                                        >
                                            <Icons.X />
                                        </button>
                                    )}
                                </div>
                                
                                {/* Selection Controls */}
                                {(() => {
                                    const staleFiles = scanResults.staleFiles;
                                    const filter = fileFilter.toLowerCase().trim();
                                    const filteredFiles = filter 
                                        ? staleFiles.filter(f => 
                                            f.path.toLowerCase().includes(filter) || 
                                            f.repoName.toLowerCase().includes(filter))
                                        : staleFiles;
                                    
                                    return (
                                        <>
                                            <div className="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                                                <div className="flex items-center gap-4">
                                                    <span className="text-sm text-slate-400">
                                                        {selectedFiles.size} selected â€¢ {filteredFiles.length} of {staleFiles.length} shown
                                                    </span>
                                                    <button
                                                        onClick={() => {
                                                            const newSelected = new Set(selectedFiles);
                                                            filteredFiles.forEach(f => newSelected.add(`${f.repo}:${f.path}`));
                                                            setSelectedFiles(newSelected);
                                                        }}
                                                        className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                                    >
                                                        {filter ? 'Select Filtered' : 'Select All'}
                                                    </button>
                                                    <button
                                                        onClick={clearFileSelection}
                                                        className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                                    >
                                                        Clear
                                                    </button>
                                                </div>
                                                <button
                                                    onClick={deleteSelectedFiles}
                                                    disabled={selectedFiles.size === 0 || deleting}
                                                    className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                                                >
                                                    {deleting ? (
                                                        <><Icons.Refresh className="animate-spin" /> Deleting {deleteProgress.current}/{deleteProgress.total}</>
                                                    ) : (
                                                        <><Icons.Trash /> Delete Selected</>
                                                    )}
                                                </button>
                                            </div>
                                            
                                            {/* File List */}
                                            <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                                <div className="max-h-96 overflow-y-auto">
                                                    {filteredFiles.length === 0 ? (
                                                        <div className="text-center py-8 text-slate-500">
                                                            No files match "{fileFilter}"
                                                        </div>
                                                    ) : (
                                                        filteredFiles.map((file, idx) => {
                                                            const fileKey = `${file.repo}:${file.path}`;
                                                            const isSelected = selectedFiles.has(fileKey);
                                                            return (
                                                                <div
                                                                    key={fileKey}
                                                                    className={`flex items-center gap-3 p-3 border-b border-slate-700 last:border-0 hover:bg-slate-700/50 cursor-pointer ${
                                                                        isSelected ? 'bg-indigo-900/30' : ''
                                                                    }`}
                                                                    onClick={() => toggleFileSelection(fileKey)}
                                                                >
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={isSelected}
                                                                        onChange={() => {}}
                                                                        className="w-4 h-4 rounded"
                                                                    />
                                                                    <Icons.File />
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="text-sm font-medium truncate">{file.path}</div>
                                                                        <div className="text-xs text-slate-500">
                                                                            {file.repoName} â€¢ {formatSize(file.size || 0)}
                                                                        </div>
                                                                    </div>
                                                                    <span className="text-xs text-amber-400 bg-amber-900/30 px-2 py-1 rounded">
                                                                        {file.reason}
                                                                    </span>
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            </div>
                                        </>
                                    );
                                })()}
                            </>
                        )}
                        
                        {scanResults && scanResults.staleFiles.length === 0 && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">âœ¨</div>
                                <div>No stale files found - repositories are clean!</div>
                            </div>
                        )}
                        
                        {!scanResults && !scanning && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">ðŸ”</div>
                                <div>Click "Scan Repositories" to find stale files</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Legacy Repos Tab */}
                {activeTab === 'repos' && (
                    <div className="space-y-4">
                        {scanResults && scanResults.legacyRepos.length > 0 && (
                            <>
                                {/* Selection Controls */}
                                <div className="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                                    <div className="flex items-center gap-4">
                                        <span className="text-sm text-slate-400">
                                            {selectedRepos.size} of {scanResults.legacyRepos.length} selected
                                        </span>
                                        <button
                                            onClick={selectAllRepos}
                                            className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                        >
                                            Select All
                                        </button>
                                        <button
                                            onClick={clearRepoSelection}
                                            className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                        >
                                            Clear
                                        </button>
                                    </div>
                                    <button
                                        onClick={deleteSelectedRepos}
                                        disabled={selectedRepos.size === 0 || deleting}
                                        className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {deleting ? (
                                            <><Icons.Refresh className="animate-spin" /> Deleting {deleteProgress.current}/{deleteProgress.total}</>
                                        ) : (
                                            <><Icons.Trash /> Delete Selected Repos</>
                                        )}
                                    </button>
                                </div>
                                
                                {/* Warning */}
                                <div className="p-4 bg-red-900/30 border border-red-700 rounded-lg text-sm">
                                    <strong>âš ï¸ Warning:</strong> Deleting repositories is permanent and cannot be undone. 
                                    Make sure you have backups of any important data before proceeding.
                                </div>
                                
                                {/* Repo List */}
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-96 overflow-y-auto">
                                        {scanResults.legacyRepos.map((repo) => {
                                            const isSelected = selectedRepos.has(repo.fullName);
                                            return (
                                                <div
                                                    key={repo.fullName}
                                                    className={`flex items-center gap-3 p-4 border-b border-slate-700 last:border-0 hover:bg-slate-700/50 cursor-pointer ${
                                                        isSelected ? 'bg-red-900/20' : ''
                                                    }`}
                                                    onClick={() => toggleRepoSelection(repo.fullName)}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={isSelected}
                                                        onChange={() => {}}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <Icons.Folder />
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-medium">{repo.name}</div>
                                                        <div className="text-xs text-slate-500">{repo.fullName}</div>
                                                    </div>
                                                    <span className="text-xs text-red-400 bg-red-900/30 px-2 py-1 rounded max-w-xs truncate">
                                                        {repo.reason}
                                                    </span>
                                                    <a
                                                        href={repo.url}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                                    >
                                                        View
                                                    </a>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {scanResults && scanResults.legacyRepos.length === 0 && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">âœ¨</div>
                                <div>No legacy repositories found</div>
                            </div>
                        )}
                        
                        {!scanResults && !scanning && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">ðŸ”</div>
                                <div>Click "Scan Repositories" to identify legacy repos</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Repo Reset Tab */}
                {activeTab === 'reset' && (
                    <RepoResetPanel apps={apps} github={github} showAlert={showAlert} showConfirm={showConfirm} />
                )}
                    
                
                {/* History Tab - Restore deleted files */}
                {activeTab === 'history' && (
                    <div className="space-y-4">
                        {deletionHistory.length > 0 && (
                            <>
                                {/* History Controls */}
                                <div className="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                                    <span className="text-sm text-slate-400">
                                        {deletionHistory.length} deleted file(s) in history
                                    </span>
                                    <button
                                        onClick={clearHistory}
                                        className="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded"
                                    >
                                        Clear History
                                    </button>
                                </div>
                                
                                {/* Info banner */}
                                <div className="p-4 bg-blue-900/30 border border-blue-700 rounded-lg text-sm">
                                    <strong>ðŸ’¡ Restore Files:</strong> Files can be restored from Git history. 
                                    Click "Restore" to recover a deleted file to its original location.
                                </div>
                                
                                {/* Deletion History List */}
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-96 overflow-y-auto">
                                        {deletionHistory.map((item) => (
                                            <div
                                                key={item.id}
                                                className="flex items-center gap-3 p-3 border-b border-slate-700 last:border-0 hover:bg-slate-700/50"
                                            >
                                                <Icons.File />
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-sm font-medium truncate">{item.path}</div>
                                                    <div className="text-xs text-slate-500">
                                                        {item.repoName} â€¢ Deleted {new Date(item.deletedAt).toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => restoreFile(item)}
                                                        disabled={restoring}
                                                        className="text-xs px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded transition-colors disabled:opacity-50"
                                                    >
                                                        {restoring ? '...' : 'âª Restore'}
                                                    </button>
                                                    <button
                                                        onClick={() => removeFromHistory(item.id)}
                                                        className="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                                        title="Remove from history (does not restore)"
                                                    >
                                                        âœ•
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {deletionHistory.length === 0 && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">ðŸ“­</div>
                                <div>No deletion history</div>
                                <div className="text-xs mt-2">Deleted files will appear here for restoration</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Base Package Reference */}
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <h3 className="font-semibold mb-4">ðŸ“‹ Base Package Reference</h3>
                    <p className="text-xs text-slate-400 mb-4">
                        Files outside these patterns are flagged as potentially stale:
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="p-3 bg-slate-900 rounded">
                            <div className="font-medium text-sm mb-2">PWA Apps</div>
                            <div className="text-xs text-slate-400 space-y-1">
                                <div>â€¢ index.html, sw.js, manifest.json</div>
                                <div>â€¢ icons/ folder</div>
                                <div>â€¢ RELEASE_NOTES.txt (optional)</div>
                            </div>
                        </div>
                        <div className="p-3 bg-slate-900 rounded">
                            <div className="font-medium text-sm mb-2">Game Shelf (Consolidated)</div>
                            <div className="text-xs text-slate-400 space-y-1">
                                <div>â€¢ Root PWA files + manifest-test.json</div>
                                <div>â€¢ icons/, icons-test/ folders</div>
                                <div>â€¢ quotle/, slate/, rungs/, wordboxing/</div>
                            </div>
                        </div>
                        <div className="p-3 bg-slate-900 rounded">
                            <div className="font-medium text-sm mb-2">Simple Apps</div>
                            <div className="text-xs text-slate-400 space-y-1">
                                <div>â€¢ index.html only</div>
                                <div>â€¢ README.md (optional)</div>
                                <div>â€¢ Command Center, Test Plan</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // FIREBASE VIEW
    // =========================================================================
    

    // =========================================================================
    // VIEW: Integrations
    // =========================================================================

    function IntegrationsView({ showAlert, showConfirm, showPrompt }) {
        const [activeTab, setActiveTab] = React.useState('overview');
        const [integrationStatus, setIntegrationStatus] = React.useState({
            firebase: { status: 'unknown', lastCheck: null },
            claude: { status: 'unknown', lastCheck: null },
            stripe: { status: 'unknown', lastCheck: null },
            goody: { status: 'unknown', lastCheck: null }
        });
        const [functionLogs, setFunctionLogs] = React.useState([]);
        const [hintAnalytics, setHintAnalytics] = React.useState(null);
        const [hintUsage, setHintUsage] = React.useState(null);
        const [purchases, setPurchases] = React.useState(null);
        const [loading, setLoading] = React.useState({});
        const [testResults, setTestResults] = React.useState({});
        
        // Firebase Functions endpoint
        const FUNCTIONS_BASE = 'https://us-central1-word-boxing.cloudfunctions.net';
        
        // Integration definitions
        const integrations = {
            firebase: {
                id: 'firebase',
                name: 'Firebase',
                icon: 'ðŸ”¥',
                description: 'Realtime Database, Auth, Cloud Functions',
                functions: ['getHint', 'getHintUsage', 'createCoinCheckout', 'stripeWebhook', 'getGiftOptions', 'redeemGift', 'getGiftHistory'],
                configRequired: ['apiKey', 'projectId', 'databaseURL'],
                docsUrl: 'https://console.firebase.google.com/project/word-boxing'
            },
            claude: {
                id: 'claude',
                name: 'Claude API',
                icon: 'ðŸ¤–',
                description: 'Anthropic AI for hint generation',
                functions: ['getHint'],
                configRequired: ['ANTHROPIC_API_KEY'],
                docsUrl: 'https://console.anthropic.com/'
            },
            stripe: {
                id: 'stripe',
                name: 'Stripe',
                icon: 'ðŸ’³',
                description: 'Payment processing for coins',
                functions: ['createCoinCheckout', 'stripeWebhook'],
                configRequired: ['STRIPE_SECRET_KEY', 'STRIPE_WEBHOOK_SECRET'],
                docsUrl: 'https://dashboard.stripe.com/'
            },
            goody: {
                id: 'goody',
                name: 'Goody',
                icon: 'ðŸŽ',
                description: 'Gift card redemption (coming soon)',
                functions: ['getGiftOptions', 'redeemGift', 'getGiftHistory'],
                configRequired: ['GOODY_API_KEY'],
                docsUrl: 'https://www.ongoody.com/',
                comingSoon: true
            }
        };
        
        // Check Firebase connection
        const checkFirebase = async () => {
            setLoading(prev => ({ ...prev, firebase: true }));
            try {
                if (!firebaseDb) throw new Error('Firebase not initialized');
                
                // Test read from a public path
                const testRef = firebaseDb.ref('gameshelf-public');
                await testRef.once('value');
                
                setIntegrationStatus(prev => ({
                    ...prev,
                    firebase: { status: 'connected', lastCheck: new Date().toISOString() }
                }));
                setTestResults(prev => ({ ...prev, firebase: { success: true, message: 'Connected to Firebase Realtime Database' } }));
            } catch (e) {
                setIntegrationStatus(prev => ({
                    ...prev,
                    firebase: { status: 'error', lastCheck: new Date().toISOString(), error: e.message }
                }));
                setTestResults(prev => ({ ...prev, firebase: { success: false, message: e.message } }));
            }
            setLoading(prev => ({ ...prev, firebase: false }));
        };
        
        // Check Claude API (via Firebase Function)
        const checkClaude = async () => {
            setLoading(prev => ({ ...prev, claude: true }));
            try {
                // We can't directly test Claude API, but we can check if the function exists
                // by calling getHintUsage which doesn't require auth
                const response = await fetch(`${FUNCTIONS_BASE}/getHintUsage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { userId: 'test-connection' } })
                });
                
                if (response.ok) {
                    setIntegrationStatus(prev => ({
                        ...prev,
                        claude: { status: 'connected', lastCheck: new Date().toISOString() }
                    }));
                    setTestResults(prev => ({ ...prev, claude: { success: true, message: 'Firebase Functions responding (Claude API configured)' } }));
                } else {
                    throw new Error(`Function returned ${response.status}`);
                }
            } catch (e) {
                setIntegrationStatus(prev => ({
                    ...prev,
                    claude: { status: 'error', lastCheck: new Date().toISOString(), error: e.message }
                }));
                setTestResults(prev => ({ ...prev, claude: { success: false, message: e.message } }));
            }
            setLoading(prev => ({ ...prev, claude: false }));
        };
        
        // Check Stripe (via createCoinCheckout health)
        const checkStripe = async () => {
            setLoading(prev => ({ ...prev, stripe: true }));
            try {
                // Check if we have any purchase records in Firebase
                if (firebaseDb) {
                    const purchasesRef = firebaseDb.ref('purchases');
                    const snapshot = await purchasesRef.limitToLast(5).once('value');
                    const data = snapshot.val();
                    if (data) {
                        setPurchases(data);
                        setIntegrationStatus(prev => ({
                            ...prev,
                            stripe: { status: 'connected', lastCheck: new Date().toISOString() }
                        }));
                        setTestResults(prev => ({ ...prev, stripe: { success: true, message: 'Stripe integration active (purchases found)' } }));
                    } else {
                        setIntegrationStatus(prev => ({
                            ...prev,
                            stripe: { status: 'connected', lastCheck: new Date().toISOString() }
                        }));
                        setTestResults(prev => ({ ...prev, stripe: { success: true, message: 'Stripe configured (no purchases yet)' } }));
                    }
                }
            } catch (e) {
                setIntegrationStatus(prev => ({
                    ...prev,
                    stripe: { status: 'error', lastCheck: new Date().toISOString(), error: e.message }
                }));
                setTestResults(prev => ({ ...prev, stripe: { success: false, message: e.message } }));
            }
            setLoading(prev => ({ ...prev, stripe: false }));
        };
        
        // Load hint analytics
        const loadHintAnalytics = async () => {
            if (!firebaseDb) return;
            setLoading(prev => ({ ...prev, analytics: true }));
            try {
                const analyticsRef = firebaseDb.ref('hint-analytics');
                const snapshot = await analyticsRef.limitToLast(50).once('value');
                setHintAnalytics(snapshot.val());
                
                const usageRef = firebaseDb.ref('hint-usage');
                const usageSnapshot = await usageRef.limitToLast(20).once('value');
                setHintUsage(usageSnapshot.val());
            } catch (e) {
                console.error('Failed to load hint analytics:', e);
            }
            setLoading(prev => ({ ...prev, analytics: false }));
        };
        
        // Test all integrations
        const testAllIntegrations = async () => {
            await checkFirebase();
            await checkClaude();
            await checkStripe();
            await loadHintAnalytics();
        };
        
        // Initial load
        React.useEffect(() => {
            testAllIntegrations();
        }, []);
        
        // Status indicator component
        const StatusIndicator = ({ status }) => {
            const colors = {
                connected: 'bg-green-500',
                error: 'bg-red-500',
                unknown: 'bg-slate-500',
                loading: 'bg-yellow-500 animate-pulse'
            };
            return (
                <div className={`w-3 h-3 rounded-full ${colors[status] || colors.unknown}`} />
            );
        };
        
        // Integration card component
        const IntegrationCard = ({ integration }) => {
            const status = integrationStatus[integration.id];
            const isLoading = loading[integration.id];
            const result = testResults[integration.id];
            
            return (
                <div className={`bg-slate-800 rounded-xl p-5 border ${
                    status?.status === 'connected' ? 'border-green-700' : 
                    status?.status === 'error' ? 'border-red-700' : 'border-slate-700'
                }`}>
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{integration.icon}</span>
                            <div>
                                <h3 className="font-semibold">{integration.name}</h3>
                                <p className="text-xs text-slate-400">{integration.description}</p>
                            </div>
                        </div>
                        <StatusIndicator status={isLoading ? 'loading' : status?.status} />
                    </div>
                    
                    {integration.comingSoon ? (
                        <div className="text-sm text-amber-400 bg-amber-900/30 rounded px-3 py-2">
                            ðŸš§ Coming Soon
                        </div>
                    ) : (
                        <>
                            {result && (
                                <div className={`text-xs mb-3 p-2 rounded ${
                                    result.success ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'
                                }`}>
                                    {result.success ? 'âœ“' : 'âœ—'} {result.message}
                                </div>
                            )}
                            
                            <div className="text-xs text-slate-500 mb-3">
                                Functions: {integration.functions.join(', ')}
                            </div>
                            
                            <div className="flex gap-2">
                                <a 
                                    href={integration.docsUrl} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                >
                                    ðŸ“„ Console
                                </a>
                                <button
                                    onClick={() => {
                                        if (integration.id === 'firebase') checkFirebase();
                                        else if (integration.id === 'claude') checkClaude();
                                        else if (integration.id === 'stripe') checkStripe();
                                    }}
                                    disabled={isLoading}
                                    className="text-xs px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded transition-colors disabled:opacity-50"
                                >
                                    {isLoading ? '...' : 'ðŸ”„ Test'}
                                </button>
                            </div>
                        </>
                    )}
                    
                    {status?.lastCheck && (
                        <div className="text-xs text-slate-500 mt-3">
                            Last checked: {new Date(status.lastCheck).toLocaleTimeString()}
                        </div>
                    )}
                </div>
            );
        };
        
        // Logs panel
        const LogsPanel = () => {
            const allLogs = [];
            
            // Convert hint analytics to log entries
            if (hintAnalytics) {
                Object.entries(hintAnalytics).forEach(([key, value]) => {
                    if (typeof value === 'object' && value.timestamp) {
                        allLogs.push({
                            id: key,
                            type: 'hint',
                            timestamp: value.timestamp,
                            data: value
                        });
                    }
                });
            }
            
            // Sort by timestamp descending
            allLogs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="font-semibold">ðŸ“Š Recent Activity</h3>
                        <button
                            onClick={loadHintAnalytics}
                            disabled={loading.analytics}
                            className="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded"
                        >
                            {loading.analytics ? '...' : 'ðŸ”„ Refresh'}
                        </button>
                    </div>
                    
                    {allLogs.length === 0 ? (
                        <div className="text-sm text-slate-500 text-center py-8">
                            No recent activity logs
                        </div>
                    ) : (
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {allLogs.slice(0, 20).map(log => (
                                <div key={log.id} className="text-xs p-2 bg-slate-900 rounded">
                                    <div className="flex items-center justify-between mb-1">
                                        <span className={`font-medium ${
                                            log.type === 'hint' ? 'text-purple-400' :
                                            log.type === 'purchase' ? 'text-green-400' : 'text-slate-400'
                                        }`}>
                                            {log.type === 'hint' ? 'ðŸ¤– Hint Request' : 
                                             log.type === 'purchase' ? 'ðŸ’³ Purchase' : 'ðŸ“ Log'}
                                        </span>
                                        <span className="text-slate-500">
                                            {log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A'}
                                        </span>
                                    </div>
                                    {log.data && (
                                        <div className="text-slate-400 truncate">
                                            {log.data.game && `Game: ${log.data.game}`}
                                            {log.data.level && ` | Level: ${log.data.level}`}
                                            {log.data.userId && ` | User: ${log.data.userId.substring(0, 8)}...`}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        // Usage stats panel
        const UsageStatsPanel = () => {
            const userCount = hintUsage ? Object.keys(hintUsage).length : 0;
            let totalRequests = 0;
            let todayRequests = 0;
            const today = new Date().toDateString();
            
            if (hintUsage) {
                Object.values(hintUsage).forEach(user => {
                    if (user.requests && Array.isArray(user.requests)) {
                        totalRequests += user.requests.length;
                        user.requests.forEach(ts => {
                            if (new Date(ts).toDateString() === today) {
                                todayRequests++;
                            }
                        });
                    }
                });
            }
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <h3 className="font-semibold mb-4">ðŸ“ˆ Hint Usage Stats</h3>
                    
                    <div className="grid grid-cols-3 gap-4">
                        <div className="text-center p-3 bg-slate-900 rounded-lg">
                            <div className="text-2xl font-bold text-indigo-400">{userCount}</div>
                            <div className="text-xs text-slate-500">Total Users</div>
                        </div>
                        <div className="text-center p-3 bg-slate-900 rounded-lg">
                            <div className="text-2xl font-bold text-green-400">{totalRequests}</div>
                            <div className="text-xs text-slate-500">Total Hints</div>
                        </div>
                        <div className="text-center p-3 bg-slate-900 rounded-lg">
                            <div className="text-2xl font-bold text-amber-400">{todayRequests}</div>
                            <div className="text-xs text-slate-500">Today</div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Environment variables panel
        const EnvVarsPanel = () => {
            const envVars = [
                { name: 'ANTHROPIC_API_KEY', service: 'Claude', required: true, hint: 'sk-ant-...' },
                { name: 'STRIPE_SECRET_KEY', service: 'Stripe', required: true, hint: 'sk_live_... or sk_test_...' },
                { name: 'STRIPE_WEBHOOK_SECRET', service: 'Stripe', required: true, hint: 'whsec_...' },
                { name: 'GOODY_API_KEY', service: 'Goody', required: false, hint: 'Optional' }
            ];
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <h3 className="font-semibold mb-4">ðŸ” Environment Variables</h3>
                    <p className="text-xs text-slate-400 mb-4">
                        Set in Firebase Functions: <code className="bg-slate-900 px-1 rounded">~/Documents/.../Games/firebase-functions/functions/.env</code>
                    </p>
                    
                    <div className="space-y-2">
                        {envVars.map(v => (
                            <div key={v.name} className="flex items-center justify-between p-2 bg-slate-900 rounded text-sm">
                                <div>
                                    <code className="text-indigo-400">{v.name}</code>
                                    <span className="text-xs text-slate-500 ml-2">({v.service})</span>
                                </div>
                                <span className={`text-xs px-2 py-0.5 rounded ${
                                    v.required ? 'bg-red-900/50 text-red-400' : 'bg-slate-700 text-slate-400'
                                }`}>
                                    {v.required ? 'Required' : 'Optional'}
                                </span>
                            </div>
                        ))}
                    </div>
                    
                    <div className="mt-4 p-3 bg-slate-900 rounded">
                        <div className="text-xs text-slate-400 mb-2">Deploy functions after updating .env:</div>
                        <code className="text-xs text-green-400 break-all">
                            cd ~/Documents/.../Games/firebase-functions && firebase deploy --only functions
                        </code>
                    </div>
                </div>
            );
        };
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        <Icons.Zap /> Integrations
                    </h2>
                    <button
                        onClick={testAllIntegrations}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors"
                    >
                        ðŸ”„ Test All
                    </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex gap-2 border-b border-slate-700 pb-2">
                    {[
                        { id: 'overview', label: 'ðŸ“Š Overview' },
                        { id: 'logs', label: 'ðŸ“ Logs' },
                        { id: 'config', label: 'âš™ï¸ Configuration' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                                activeTab === tab.id 
                                    ? 'bg-slate-700 text-white' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6">
                        {/* Integration Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {Object.values(integrations).map(integration => (
                                <IntegrationCard key={integration.id} integration={integration} />
                            ))}
                        </div>
                        
                        {/* Hint Usage Stats */}
                        <UsageStatsPanel />
                    </div>
                )}
                
                {/* Logs Tab */}
                {activeTab === 'logs' && (
                    <div className="space-y-6">
                        <LogsPanel />
                        
                        {/* Hint Usage by User */}
                        {hintUsage && (
                            <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                <h3 className="font-semibold mb-4">ðŸ‘¥ Hint Usage by User</h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {Object.entries(hintUsage).map(([userId, data]) => (
                                        <div key={userId} className="flex items-center justify-between p-2 bg-slate-900 rounded text-sm">
                                            <code className="text-xs text-slate-400">{userId.substring(0, 12)}...</code>
                                            <span className="text-indigo-400">
                                                {data.requests?.length || 0} hints
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Recent Purchases */}
                        {purchases && (
                            <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                <h3 className="font-semibold mb-4">ðŸ’³ Recent Purchases</h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {Object.entries(purchases).slice(0, 10).map(([userId, userPurchases]) => (
                                        <div key={userId} className="p-2 bg-slate-900 rounded">
                                            <code className="text-xs text-slate-400">{userId.substring(0, 12)}...</code>
                                            {Object.entries(userPurchases).map(([purchaseId, purchase]) => (
                                                <div key={purchaseId} className="mt-1 text-xs text-green-400">
                                                    {purchase.coinAmount} coins - ${(purchase.priceCents / 100).toFixed(2)}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Configuration Tab */}
                {activeTab === 'config' && (
                    <div className="space-y-6">
                        <EnvVarsPanel />
                        
                        {/* Firebase Functions List */}
                        <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                            <h3 className="font-semibold mb-4">â˜ï¸ Firebase Cloud Functions</h3>
                            <p className="text-xs text-slate-400 mb-4">
                                Project: <code className="bg-slate-900 px-1 rounded">word-boxing</code> | 
                                Region: <code className="bg-slate-900 px-1 rounded">us-central1</code>
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {[
                                    { name: 'getHint', desc: 'AI hint generation via Claude', type: 'callable' },
                                    { name: 'getHintUsage', desc: 'Check user hint limits', type: 'callable' },
                                    { name: 'createCoinCheckout', desc: 'Stripe checkout session', type: 'callable' },
                                    { name: 'stripeWebhook', desc: 'Handle Stripe events', type: 'http' },
                                    { name: 'getGiftOptions', desc: 'Goody gift tiers', type: 'callable' },
                                    { name: 'redeemGift', desc: 'Redeem coins for gift', type: 'callable' },
                                    { name: 'getGiftHistory', desc: 'Gift redemption history', type: 'callable' }
                                ].map(fn => (
                                    <div key={fn.name} className="p-3 bg-slate-900 rounded">
                                        <div className="flex items-center justify-between">
                                            <code className="text-sm text-indigo-400">{fn.name}</code>
                                            <span className={`text-xs px-2 py-0.5 rounded ${
                                                fn.type === 'http' ? 'bg-amber-900/50 text-amber-400' : 'bg-slate-700 text-slate-400'
                                            }`}>
                                                {fn.type}
                                            </span>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-1">{fn.desc}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Quick Actions */}
                        <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                            <h3 className="font-semibold mb-4">ðŸš€ Quick Actions</h3>
                            <div className="flex flex-wrap gap-3">
                                <a 
                                    href="https://console.firebase.google.com/project/word-boxing/functions"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium transition-colors"
                                >
                                    ðŸ”¥ Firebase Console
                                </a>
                                <a 
                                    href="https://console.firebase.google.com/project/word-boxing/functions/logs"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors"
                                >
                                    ðŸ“‹ Function Logs
                                </a>
                                <a 
                                    href="https://dashboard.stripe.com/test/webhooks"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium transition-colors"
                                >
                                    ðŸ’³ Stripe Webhooks
                                </a>
                                <a 
                                    href="https://console.anthropic.com/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors"
                                >
                                    ðŸ¤– Anthropic Console
                                </a>
                            </div>
                        </div>
                        
                        {/* Deployment Instructions */}
                        <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                            <h3 className="font-semibold mb-4">ðŸ“¦ Deploy Functions</h3>
                            <div className="bg-slate-900 rounded p-4 font-mono text-sm">
                                <div className="text-slate-500"># Navigate to functions directory</div>
                                <div className="text-green-400">cd ~/Documents/Documents\ -\ David\'s\ MacBook\ Air/Games/firebase-functions</div>
                                <div className="text-slate-500 mt-2"># Set project</div>
                                <div className="text-green-400">firebase use word-boxing</div>
                                <div className="text-slate-500 mt-2"># Deploy all functions</div>
                                <div className="text-green-400">firebase deploy --only functions</div>
                                <div className="text-slate-500 mt-2"># Or deploy specific function</div>
                                <div className="text-green-400">firebase deploy --only functions:getHint</div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // CLEANUP VIEW (v7.4.3) - Repo and File Cleanup Management with Rollback
    // =========================================================================
    

    // =========================================================================
    // VIEW: Domains (Porkbun, GoDaddy, Auth Domains, Pages Domains)
    // =========================================================================

    function DomainsView({ apps, config, showAlert, showConfirm }) {
        const [domains, setDomains] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [selectedDomain, setSelectedDomain] = React.useState(null);
        const [dnsRecords, setDnsRecords] = React.useState(null);
        const [loadingDNS, setLoadingDNS] = React.useState(false);
        const [addingRecord, setAddingRecord] = React.useState(false);
        const [newRecord, setNewRecord] = React.useState({ type: 'A', name: '', content: '', ttl: '600' });
        const [wiringDomain, setWiringDomain] = React.useState(null);
        const [wireLog, setWireLog] = React.useState([]);
        const [wireProgress, setWireProgress] = React.useState(false);
        
        // Get the service for the currently selected domain
        const getServiceForDomain = (domain) => {
            return DomainProviderRegistry.getServiceForDomain(domain, domains || []);
        };
        
        // Load domains from all configured providers
        const fetchDomains = async () => {
            setLoading(true);
            setError(null);
            try {
                const allDomains = await DomainProviderRegistry.getAllDomains();
                setDomains(allDomains);
                if (allDomains.length > 0 && !selectedDomain) {
                    setSelectedDomain(allDomains[0].domain);
                }
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        // Load DNS records for selected domain
        const fetchDNS = async (domain) => {
            setLoadingDNS(true);
            try {
                const service = getServiceForDomain(domain);
                if (!service) throw new Error('No provider found for this domain');
                const records = await service.listDNSRecords(domain);
                setDnsRecords(records);
            } catch (e) {
                showAlert(`Failed to load DNS: ${e.message}`, 'error');
            }
            setLoadingDNS(false);
        };
        
        // Fetch on mount
        React.useEffect(() => {
            if (DomainProviderRegistry.getConfigured().length > 0) fetchDomains();
        }, []);
        
        // Fetch DNS when domain changes
        React.useEffect(() => {
            if (selectedDomain) fetchDNS(selectedDomain);
        }, [selectedDomain]);
        
        // Add DNS record
        const handleAddRecord = async () => {
            if (!newRecord.type || !newRecord.content) return;
            setAddingRecord(true);
            try {
                const service = getServiceForDomain(selectedDomain);
                if (!service) throw new Error('No provider found for this domain');
                await service.createDNSRecord(
                    selectedDomain, newRecord.type, newRecord.name, 
                    newRecord.content, parseInt(newRecord.ttl) || 600,
                    newRecord.type === 'MX' ? parseInt(newRecord.prio) || 10 : null
                );
                showAlert('DNS record created', 'success');
                setNewRecord({ type: 'A', name: '', content: '', ttl: '600' });
                await fetchDNS(selectedDomain);
            } catch (e) {
                showAlert(`Failed to create record: ${e.message}`, 'error');
            }
            setAddingRecord(false);
        };
        
        // Delete DNS record
        const handleDeleteRecord = async (recordId, recordDesc) => {
            const confirmed = await showConfirm(`Delete ${recordDesc}?`, 'Delete DNS Record');
            if (!confirmed) return;
            try {
                const service = getServiceForDomain(selectedDomain);
                if (!service) throw new Error('No provider found for this domain');
                // GoDaddy needs all records to do a replace-minus-one
                await service.deleteDNSRecord(selectedDomain, recordId, dnsRecords);
                showAlert('Record deleted', 'success');
                await fetchDNS(selectedDomain);
            } catch (e) {
                showAlert(`Failed to delete: ${e.message}`, 'error');
            }
        };
        
        // Wire domain for GitHub Pages
        const handleWireForGitHubPages = async (domain, repo) => {
            setWireProgress(true);
            setWireLog(['ðŸš€ Starting GitHub Pages configuration...']);
            
            try {
                const service = getServiceForDomain(domain);
                if (!service) throw new Error('No provider found for this domain');
                const domainEntry = (domains || []).find(d => d.domain === domain);
                const providerName = domainEntry?.providerName || 'registrar';
                
                // Step 1: Configure DNS at registrar
                setWireLog(prev => [...prev, `ðŸ“¡ Configuring DNS records at ${providerName}...`]);
                const githubUsername = repo.split('/')[0];
                const dnsResult = await service.configureForGitHubPages(domain, githubUsername);
                dnsResult.log.forEach(l => setWireLog(prev => [...prev, `  ${l}`]));
                setWireLog(prev => [...prev, `âœ… ${dnsResult.recordsCreated} DNS records created`]);
                
                // Step 2: Create CNAME file in repo
                setWireLog(prev => [...prev, 'ðŸ“„ Committing CNAME file to repo...']);
                const github = new GitHubAPI(CC.getGitHubToken());
                await github.createOrUpdateFile(repo, 'CNAME', domain, `Add custom domain CNAME for ${domain}`);
                setWireLog(prev => [...prev, 'âœ… CNAME file committed']);
                
                // Step 3: Update GitHub Pages config
                setWireLog(prev => [...prev, 'âš™ï¸ Updating GitHub Pages configuration...']);
                await github.updatePagesConfig(repo, domain, false);
                setWireLog(prev => [...prev, 'âœ… Custom domain set on GitHub Pages']);
                
                setWireLog(prev => [...prev, '', 'ðŸŽ‰ Domain configuration complete!', `ðŸŒ ${domain} will be live once DNS propagates (5-30 minutes)`, 'ðŸ”’ HTTPS will auto-enable after DNS propagation']);
                
                showAlert(`${domain} configured for GitHub Pages! DNS may take 5-30 minutes to propagate.`, 'success');
                
                // Refresh DNS records view
                await fetchDNS(domain);
            } catch (e) {
                setWireLog(prev => [...prev, `âŒ Error: ${e.message}`]);
                showAlert(`Wiring failed: ${e.message}`, 'error');
            }
            setWireProgress(false);
        };
        
        // Not configured
        if (DomainProviderRegistry.getConfigured().length === 0) {
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex items-center gap-3 mb-6">
                        <span className="text-2xl">ðŸŒ</span>
                        <h1 className="text-2xl font-bold">Domains</h1>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <span className="text-4xl block mb-4">ðŸ”‘</span>
                        <h3 className="text-lg font-semibold mb-2">No Domain Registrars Configured</h3>
                        <p className="text-slate-400 text-sm mb-4">Add API keys for Porkbun, GoDaddy, or both in Settings to manage domains from Command Center.</p>
                        <p className="text-slate-500 text-xs">Configure â†’ Settings â†’ ðŸŒ Domain Registrar</p>
                    </div>
                </div>
            );
        }
        
        // Record type colors
        const typeColors = {
            A: 'bg-blue-600/20 text-blue-400',
            AAAA: 'bg-cyan-600/20 text-cyan-400',
            CNAME: 'bg-green-600/20 text-green-400',
            MX: 'bg-purple-600/20 text-purple-400',
            TXT: 'bg-amber-600/20 text-amber-400',
            NS: 'bg-slate-600/20 text-slate-400',
            SRV: 'bg-pink-600/20 text-pink-400',
            ALIAS: 'bg-emerald-600/20 text-emerald-400',
            CAA: 'bg-orange-600/20 text-orange-400',
        };
        
        // Check if domain is already wired for GitHub Pages
        const isGitHubPagesWired = (records) => {
            if (!records) return false;
            const ghIPs = PorkbunService.GITHUB_PAGES_IPS; // Same IPs regardless of provider
            const aRecords = records.filter(r => r.type === 'A').map(r => r.content);
            const hasGHIPs = ghIPs.every(ip => aRecords.includes(ip));
            const hasCNAME = records.some(r => r.type === 'CNAME' && r.content.includes('.github.io'));
            return hasGHIPs && hasCNAME;
        };
        
        // Find which apps could use this domain (have repos assigned)
        const getAppsWithRepos = () => {
            return Object.entries(apps)
                .filter(([_, a]) => a.testRepo || a.prodRepo)
                .map(([id, a]) => ({ id, ...a }));
        };
        
        return (
            <div className="max-w-6xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                        <span className="text-2xl">ðŸŒ</span>
                        <div>
                            <h1 className="text-2xl font-bold">Domains</h1>
                            <p className="text-slate-400 text-sm">DNS management and GitHub Pages domain wiring</p>
                        </div>
                    </div>
                    <button onClick={fetchDomains} disabled={loading}
                        className="px-3 py-1.5 text-sm bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-40">
                        {loading ? 'â³' : 'ðŸ”„'} Refresh
                    </button>
                </div>
                
                {error && (
                    <div className="bg-red-900/30 border border-red-700 text-red-300 rounded-xl p-4 mb-6 text-sm">
                        âŒ {error}
                    </div>
                )}
                
                {/* Domain Selector */}
                {domains && domains.length > 0 && (
                    <div className="flex gap-2 mb-6 flex-wrap">
                        {domains.map(d => (
                            <button key={d.domain}
                                onClick={() => setSelectedDomain(d.domain)}
                                className={`px-4 py-2 rounded-lg text-sm font-mono transition-all flex items-center gap-2 ${
                                    selectedDomain === d.domain 
                                        ? 'bg-indigo-600 text-white ring-1 ring-indigo-400' 
                                        : 'bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700'
                                }`}>
                                <span>{d.providerIcon || 'ðŸŒ'}</span>
                                <span>{d.domain}</span>
                            </button>
                        ))}
                    </div>
                )}
                
                {loading && <div className="text-center text-slate-400 py-12">â³ Loading domains...</div>}
                
                {/* DNS Records Panel */}
                {selectedDomain && !loading && (
                    <div className="space-y-6">
                        {/* Domain Info + Quick Actions */}
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-semibold flex items-center gap-2">
                                    ðŸ“¡ DNS Records â€” <span className="font-mono text-indigo-300">{selectedDomain}</span>
                                </h3>
                                <div className="flex gap-2">
                                    {!isGitHubPagesWired(dnsRecords) && (
                                        <button onClick={() => setWiringDomain(selectedDomain)}
                                            className="text-xs px-3 py-1.5 bg-green-600 rounded hover:bg-green-500 font-medium">
                                            âš¡ Wire for GitHub Pages
                                        </button>
                                    )}
                                    {isGitHubPagesWired(dnsRecords) && (
                                        <span className="text-xs px-3 py-1.5 bg-green-900/30 text-green-400 rounded border border-green-700/30">
                                            âœ… GitHub Pages configured
                                        </span>
                                    )}
                                    <button onClick={() => fetchDNS(selectedDomain)} disabled={loadingDNS}
                                        className="text-xs px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-40">
                                        {loadingDNS ? 'â³' : 'ðŸ”„'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* DNS Records Table */}
                            {loadingDNS && <div className="text-center text-slate-400 py-8">â³ Loading DNS records...</div>}
                            
                            {dnsRecords && !loadingDNS && (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700 text-left">
                                                <th className="py-2 px-3 text-slate-400 font-medium w-20">Type</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium">Name</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium">Content</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium w-16">TTL</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium w-16">Prio</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium w-12"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dnsRecords.map(record => (
                                                <tr key={record.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-2 px-3">
                                                        <span className={`text-xs px-2 py-0.5 rounded font-medium ${typeColors[record.type] || 'bg-slate-600/20 text-slate-400'}`}>
                                                            {record.type}
                                                        </span>
                                                    </td>
                                                    <td className="py-2 px-3 font-mono text-slate-300 text-xs">{record.name || '@'}</td>
                                                    <td className="py-2 px-3 font-mono text-slate-200 text-xs break-all max-w-xs">{record.content}</td>
                                                    <td className="py-2 px-3 text-xs text-slate-500">{record.ttl}</td>
                                                    <td className="py-2 px-3 text-xs text-slate-500">{record.prio || 'â€”'}</td>
                                                    <td className="py-2 px-3">
                                                        <button onClick={() => handleDeleteRecord(record.id, `${record.type} ${record.name}`)}
                                                            className="text-red-500 hover:text-red-400 text-xs" title="Delete record">
                                                            ðŸ—‘ï¸
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {dnsRecords.length === 0 && (
                                                <tr><td colSpan="6" className="py-8 text-center text-slate-500">No DNS records found</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                        
                        {/* Add DNS Record */}
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                            <h3 className="font-semibold mb-4 flex items-center gap-2">âž• Add DNS Record</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Type</label>
                                    <select value={newRecord.type} onChange={e => setNewRecord({...newRecord, type: e.target.value})}
                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm">
                                        {['A', 'AAAA', 'CNAME', 'MX', 'TXT', 'NS', 'SRV', 'CAA', 'ALIAS'].map(t => (
                                            <option key={t} value={t}>{t}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Name <span className="text-slate-600">(subdomain)</span></label>
                                    <input value={newRecord.name} onChange={e => setNewRecord({...newRecord, name: e.target.value})}
                                        placeholder="@ or www" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-slate-400 block mb-1">Content</label>
                                    <input value={newRecord.content} onChange={e => setNewRecord({...newRecord, content: e.target.value})}
                                        placeholder="1.2.3.4 or target.example.com" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                                <div className="flex items-end gap-2">
                                    <div className="flex-1">
                                        <label className="text-xs text-slate-400 block mb-1">TTL</label>
                                        <input value={newRecord.ttl} onChange={e => setNewRecord({...newRecord, ttl: e.target.value})}
                                            className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                    </div>
                                    <button onClick={handleAddRecord} disabled={addingRecord || !newRecord.content}
                                        className="px-4 py-2 bg-indigo-600 rounded text-sm hover:bg-indigo-500 disabled:opacity-40 whitespace-nowrap">
                                        {addingRecord ? 'â³' : 'âž•'} Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {/* Wire for GitHub Pages Modal */}
                        {wiringDomain && (
                            <div className="bg-slate-800 rounded-xl border border-indigo-700/50 p-5">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">âš¡ Wire {wiringDomain} for GitHub Pages</h3>
                                
                                {!wireProgress && wireLog.length === 0 && (
                                    <div>
                                        <p className="text-sm text-slate-400 mb-4">
                                            This will configure DNS records and GitHub Pages to serve your app from <strong className="text-white">{wiringDomain}</strong>. 
                                            It creates 4 A records + 1 CNAME record, commits a CNAME file, and updates the GitHub Pages settings.
                                        </p>
                                        <div className="mb-4">
                                            <label className="text-xs text-slate-400 block mb-1.5">Select Repository to Wire</label>
                                            <div className="space-y-1.5">
                                                {getAppsWithRepos().map(app => (
                                                    <div key={app.id} className="flex items-center gap-3">
                                                        {app.prodRepo && (
                                                            <button onClick={() => handleWireForGitHubPages(wiringDomain, app.prodRepo)}
                                                                className="flex items-center gap-2 px-3 py-2 bg-slate-900/50 rounded-lg hover:bg-slate-700/50 text-sm border border-slate-700 w-full text-left">
                                                                <AppIcon icon={app.icon} size={16} />
                                                                <span className="font-medium">{app.name}</span>
                                                                <span className="text-xs text-slate-500 font-mono ml-auto">{app.prodRepo}</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-900/30 text-green-400 rounded">prod</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <button onClick={() => { setWiringDomain(null); setWireLog([]); }}
                                            className="text-xs text-slate-400 hover:text-white">Cancel</button>
                                    </div>
                                )}
                                
                                {/* Wire Progress Log */}
                                {wireLog.length > 0 && (
                                    <div>
                                        <div className="bg-slate-900 rounded-lg p-4 max-h-64 overflow-y-auto font-mono text-xs space-y-1">
                                            {wireLog.map((line, i) => (
                                                <div key={i} className={`${line.startsWith('âŒ') ? 'text-red-400' : line.startsWith('âœ…') ? 'text-green-400' : line.startsWith('ðŸŽ‰') ? 'text-yellow-400 font-bold' : 'text-slate-300'}`}>
                                                    {line}
                                                </div>
                                            ))}
                                            {wireProgress && <div className="text-indigo-400 animate-pulse">â³ Working...</div>}
                                        </div>
                                        {!wireProgress && (
                                            <button onClick={() => { setWiringDomain(null); setWireLog([]); }}
                                                className="mt-3 text-xs px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600">
                                                âœ“ Done
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}
                
                {!loading && domains && domains.length === 0 && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <span className="text-4xl block mb-4">ðŸŒ</span>
                        <h3 className="text-lg font-semibold mb-2">No Domains Found</h3>
                        <p className="text-slate-400 text-sm">No domains found across your configured registrars. Purchase a domain at your registrar, then manage it here.</p>
                    </div>
                )}
            </div>
        );
    }

    function FirebaseAdminSettings() {
        const [showKeyInput, setShowKeyInput] = React.useState(false);
        const [keyInput, setKeyInput] = React.useState('');
        const [info, setInfo] = React.useState(() => firebaseAdmin.getInfo());
        const [testing, setTesting] = React.useState(false);
        const [testResult, setTestResult] = React.useState(null);
        const [saveResult, setSaveResult] = React.useState(null);
        
        const refreshInfo = () => setInfo(firebaseAdmin.getInfo());
        
        const handleSave = () => {
            setSaveResult(null);
            setTestResult(null);
            const result = firebaseAdmin.saveServiceAccount(keyInput);
            setSaveResult(result);
            if (result.success) {
                setKeyInput('');
                setShowKeyInput(false);
                refreshInfo();
            }
        };
        
        const handleClear = () => {
            firebaseAdmin.clearServiceAccount();
            setSaveResult(null);
            setTestResult(null);
            refreshInfo();
        };
        
        const handleTest = async () => {
            setTesting(true);
            setTestResult(null);
            try {
                const result = await firebaseAdmin.testConnection();
                setTestResult(result);
                refreshInfo();
            } catch (e) {
                setTestResult({ token: false, rules: false, functions: false, errors: [e.message] });
            }
            setTesting(false);
        };
        
        const handleRefreshToken = async () => {
            setTesting(true);
            setTestResult(null);
            try {
                firebaseAdmin.clearToken();
                await firebaseAdmin.getAccessToken();
                refreshInfo();
                setTestResult({ token: true, errors: [], message: 'Token refreshed' });
            } catch (e) {
                setTestResult({ token: false, errors: [e.message] });
            }
            setTesting(false);
        };
        
        const configured = info !== null;
        
        return (
            <div className="space-y-4">
                {/* Status display */}
                {configured ? (
                    <div className="space-y-3">
                        <div className="p-4 bg-slate-900 rounded-lg border border-slate-600">
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Service Account</div>
                                    <div className="font-mono text-slate-300 text-xs truncate" title={info.email}>{info.email}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Firebase Project</div>
                                    <div className="font-mono text-slate-300 text-xs">{info.projectId}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Key ID</div>
                                    <div className="font-mono text-slate-300 text-xs">{info.keyId}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">OAuth Token</div>
                                    <div className="flex items-center gap-2">
                                        {info.tokenValid ? (
                                            <span className="text-green-400 text-xs flex items-center gap-1">
                                                <span className="inline-block w-2 h-2 rounded-full bg-green-400"></span>
                                                Active â€” expires {info.tokenExpiry}
                                            </span>
                                        ) : info.tokenCached ? (
                                            <span className="text-amber-400 text-xs flex items-center gap-1">
                                                <span className="inline-block w-2 h-2 rounded-full bg-amber-400"></span>
                                                Expired
                                            </span>
                                        ) : (
                                            <span className="text-slate-500 text-xs flex items-center gap-1">
                                                <span className="inline-block w-2 h-2 rounded-full bg-slate-500"></span>
                                                Not yet requested
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Actions */}
                        <div className="flex gap-2 flex-wrap">
                            <button onClick={handleTest} disabled={testing}
                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm disabled:opacity-50">
                                {testing ? 'â³ Testing...' : 'ðŸ§ª Test Connection'}
                            </button>
                            <button onClick={handleRefreshToken} disabled={testing}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm disabled:opacity-50">
                                ðŸ”„ Refresh Token
                            </button>
                            <button onClick={() => setShowKeyInput(true)}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                                ðŸ”‘ Update Key
                            </button>
                            <button onClick={handleClear}
                                className="px-4 py-2 bg-red-900/50 hover:bg-red-900/70 text-red-400 border border-red-800 rounded text-sm">
                                ðŸ—‘ï¸ Remove
                            </button>
                        </div>
                    </div>
                ) : (
                    <div className="p-4 bg-slate-900/50 rounded-lg border border-dashed border-slate-600 text-center">
                        <div className="text-slate-400 text-sm mb-3">No service account configured</div>
                        <button onClick={() => setShowKeyInput(true)}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm">
                            ðŸ”‘ Add Service Account Key
                        </button>
                    </div>
                )}
                
                {/* Key input area */}
                {showKeyInput && (
                    <div className="p-4 bg-slate-900 rounded-lg border border-indigo-500/30">
                        <div className="text-sm text-slate-300 mb-2 font-medium">
                            Paste Service Account JSON Key
                        </div>
                        <p className="text-xs text-slate-500 mb-3">
                            Firebase Console â†’ Project Settings â†’ Service Accounts â†’ Generate New Private Key. 
                            Paste the entire JSON file contents below.
                        </p>
                        <textarea
                            value={keyInput}
                            onChange={e => setKeyInput(e.target.value)}
                            placeholder='{"type": "service_account", "project_id": "...", ...}'
                            className="w-full h-32 bg-slate-800 border border-slate-600 rounded p-3 font-mono text-xs text-slate-300 resize-y"
                            spellCheck="false"
                        />
                        <div className="flex gap-2 mt-3">
                            <button onClick={handleSave} disabled={!keyInput.trim()}
                                className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm disabled:opacity-50">
                                ðŸ’¾ Save Key
                            </button>
                            <button onClick={() => { setShowKeyInput(false); setKeyInput(''); setSaveResult(null); }}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                                Cancel
                            </button>
                        </div>
                        
                        {/* Save result */}
                        {saveResult && (
                            <div className={`mt-3 p-3 rounded text-sm ${saveResult.success ? 'bg-green-900/30 border border-green-700 text-green-300' : 'bg-red-900/30 border border-red-700 text-red-300'}`}>
                                {saveResult.success 
                                    ? `âœ… Saved â€” ${saveResult.email} (project: ${saveResult.project})`
                                    : `âŒ ${saveResult.error}`
                                }
                            </div>
                        )}
                    </div>
                )}
                
                {/* Test results */}
                {testResult && (
                    <div className="p-4 bg-slate-900 rounded-lg border border-slate-600">
                        <div className="text-sm font-medium text-slate-300 mb-3">Connection Test Results</div>
                        <div className="space-y-2">
                            <div className="flex items-center gap-2 text-sm">
                                <span className={testResult.token ? 'text-green-400' : 'text-red-400'}>
                                    {testResult.token ? 'âœ…' : 'âŒ'}
                                </span>
                                <span>OAuth2 Token</span>
                                <span className="text-slate-500 text-xs">â€” JWT signing & token exchange</span>
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                                <span className={testResult.rules ? 'text-green-400' : 'text-red-400'}>
                                    {testResult.rules ? 'âœ…' : 'âŒ'}
                                </span>
                                <span>RTDB Rules Access</span>
                                <span className="text-slate-500 text-xs">â€” read security rules via REST</span>
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                                <span className={testResult.functions ? 'text-green-400' : 'text-red-400'}>
                                    {testResult.functions ? 'âœ…' : 'âŒ'}
                                </span>
                                <span>Cloud Functions API</span>
                                {testResult.functionCount !== undefined && (
                                    <span className="text-slate-500 text-xs">â€” found {testResult.functionCount} function{testResult.functionCount !== 1 ? 's' : ''}</span>
                                )}
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                                <span className={testResult.authConfig ? 'text-green-400' : 'text-red-400'}>
                                    {testResult.authConfig ? 'âœ…' : 'âŒ'}
                                </span>
                                <span>Auth Config API</span>
                                {testResult.authorizedDomains && (
                                    <span className="text-slate-500 text-xs">â€” {testResult.authorizedDomains.length} authorized domain{testResult.authorizedDomains.length !== 1 ? 's' : ''}</span>
                                )}
                            </div>
                        </div>
                        {testResult.errors?.length > 0 && (
                            <div className="mt-3 space-y-1">
                                {testResult.errors.map((err, i) => (
                                    <div key={i} className="text-xs text-red-400 bg-red-900/20 px-3 py-1.5 rounded font-mono">{err}</div>
                                ))}
                            </div>
                        )}
                        {testResult.message && (
                            <div className="mt-2 text-xs text-green-400">{testResult.message}</div>
                        )}
                    </div>
                )}
                
                {/* Info about what admin access enables */}
                <div className="text-xs text-slate-500 space-y-1">
                    <div>Admin access enables:</div>
                    <div className="ml-3">â€¢ Read & deploy RTDB security rules</div>
                    <div className="ml-3">â€¢ List Cloud Functions and their status</div>
                    <div className="ml-3">â€¢ View Cloud Logging entries and errors</div>
                    <div className="ml-3">â€¢ Manage Firebase Auth authorized domains</div>
                    <div className="ml-3">â€¢ Admin-level RTDB data access</div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // AUTHORIZED DOMAINS MANAGER (v8.47.0)
    // =========================================================================
    // Manages Firebase Auth authorized domains and GitHub Pages custom domains
    // from a unified interface. Uses FirebaseAdmin (Identity Toolkit v2 API) and
    // GitHub API (Pages custom domain endpoint).
    
    function AuthorizedDomainsManager({ showAlert }) {
        const [domains, setDomains] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [newDomain, setNewDomain] = React.useState('');
        const [adding, setAdding] = React.useState(false);
        const [removing, setRemoving] = React.useState(null);
        
        const loadDomains = async () => {
            setLoading(true);
            setError(null);
            try {
                const list = await firebaseAdmin.getAuthorizedDomains();
                setDomains(list);
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        const handleAdd = async () => {
            if (!newDomain.trim()) return;
            const domain = newDomain.trim().toLowerCase();
            setAdding(true);
            setError(null);
            try {
                const result = await firebaseAdmin.addAuthorizedDomain(domain);
                if (result.alreadyExists) {
                    showAlert?.(`${domain} is already in the authorized domains list.`, 'Already Exists');
                } else {
                    showAlert?.(`âœ… Added ${domain} to Firebase authorized domains.`, 'Domain Added');
                }
                setDomains(result.authorizedDomains);
                setNewDomain('');
            } catch (e) {
                setError(e.message);
            }
            setAdding(false);
        };
        
        const handleRemove = async (domain) => {
            // Protect system domains
            const protectedDomains = ['localhost', 'word-boxing.firebaseapp.com', 'word-boxing.web.app'];
            if (protectedDomains.some(p => domain.includes(p) || domain === 'localhost')) {
                showAlert?.(`Cannot remove system domain: ${domain}`, 'Protected Domain');
                return;
            }
            setRemoving(domain);
            setError(null);
            try {
                const result = await firebaseAdmin.removeAuthorizedDomain(domain);
                if (result.notFound) {
                    showAlert?.(`${domain} was not found in authorized domains.`, 'Not Found');
                } else {
                    showAlert?.(`Removed ${domain} from Firebase authorized domains.`, 'Domain Removed');
                }
                setDomains(result.authorizedDomains);
            } catch (e) {
                setError(e.message);
            }
            setRemoving(null);
        };
        
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') handleAdd();
        };
        
        // Categorize domains for display
        const systemDomains = (domains || []).filter(d => 
            d === 'localhost' || d.endsWith('.firebaseapp.com') || d.endsWith('.web.app')
        );
        const customDomains = (domains || []).filter(d => 
            d !== 'localhost' && !d.endsWith('.firebaseapp.com') && !d.endsWith('.web.app')
        );
        
        return (
            <div className="space-y-4">
                {/* Load button or domain list */}
                {domains === null ? (
                    <div className="text-center">
                        <button onClick={loadDomains} disabled={loading}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm disabled:opacity-50">
                            {loading ? 'â³ Loading...' : 'ðŸ” Load Authorized Domains'}
                        </button>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {/* Custom domains */}
                        <div>
                            <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Custom Domains ({customDomains.length})</div>
                            <div className="space-y-1">
                                {customDomains.map(domain => (
                                    <div key={domain} className="flex items-center justify-between p-2 bg-slate-900 rounded border border-slate-700 group">
                                        <div className="flex items-center gap-2">
                                            <span className="inline-block w-2 h-2 rounded-full bg-green-400"></span>
                                            <span className="text-sm text-slate-300 font-mono">{domain}</span>
                                        </div>
                                        <button 
                                            onClick={() => handleRemove(domain)} 
                                            disabled={removing === domain}
                                            className="text-xs text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity px-2 py-1 rounded hover:bg-red-900/30"
                                        >
                                            {removing === domain ? 'â³' : 'âœ• Remove'}
                                        </button>
                                    </div>
                                ))}
                                {customDomains.length === 0 && (
                                    <div className="text-xs text-slate-500 italic p-2">No custom domains configured</div>
                                )}
                            </div>
                        </div>
                        
                        {/* System domains (collapsed) */}
                        <details className="text-xs">
                            <summary className="text-slate-500 uppercase tracking-wide cursor-pointer hover:text-slate-400">
                                System Domains ({systemDomains.length})
                            </summary>
                            <div className="space-y-1 mt-2">
                                {systemDomains.map(domain => (
                                    <div key={domain} className="flex items-center gap-2 p-2 bg-slate-900/50 rounded border border-slate-700/50">
                                        <span className="inline-block w-2 h-2 rounded-full bg-slate-500"></span>
                                        <span className="text-xs text-slate-500 font-mono">{domain}</span>
                                        <span className="text-xs text-slate-600 ml-auto">protected</span>
                                    </div>
                                ))}
                            </div>
                        </details>
                        
                        {/* Add domain */}
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newDomain}
                                onChange={e => setNewDomain(e.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder="e.g. aicommandcenter.dev"
                                className="flex-1 px-3 py-2 bg-slate-900 border border-slate-600 rounded text-sm text-slate-300 font-mono placeholder-slate-600"
                            />
                            <button onClick={handleAdd} disabled={adding || !newDomain.trim()}
                                className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm disabled:opacity-50 whitespace-nowrap">
                                {adding ? 'â³' : '+ Add'}
                            </button>
                        </div>
                        
                        {/* Refresh */}
                        <button onClick={loadDomains} disabled={loading}
                            className="text-xs text-slate-500 hover:text-slate-400">
                            ðŸ”„ Refresh list
                        </button>
                    </div>
                )}
                
                {/* Error display */}
                {error && (
                    <div className="p-3 bg-red-900/30 border border-red-700 rounded text-sm text-red-300">
                        âŒ {error}
                    </div>
                )}
                
                <div className="text-xs text-slate-500 space-y-1">
                    <div>âš ï¸ After adding a domain here, you also need to update:</div>
                    <div className="ml-3">â€¢ <a href="https://console.cloud.google.com/apis/credentials?project=word-boxing" target="_blank" className="text-indigo-400 hover:underline">Google Cloud Console â†’ OAuth Redirect URIs</a></div>
                    <div className="ml-3 text-slate-600">Add: https://DOMAIN/__/auth/handler (redirect URI) + https://DOMAIN (JS origin)</div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // GITHUB PAGES DOMAIN MANAGER (v8.47.0)
    // =========================================================================
    // Set or update custom domains on GitHub Pages repos using the GitHub API.
    // Requires a GitHub token with full repo access.
    
    function GitHubPagesDomainManager({ showAlert }) {
        const [repos, setRepos] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [editingRepo, setEditingRepo] = React.useState(null);
        const [newCname, setNewCname] = React.useState('');
        const [updating, setUpdating] = React.useState(false);
        const [healthCheck, setHealthCheck] = React.useState({});
        
        const loadRepos = async () => {
            setLoading(true);
            setError(null);
            try {
                // Get app config to find all repos with Pages
                const config = JSON.parse(localStorage.getItem('cc_config') || '{}');
                const apps = config.apps || [];
                const repoList = [];
                
                for (const app of apps) {
                    if (app.prodRepo) {
                        try {
                            const [owner, repoName] = app.prodRepo.split('/');
                            const token = CC.getGitHubToken();
                            const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/pages`, {
                                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                            });
                            if (response.ok) {
                                const pages = await response.json();
                                repoList.push({
                                    repo: app.prodRepo,
                                    appId: app.id,
                                    appName: app.name || app.id,
                                    cname: pages.cname || null,
                                    url: pages.html_url,
                                    httpsEnforced: pages.https_enforced,
                                    status: pages.status
                                });
                            }
                        } catch (e) {
                            // Skip repos that don't have Pages enabled
                        }
                    }
                    if (app.testRepo) {
                        try {
                            const [owner, repoName] = app.testRepo.split('/');
                            const token = CC.getGitHubToken();
                            const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/pages`, {
                                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                            });
                            if (response.ok) {
                                const pages = await response.json();
                                repoList.push({
                                    repo: app.testRepo,
                                    appId: app.id,
                                    appName: (app.name || app.id) + ' (test)',
                                    cname: pages.cname || null,
                                    url: pages.html_url,
                                    httpsEnforced: pages.https_enforced,
                                    status: pages.status
                                });
                            }
                        } catch (e) {
                            // Skip
                        }
                    }
                }
                
                setRepos(repoList);
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        const handleSetDomain = async (repo, domain) => {
            setUpdating(true);
            setError(null);
            try {
                const token = CC.getGitHubToken();
                const github = new GitHubAPI(token);
                await github.updatePagesConfig(repo, domain, true);
                showAlert?.(`âœ… Set custom domain ${domain || '(none)'} on ${repo}`, 'Domain Updated');
                // Reload to refresh
                await loadRepos();
                setEditingRepo(null);
                setNewCname('');
            } catch (e) {
                setError(e.message);
            }
            setUpdating(false);
        };
        
        const handleRemoveDomain = async (repo) => {
            setUpdating(true);
            setError(null);
            try {
                const token = CC.getGitHubToken();
                const github = new GitHubAPI(token);
                await github.updatePagesConfig(repo, null, true);
                showAlert?.(`Removed custom domain from ${repo}`, 'Domain Removed');
                await loadRepos();
            } catch (e) {
                setError(e.message);
            }
            setUpdating(false);
        };
        
        const handleHealthCheck = async (repo) => {
            setHealthCheck(prev => ({ ...prev, [repo]: { loading: true } }));
            try {
                const token = CC.getGitHubToken();
                const github = new GitHubAPI(token);
                const result = await github.checkPagesHealth(repo);
                setHealthCheck(prev => ({ ...prev, [repo]: result }));
            } catch (e) {
                setHealthCheck(prev => ({ ...prev, [repo]: { error: e.message } }));
            }
        };
        
        const startEdit = (repo, currentCname) => {
            setEditingRepo(repo);
            setNewCname(currentCname || '');
        };
        
        return (
            <div className="space-y-4">
                {repos === null ? (
                    <div className="text-center">
                        <button onClick={loadRepos} disabled={loading}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm disabled:opacity-50">
                            {loading ? 'â³ Scanning...' : 'ðŸ” Scan Repos for Pages'}
                        </button>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {repos.map(r => (
                            <div key={r.repo} className="p-3 bg-slate-900 rounded-lg border border-slate-700">
                                <div className="flex items-center justify-between mb-1">
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm font-medium text-slate-200">{r.appName}</span>
                                        <span className="text-xs text-slate-500 font-mono">{r.repo}</span>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {r.status === 'built' && <span className="text-xs text-green-400">â— live</span>}
                                        {r.httpsEnforced && <span className="text-xs text-green-600">ðŸ”’</span>}
                                    </div>
                                </div>
                                
                                <div className="flex items-center justify-between">
                                    <div className="text-xs font-mono">
                                        {r.cname ? (
                                            <span className="text-indigo-400">{r.cname}</span>
                                        ) : (
                                            <span className="text-slate-500 italic">no custom domain</span>
                                        )}
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        {/* Health check */}
                                        {r.cname && (
                                            <button onClick={() => handleHealthCheck(r.repo)}
                                                className="text-xs text-slate-500 hover:text-slate-400">
                                                {healthCheck[r.repo]?.loading ? 'â³' : 'ðŸ¥'}
                                            </button>
                                        )}
                                        
                                        {/* Edit domain */}
                                        {editingRepo === r.repo ? (
                                            <div className="flex items-center gap-1">
                                                <input
                                                    type="text"
                                                    value={newCname}
                                                    onChange={e => setNewCname(e.target.value)}
                                                    onKeyDown={e => e.key === 'Enter' && handleSetDomain(r.repo, newCname)}
                                                    placeholder="domain.com"
                                                    className="w-40 px-2 py-1 bg-slate-800 border border-slate-600 rounded text-xs text-slate-300 font-mono"
                                                    autoFocus
                                                />
                                                <button onClick={() => handleSetDomain(r.repo, newCname)} disabled={updating}
                                                    className="text-xs text-green-400 hover:text-green-300 px-1">
                                                    {updating ? 'â³' : 'âœ“'}
                                                </button>
                                                <button onClick={() => { setEditingRepo(null); setNewCname(''); }}
                                                    className="text-xs text-slate-500 hover:text-slate-400 px-1">âœ•</button>
                                            </div>
                                        ) : (
                                            <button onClick={() => startEdit(r.repo, r.cname)}
                                                className="text-xs text-indigo-400 hover:text-indigo-300">
                                                {r.cname ? 'âœï¸ Edit' : '+ Set Domain'}
                                            </button>
                                        )}
                                        
                                        {/* Remove domain */}
                                        {r.cname && editingRepo !== r.repo && (
                                            <button onClick={() => handleRemoveDomain(r.repo)} disabled={updating}
                                                className="text-xs text-red-400 hover:text-red-300 opacity-50 hover:opacity-100">
                                                âœ•
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Health check result */}
                                {healthCheck[r.repo] && !healthCheck[r.repo].loading && (
                                    <div className={`mt-2 p-2 rounded text-xs ${healthCheck[r.repo].error ? 'bg-red-900/20 text-red-400' : healthCheck[r.repo].pending ? 'bg-amber-900/20 text-amber-400' : 'bg-green-900/20 text-green-400'}`}>
                                        {healthCheck[r.repo].error ? `âŒ ${healthCheck[r.repo].error}` :
                                         healthCheck[r.repo].pending ? 'â³ DNS check in progress...' :
                                         `âœ… DNS healthy${healthCheck[r.repo].domain ? ` â€” ${healthCheck[r.repo].domain.host}` : ''}`}
                                    </div>
                                )}
                            </div>
                        ))}
                        
                        {repos.length === 0 && (
                            <div className="text-xs text-slate-500 italic text-center py-4">No repos with GitHub Pages found in config</div>
                        )}
                        
                        {/* Refresh */}
                        <button onClick={loadRepos} disabled={loading}
                            className="text-xs text-slate-500 hover:text-slate-400">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                )}
                
                {error && (
                    <div className="p-3 bg-red-900/30 border border-red-700 rounded text-sm text-red-300">
                        âŒ {error}
                    </div>
                )}
                
                <div className="text-xs text-slate-500">
                    DNS records (A records + CNAME) must be configured at your registrar separately. Use the Domain Registrar section below or configure manually.
                </div>
            </div>
        );
    }

    // =========================================================================
    // SETTINGS VIEW
    // =========================================================================
    


    // =========================================================================
    // APP SHELL â€” Infrastructure Satellite
    // =========================================================================

    function InfrastructureApp() {
        const [activeTab, setActiveTab] = React.useState('firebase');
        const [alert, setAlert] = React.useState(null);
        const [confirm, setConfirm] = React.useState(null);
        const [prompt, setPrompt] = React.useState(null);
        
        // GitHub API (from shared secrets)
        const githubToken = CC.getGitHubToken();
        const github = React.useMemo(() => githubToken ? new GitHubAPI(githubToken) : null, [githubToken]);
        
        // Firebase auth state
        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [firebaseUid, setFirebaseUid] = React.useState(CC.getFirebaseUid());
        
        React.useEffect(() => {
            if (!firebaseAuth) return;
            const unsub = firebaseAuth.onAuthStateChanged(u => {
                setFirebaseUser(u);
                if (u) setFirebaseUid(u.uid);
            });
            return () => unsub();
        }, []);
        
        // Config from CC Core
        const config = React.useMemo(() => CC.getConfig(), []);
        const apps = React.useMemo(() => {
            if (!config.apps) return {};
            // Build legacy-format apps object from config
            const result = {};
            Object.entries(config.apps).forEach(([id, app]) => {
                result[id] = { ...app, id };
            });
            return result;
        }, [config]);
        
        // Available repos
        const [availableRepos, setAvailableRepos] = React.useState([]);
        React.useEffect(() => {
            if (!github) return;
            github.listRepos().then(repos => {
                setAvailableRepos(repos.map(r => r.full_name));
            }).catch(() => {});
        }, [github]);
        
        // Repo files state (for RepoFilesView / CleanupView)
        const [repoFiles, setRepoFiles] = React.useState({});
        const [selectedRepo, setSelectedRepo] = React.useState('');
        const [selectedAppKey, setSelectedAppKey] = React.useState('');
        const [markedForDeletion, setMarkedForDeletion] = React.useState(new Set());
        
        const handleLoadRepo = async (repo) => {
            if (!github) return;
            try {
                const files = await github.getRepoFiles(repo);
                setRepoFiles(prev => ({ ...prev, [repo]: files }));
            } catch (e) {
                showAlert('Failed to load repo: ' + e.message, 'Error');
            }
        };
        
        const handleDeleteMarked = async () => {
            // Delegate to CleanupView's internal handler
        };
        
        // Alert/Confirm/Prompt helpers
        const showAlert = (msg, title) => setAlert({ msg, title });
        const showConfirm = (msg, onOk) => setConfirm({ msg, onOk });
        const showPrompt = (msg, defaultVal, onOk) => setPrompt({ msg, defaultVal, onOk });
        
        // Missing credentials check
        if (!CC.hasCredentials()) {
            return (
                <div>
                    <SatelliteHeader name="Infrastructure" icon="ðŸ”§" version="1.0.0" />
                    <MissingCredentials satelliteName="Infrastructure" />
                </div>
            );
        }
        
        const tabs = [
            { id: 'firebase', icon: 'ðŸ”¥', label: 'Firebase' },
            { id: 'github', icon: 'ðŸ“', label: 'GitHub' },
            { id: 'domains', icon: 'ðŸŒ', label: 'Domains' },
            { id: 'integrations', icon: 'âš¡', label: 'Integrations' },
        ];
        
        return (
            <div>
                <SatelliteHeader name="Infrastructure" icon="ðŸ”§" version="1.0.0" />
                
                {/* Tab Navigation */}
                <div className="bg-slate-800 border-b border-slate-700">
                    <div className="max-w-6xl mx-auto px-4">
                        <div className="flex gap-1 py-1">
                            {tabs.map(tab => (
                                <button key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`px-4 py-2 text-sm rounded-t-lg flex items-center gap-1.5 transition-colors ${
                                        activeTab === tab.id 
                                            ? 'bg-slate-900 text-white border-t-2 border-indigo-500' 
                                            : 'text-slate-400 hover:text-white hover:bg-slate-700'
                                    }`}
                                >
                                    <span>{tab.icon}</span> {tab.label}
                                </button>
                            ))}
                            
                            {/* Status indicators */}
                            <div className="ml-auto flex items-center gap-3 text-xs pr-2">
                                <span className={`flex items-center gap-1 ${github ? 'text-green-400' : 'text-red-400'}`}>
                                    <span className={`w-2 h-2 rounded-full ${github ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                    GitHub
                                </span>
                                <span className={`flex items-center gap-1 ${firebaseDb ? 'text-green-400' : 'text-amber-400'}`}>
                                    <span className={`w-2 h-2 rounded-full ${firebaseDb ? 'bg-green-400' : 'bg-amber-400'}`}></span>
                                    Firebase
                                </span>
                                {firebaseAuth && (
                                    firebaseUser ? (
                                        <button onClick={async () => { try { await firebaseAuth.signOut(); } catch {} }}
                                            className="flex items-center gap-1 text-green-400 hover:text-green-300"
                                            title={`Signed in as ${firebaseUser.email}`}>
                                            <img src={firebaseUser.photoURL || ''} className="w-5 h-5 rounded-full" 
                                                onError={(e) => { e.target.style.display = 'none'; }} />
                                            <span className="max-w-[100px] truncate">{firebaseUser.displayName?.split(' ')[0] || firebaseUser.email?.split('@')[0]}</span>
                                        </button>
                                    ) : (
                                        <button onClick={async () => {
                                                if (isFileProtocol) return;
                                                try { await firebaseAuth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (e) { console.error(e); }
                                            }}
                                            disabled={isFileProtocol}
                                            className={`flex items-center gap-1 ${isFileProtocol ? 'text-slate-600' : 'text-slate-400 hover:text-white'}`}>
                                            Sign In
                                        </button>
                                    )
                                )}
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Main Content */}
                <main className="max-w-6xl mx-auto px-4 py-6">
                    {activeTab === 'firebase' && (
                        <FirebaseView showAlert={showAlert} showConfirm={showConfirm} showPrompt={showPrompt} />
                    )}
                    {activeTab === 'github' && (
                        <CleanupView 
                            github={github} 
                            config={config} 
                            apps={apps} 
                            availableRepos={availableRepos} 
                            showAlert={showAlert} 
                            showConfirm={showConfirm} 
                        />
                    )}
                    {activeTab === 'domains' && (
                        <DomainsView apps={apps} config={config} showAlert={showAlert} showConfirm={showConfirm} />
                    )}
                    {activeTab === 'integrations' && (
                        <IntegrationsView showAlert={showAlert} showConfirm={showConfirm} showPrompt={showPrompt} />
                    )}
                </main>
                
                {/* Alert Modal */}
                {alert && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[200] p-4" onClick={() => setAlert(null)}>
                        <div className="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-md w-full" onClick={e => e.stopPropagation()}>
                            {alert.title && <h3 className="text-lg font-bold mb-2">{alert.title}</h3>}
                            <p className="text-slate-300 whitespace-pre-wrap text-sm">{alert.msg}</p>
                            <div className="mt-4 flex justify-end">
                                <button onClick={() => setAlert(null)} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium">OK</button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Confirm Modal */}
                {confirm && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[200] p-4">
                        <div className="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-md w-full">
                            <p className="text-slate-300 whitespace-pre-wrap text-sm">{confirm.msg}</p>
                            <div className="mt-4 flex justify-end gap-2">
                                <button onClick={() => setConfirm(null)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">Cancel</button>
                                <button onClick={() => { confirm.onOk(); setConfirm(null); }} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium">Confirm</button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Prompt Modal */}
                {prompt && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[200] p-4">
                        <div className="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-md w-full">
                            <p className="text-slate-300 whitespace-pre-wrap text-sm mb-3">{prompt.msg}</p>
                            <input id="promptInput" defaultValue={prompt.defaultVal || ''} className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm" autoFocus />
                            <div className="mt-4 flex justify-end gap-2">
                                <button onClick={() => setPrompt(null)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">Cancel</button>
                                <button onClick={() => { prompt.onOk(document.getElementById('promptInput').value); setPrompt(null); }} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium">OK</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // MOUNT
    // =========================================================================
    
    ReactDOM.render(<InfrastructureApp />, document.getElementById('root'));
    
    </script>
</body>
</html>
