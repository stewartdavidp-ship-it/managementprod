<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics â€” Command Center</title>
    <meta name="version" content="1.0.0">
    <meta name="gs-app-id" content="cc-analytics">
    <link rel="stylesheet" href="../shared/cc-shared.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../shared/cc-shared.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;"><div style="text-align:center;">Loading Analytics...</div></div></div>

    <script type="text/babel">
    console.log('Analytics Satellite v1.0.0 starting...');

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    
    const fb = initFirebase();
    const firebaseAuth = fb ? fb.auth : null;
    const firebaseDb = fb ? fb.db : null;
    
    const isFileProtocol = window.location.protocol === 'file:';

    // =========================================================================
    // ICONS (minimal subset)
    // =========================================================================
    
    const Icons = {
        Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
        Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
    };

    // =========================================================================
    // SERVICES
    // =========================================================================
    const DeployService = {
        STORAGE_KEY: 'cc_deploy_history',
        load() {
            try { const d = localStorage.getItem(this.STORAGE_KEY); return d ? JSON.parse(d) : []; }
            catch { return []; }
        }
    };
    const WorkItemService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/backlog`);
        },
        
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, item]) => ({ id, ...item }));
                    callback(list.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                } else {
                    callback([]);
                }
            });
            return () => ref.off();
        },
        
        async create(uid, itemData) {
            const ref = this._ref(uid);
            if (!ref) return null;
            const item = {
                appId: itemData.appId,
                streamId: itemData.streamId || null,
                title: itemData.title,
                description: itemData.description || '',
                type: itemData.type || 'feature',
                priority: itemData.priority || 'core',
                milestone: itemData.milestone || 'beta',
                status: itemData.status || 'idea',
                effort: itemData.effort || 'session',
                criteria: itemData.criteria || [],
                context: {
                    filesAffected: itemData.context?.filesAffected || [],
                    sections: itemData.context?.sections || [],
                    dependencies: itemData.context?.dependencies || [],
                    notes: itemData.context?.notes || '',
                    relatedItems: itemData.context?.relatedItems || []
                },
                tags: itemData.tags || [],
                createdAt: new Date().toISOString(),
                createdBy: itemData.createdBy || 'manual',
                source: itemData.source || 'manual',
                startedAt: null, completedAt: null, completedInVersion: null, sessionId: null
            };
            await ref.child(itemData.id).set(item);
            return { id: itemData.id, ...item };
        },
        
        async update(uid, itemId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(itemId).update(updates);
        },
        
        isStale(item) {
            if (item.status !== 'in-progress' && item.status !== 'review') return false;
            const startDate = item.status === 'review' ? item.reviewStartedAt : item.startedAt;
            if (!startDate) return false;
            return (Date.now() - new Date(startDate).getTime()) > 7 * 24 * 60 * 60 * 1000;
        },
        
        filterByApp(items, appId) { return items.filter(i => i.appId === appId); },
        filterByStream(items, streamId) { return items.filter(i => i.streamId === streamId); },
        getUnassigned(items, appId) { return items.filter(i => (!i.streamId) && (!appId || i.appId === appId)); },
        filterByStatus(items, status) { return items.filter(i => i.status === status); },
        
        getNextId(currentItems) {
            const existing = currentItems.map(i => parseInt(i.id?.replace('WI-', '') || '0'));
            const max = Math.max(0, ...existing);
            return `WI-${String(max + 1).padStart(3, '0')}`;
        }
    };
    const SessionService = {
        BASE_PATH: 'command-center',
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/sessions`);
        },
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, s]) => ({ id, ...s }));
                    callback(list.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                } else {
                    callback([]);
                }
            });
            return () => ref.off();
        }
    };
    const ActivityLogService = {
        BASE_PATH: 'command-center',
        MAX_EVENTS: 500,
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/activity`);
        },
        
        // Listen for activity events (returns unsubscribe function)
        listen(uid, callback, limit = 100) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            
            ref.orderByChild('timestamp').limitToLast(limit).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, evt]) => ({ id, ...evt }));
                    callback(list.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0)));
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        // Log an activity event
        async log(uid, event) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const eventId = `evt-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
            const entry = {
                appId: event.appId || null,
                streamId: event.streamId || null,
                actor: event.actor || 'Owner',
                action: event.action,          // deploy, session_create, session_complete, item_transition, scope, review
                summary: event.summary,        // Human-readable: "Dave deployed Core Gameplay v0.9"
                metadata: event.metadata || {},
                timestamp: new Date().toISOString()
            };
            
            await ref.child(eventId).set(entry);
            return { id: eventId, ...entry };
        },
        
        // Convenience loggers for common actions
        async logDeploy(uid, actor, appName, version, env, sessionId) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'deploy',
                summary: `${actor} deployed ${appName} v${version} to ${env}`,
                metadata: { version, environment: env, sessionId }
            });
        },
        
        async logSessionCreate(uid, actor, appName, sessionType, sessionId) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'session_create',
                summary: `${actor} started ${sessionType} session for ${appName}`,
                metadata: { sessionType, sessionId }
            });
        },
        
        async logSessionComplete(uid, actor, appName, sessionId, itemsCompleted) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'session_complete',
                summary: `${actor} completed session for ${appName} â€” ${itemsCompleted} item${itemsCompleted !== 1 ? 's' : ''} done`,
                metadata: { sessionId, itemsCompleted }
            });
        },
        
        async logItemTransition(uid, actor, appName, itemId, itemTitle, fromStatus, toStatus) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'item_transition',
                summary: `${actor} moved "${itemTitle}" from ${fromStatus} to ${toStatus}`,
                metadata: { itemId, fromStatus, toStatus }
            });
        },
        
        async logReview(uid, actor, appName, sessionId, criteriaMetCount, criteriaTotalCount) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'review',
                summary: `${actor} reviewed ${appName} â€” ${criteriaMetCount}/${criteriaTotalCount} criteria met`,
                metadata: { sessionId, criteriaMetCount, criteriaTotalCount }
            });
        }
    };
    
    /**
     * WorkStreamService â€” Named, owned, parallel tracks of work (Phase 5.2)
     * Wraps: Firebase RTDB `command-center/{uid}/streams` path
     * 
     * A work stream groups related work items into a coherent track:
     *   id: 'WS-NNN' (auto-generated)
     *   appId: which app this belongs to
     *   name: "Core Gameplay", "Help & Onboarding"
     *   owner: who owns this stream
     *   goal: what done looks like
     *   status: active | paused | blocked | complete
     *   targetRelease: target version or milestone
     *   blockedBy: [stream_id] â€” streams this depends on
     *   blockedUntil: milestone description
    const WorkStreamService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/streams`);
        },
        
        // Listen for all streams (returns unsubscribe function)
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, stream]) => ({ id, ...stream }));
                    callback(list.sort((a, b) => (a.name || '').localeCompare(b.name || '')));
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        // Create a new work stream
        async create(uid, streamData) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const stream = {
                appId: streamData.appId,
                name: streamData.name,
                owner: streamData.owner || 'Owner',
                goal: streamData.goal || '',
                status: streamData.status || 'active',
                targetRelease: streamData.targetRelease || '',
                blockedBy: streamData.blockedBy || [],
                blockedUntil: streamData.blockedUntil || '',
                createdAt: new Date().toISOString(),
                createdBy: streamData.createdBy || 'Owner',
                completedAt: null
            };
            
            await ref.child(streamData.id).set(stream);
            console.log(`[WorkStreamService] Created ${streamData.id}: ${stream.name}`);
            return { id: streamData.id, ...stream };
        },
        
        // Update a stream (partial)
        async update(uid, streamId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(streamId).update(updates);
            console.log(`[WorkStreamService] Updated ${streamId}`);
        },
        
        // Delete a stream
        async delete(uid, streamId) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(streamId).remove();
            console.log(`[WorkStreamService] Deleted ${streamId}`);
        },
        
        // Update status with timestamp management
        async updateStatus(uid, streamId, newStatus) {
            const updates = { status: newStatus };
            if (newStatus === 'complete') {
                updates.completedAt = new Date().toISOString();
            } else {
                updates.completedAt = null;
            }
            await this.update(uid, streamId, updates);
            console.log(`[WorkStreamService] ${streamId} â†’ ${newStatus}`);
        },
        
        // Get streams filtered by app
        filterByApp(streams, appId) {
            return streams.filter(s => s.appId === appId);
        },
        
        // Get active streams for an app
        getActive(streams, appId) {
            return streams.filter(s => s.status === 'active' && (!appId || s.appId === appId));
        },
        
        // Get stream completion percentage from its work items
        getCompletion(stream, workItems) {
            const streamItems = workItems.filter(wi => wi.streamId === stream.id);
            if (streamItems.length === 0) return { total: 0, done: 0, pct: 0 };
            const done = streamItems.filter(wi => wi.status === 'done').length;
            return { total: streamItems.length, done, pct: Math.round((done / streamItems.length) * 100) };
        },
        
        // Check if a stream is blocked by other streams
        isBlocked(stream, allStreams) {
            if (!stream.blockedBy || stream.blockedBy.length === 0) return false;
            return stream.blockedBy.some(blockerId => {
                const blocker = allStreams.find(s => s.id === blockerId);
                return blocker && blocker.status !== 'complete';
            });
        },
        
        // Generate next stream ID from existing list
        getNextId(currentStreams) {
            const existing = currentStreams.map(s => parseInt(s.id?.replace('WS-', '') || '0'));
            const max = Math.max(0, ...existing);
            return `WS-${String(max + 1).padStart(3, '0')}`;
        },
        
        // Get a "Default" stream for an app, creating it if needed
        getDefaultStreamId(streams, appId) {
            const appStreams = this.filterByApp(streams, appId);
            if (appStreams.length > 0) return appStreams[0].id;
            return null; // No stream exists yet â€” items remain unassigned
        }
    };
    const StreamInterfaceService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/interfaces`);
        },
        
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, iface]) => ({ id, ...iface }));
                    callback(list);
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        async create(uid, data) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const iface = {
                streamId: data.streamId,
                description: data.description,
                category: data.category || 'behavior',
                lastUpdated: new Date().toISOString(),
                lastUpdatedBy: data.updatedBy || 'Owner'
            };
            
            await ref.child(data.id).set(iface);
            console.log(`[StreamInterfaceService] Created ${data.id}: ${iface.description}`);
            return { id: data.id, ...iface };
        },
        
        async update(uid, ifaceId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            updates.lastUpdated = new Date().toISOString();
            await ref.child(ifaceId).update(updates);
        },
        
        async delete(uid, ifaceId) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(ifaceId).remove();
        },
        
        // Get interfaces provided by a stream
        getByStream(interfaces, streamId) {
            return interfaces.filter(i => i.streamId === streamId);
        },
        
        getNextId(current) {
            const existing = current.map(i => parseInt(i.id?.replace('SI-', '') || '0'));
            const max = Math.max(0, ...existing);
            return `SI-${String(max + 1).padStart(3, '0')}`;
        }
    };
    const DependencyService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/dependencies`);
        },
        
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, dep]) => ({ id, ...dep }));
                    callback(list);
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        async create(uid, data) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const dep = {
                dependentStreamId: data.dependentStreamId,
                interfaceId: data.interfaceId,
                context: data.context || '',
                status: 'active',
                lastVerified: new Date().toISOString(),
                lastVerifiedBy: data.verifiedBy || 'Owner'
            };
            
            await ref.child(data.id).set(dep);
            console.log(`[DependencyService] Created ${data.id}`);
            return { id: data.id, ...dep };
        },
        
        async update(uid, depId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(depId).update(updates);
        },
        
        async delete(uid, depId) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(depId).remove();
        },
        
        // Get dependencies that consume from a stream (via its interfaces)
        getDependentsOf(dependencies, interfaces, streamId) {
            const streamInterfaceIds = interfaces.filter(i => i.streamId === streamId).map(i => i.id);
            return dependencies.filter(d => streamInterfaceIds.includes(d.interfaceId));
        },
        
        // Get dependencies that a stream consumes
        getConsumedBy(dependencies, streamId) {
            return dependencies.filter(d => d.dependentStreamId === streamId);
        },
        
        getNextId(current) {
            const existing = current.map(d => parseInt(d.id?.replace('DEP-', '') || '0'));
            const max = Math.max(0, ...existing);
            return `DEP-${String(max + 1).padStart(3, '0')}`;
        }
    };
    const DependencyAlertService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/dependencyAlerts`);
        },
        
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, alert]) => ({ id, ...alert }));
                    callback(list.sort((a, b) => new Date(b.triggeredAt || 0) - new Date(a.triggeredAt || 0)));
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        async create(uid, data) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const alert = {
                dependencyId: data.dependencyId,
                interfaceId: data.interfaceId,
                triggeredBySession: data.triggeredBySession || null,
                triggeredByItem: data.triggeredByItem || null,
                changeDescription: data.changeDescription,
                changeNotes: data.changeNotes || '',
                triggeredAt: new Date().toISOString(),
                triggeredBy: data.triggeredBy || 'Owner',
                generatedItemId: data.generatedItemId || null,
                resolution: 'pending',
                resolvedBy: null,
                resolvedAt: null
            };
            
            await ref.child(data.id).set(alert);
            console.log(`[DependencyAlertService] Created ${data.id}: ${alert.changeDescription}`);
            return { id: data.id, ...alert };
        },
        
        async resolve(uid, alertId, resolution, resolvedBy) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(alertId).update({
                resolution: resolution,  // 'updated' or 'no_impact'
                resolvedBy: resolvedBy || 'Owner',
                resolvedAt: new Date().toISOString()
            });
            console.log(`[DependencyAlertService] Resolved ${alertId}: ${resolution}`);
        },
        
        async updateGeneratedItem(uid, alertId, itemId) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(alertId).update({ generatedItemId: itemId });
        },
        
        async delete(uid, alertId) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(alertId).remove();
        },
        
        // Get pending alerts for a stream (items that need attention)
        getPendingForStream(alerts, dependencies, streamId) {
            const streamDepIds = dependencies.filter(d => d.dependentStreamId === streamId).map(d => d.id);
            return alerts.filter(a => a.resolution === 'pending' && streamDepIds.includes(a.dependencyId));
        },
        
        // Get all pending alerts
        getPending(alerts) {
            return alerts.filter(a => a.resolution === 'pending');
        },
        
        // Get alerts triggered by a specific session
        getBySession(alerts, sessionId) {
            return alerts.filter(a => a.triggeredBySession === sessionId);
        },
        
        getNextId(current) {
            const existing = current.map(a => parseInt(a.id?.replace('DA-', '') || '0'));
            const max = Math.max(0, ...existing);
            return `DA-${String(max + 1).padStart(3, '0')}`;
        },
        
        /**
         * triggerAlerts â€” Core auto-remediation flow (Phase 5.4)
         * 
         * Called when a user confirms an interface changed during post-session review.
         * For each dependency on the changed interface:
         *   1. Creates a dependency alert
         *   2. Auto-creates a work item in the dependent stream with change context
         *   3. Marks the dependency status as 'changed'
         *   4. Logs to activity feed
         * 
         * The generated work item includes changeContext so when the dependent stream
         * owner preps a Claude session, the session brief includes what changed and why.
         * This is the prompt chain: session output â†’ change context â†’ next session input.
         */
        async triggerAlerts(uid, { interfaceId, changeDescription, changeNotes, sessionId, workItemId, actor, interfaces, dependencies, streams, workItems, alerts }) {
            const iface = interfaces.find(i => i.id === interfaceId);
            if (!iface) return [];
            
            // Find all dependencies that consume this interface
            const affectedDeps = dependencies.filter(d => d.interfaceId === interfaceId);
            if (affectedDeps.length === 0) return [];
            
            const providerStream = streams.find(s => s.id === iface.streamId);
            const results = [];
            
            for (const dep of affectedDeps) {
                const dependentStream = streams.find(s => s.id === dep.dependentStreamId);
                if (!dependentStream) continue;
                
                // 1. Create the alert
                const alertId = this.getNextId(alerts.concat(results.map(r => r.alert)));
                
                // 2. Auto-create a work item in the dependent stream
                const itemId = WorkItemService.getNextId(workItems);
                const workItem = await WorkItemService.create(uid, {
                    id: itemId,
                    appId: dependentStream.appId || iface.appId || '',
                    streamId: dep.dependentStreamId,
                    title: `Update: ${iface.description} changed`,
                    description: `Interface "${iface.description}" provided by ${providerStream?.name || 'unknown stream'} has changed.\n\n**What changed:** ${changeDescription}\n\n**Why this stream is affected:** ${dep.context || 'This stream depends on this interface.'}\n\n**Change notes from source session:**\n${changeNotes || 'No additional notes.'}`,
                    type: 'dependency_update',
                    priority: 'core',
                    status: 'ready',
                    effort: 'session',
                    criteria: [
                        `Verify ${dependentStream.name} works correctly with the updated interface`,
                        `Update any references to: ${iface.description}`
                    ],
                    context: {
                        notes: `Auto-generated from dependency alert ${alertId}. Source session: ${sessionId || 'N/A'}.`,
                        dependencies: [iface.description],
                        relatedItems: workItemId ? [workItemId] : []
                    },
                    tags: ['dependency-update', 'auto-generated'],
                    createdBy: actor,
                    source: 'dependency_alert'
                });
                
                // 3. Create the alert record
                const alert = await this.create(uid, {
                    id: alertId,
                    dependencyId: dep.id,
                    interfaceId: interfaceId,
                    triggeredBySession: sessionId,
                    triggeredByItem: workItemId,
                    changeDescription: changeDescription,
                    changeNotes: changeNotes,
                    triggeredBy: actor,
                    generatedItemId: itemId
                });
                
                // 4. Mark the dependency as 'changed'
                await DependencyService.update(uid, dep.id, { 
                    status: 'changed',
                    lastChangedAt: new Date().toISOString(),
                    lastChangedBy: actor
                });
                
                // 5. Log to activity feed
                ActivityLogService.log(uid, {
                    appId: dependentStream.appId,
                    streamId: dep.dependentStreamId,
                    actor: actor,
                    action: 'dependency_alert',
                    summary: `Dependency alert: "${iface.description}" changed â€” ${dependentStream.name} has update queued`,
                    metadata: { alertId, interfaceId, dependencyId: dep.id, generatedItemId: itemId }
                }).catch(e => console.warn('[Activity] Dependency alert log failed:', e));
                
                results.push({ alert, workItem, dependency: dep, dependentStream });
            }
            
            return results;
        }
    };
    const TeamService = {
        BASE_PATH: 'command-center',
        
        _teamRef(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/team`);
        },
        
        _membershipRef(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/teamMembership`);
        },
        
        // Listen for team members (owner's perspective)
        listen(uid, callback) {
            const ref = this._teamRef(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([memberId, member]) => ({ uid: memberId, ...member }));
                    callback(list.sort((a, b) => (a.name || a.email || '').localeCompare(b.name || b.email || '')));
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        // Listen for workspaces this user belongs to (member's perspective)
        listenMemberships(uid, callback) {
            const ref = this._membershipRef(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                callback(data || null);
            });
            
            return () => ref.off();
        },
        
        // Invite a team member (by email)
        async invite(ownerUid, email, role = 'editor', invitedBy = 'Owner') {
            const ref = this._teamRef(ownerUid);
            if (!ref) return null;
            
            const tempKey = `pending-${btoa(email).replace(/[^a-zA-Z0-9]/g, '').slice(0, 20)}`;
            
            const member = {
                email: email.toLowerCase().trim(),
                name: null,
                photoURL: null,
                role: role,
                status: 'invited',
                invitedAt: new Date().toISOString(),
                invitedBy: invitedBy,
                joinedAt: null
            };
            
            await ref.child(tempKey).set(member);
            console.log(`[TeamService] Invited ${email} as ${role}`);
            return { uid: tempKey, ...member };
        },
        
        // Accept invite â€” called when invited user signs in
        async acceptInvite(ownerUid, memberUid, memberProfile) {
            const ref = this._teamRef(ownerUid);
            if (!ref) return;
            
            const snap = await ref.once('value');
            const team = snap.val() || {};
            const pendingKey = Object.keys(team).find(k => 
                k.startsWith('pending-') && team[k].email === memberProfile.email?.toLowerCase()
            );
            
            if (!pendingKey) {
                console.warn(`[TeamService] No pending invite for ${memberProfile.email}`);
                return null;
            }
            
            const invite = team[pendingKey];
            
            await ref.child(pendingKey).remove();
            await ref.child(memberUid).set({
                email: memberProfile.email,
                name: memberProfile.displayName || memberProfile.email.split('@')[0],
                photoURL: memberProfile.photoURL || null,
                role: invite.role,
                status: 'active',
                invitedAt: invite.invitedAt,
                invitedBy: invite.invitedBy,
                joinedAt: new Date().toISOString()
            });
            
            // Write membership pointer on the member's node
            await this._membershipRef(memberUid)?.set({
                ownerUid: ownerUid,
                role: invite.role,
                workspaceName: 'Command Center'
            });
            
            console.log(`[TeamService] ${memberProfile.email} joined as ${invite.role}`);
            return { uid: memberUid, role: invite.role };
        },
        
        // Update member role
        async updateRole(ownerUid, memberUid, newRole) {
            const ref = this._teamRef(ownerUid);
            if (!ref) return;
            await ref.child(memberUid).update({ role: newRole });
            await this._membershipRef(memberUid)?.update({ role: newRole });
        },
        
        // Remove team member
        async remove(ownerUid, memberUid) {
            const ref = this._teamRef(ownerUid);
            if (!ref) return;
            await ref.child(memberUid).remove();
            await this._membershipRef(memberUid)?.remove();
        },
        
        // Get the effective workspace UID (owner's UID if member, own UID if owner)
        getWorkspaceUid(currentUid, membership) {
            if (membership?.ownerUid) return membership.ownerUid;
            return currentUid;
        },
        
        canEdit(membership) {
            if (!membership) return true; // Owner
            return membership.role === 'owner' || membership.role === 'editor';
        },
        
        canManageTeam(membership) {
            if (!membership) return true; // Owner
            return membership.role === 'owner';
        },
        
        // Generate Firebase security rules template
        generateRulesTemplate(ownerUid) {
            return JSON.stringify({
                rules: {
                    "command-center": {
                        [ownerUid]: {
                            ".read": `auth.uid === '${ownerUid}' || root.child('command-center/${ownerUid}/team/' + auth.uid).exists()`,
                            ".write": `auth.uid === '${ownerUid}' || (root.child('command-center/${ownerUid}/team/' + auth.uid).exists() && root.child('command-center/${ownerUid}/team/' + auth.uid + '/role').val() !== 'viewer')`,
                            "team": { ".write": `auth.uid === '${ownerUid}'` }
                        },
                        "$uid": {
                            "teamMembership": {
                                ".read": "auth.uid === $uid",
                                ".write": "auth != null"
                            }
                        }
                    }
                }
            }, null, 2);
        }
    };

    // =========================================================================
    // VIEWS
    // =========================================================================
    function PortfolioView({ apps, config, globalWorkItems, globalSessions, deployments, showAlert }) {
        const [timeRange, setTimeRange] = React.useState('30d'); // 7d, 30d, 90d, all
        
        const configuredApps = React.useMemo(() => 
            Object.entries(apps).filter(([_, a]) => a.testRepo || a.prodRepo).map(([id, a]) => ({ id, ...a })),
            [apps]
        );
        
        // Time filter helper
        const getTimeFilter = React.useCallback(() => {
            if (timeRange === 'all') return 0;
            const days = parseInt(timeRange);
            return Date.now() - (days * 24 * 60 * 60 * 1000);
        }, [timeRange]);
        
        // === MATURITY DISTRIBUTION ===
        const maturityData = React.useMemo(() => {
            const dist = { seed: 0, prototype: 0, alpha: 0, beta: 0, production: 0, unset: 0 };
            configuredApps.forEach(app => {
                const m = app.lifecycle?.currentMaturity;
                if (m && dist.hasOwnProperty(m)) dist[m]++;
                else dist.unset++;
            });
            return dist;
        }, [configuredApps]);
        
        // === BACKLOG HEALTH ===
        const backlogHealth = React.useMemo(() => {
            const items = globalWorkItems || [];
            const byStatus = { idea: 0, ready: 0, 'in-progress': 0, review: 0, done: 0, deferred: 0 };
            const byType = { feature: 0, bugfix: 0, enhancement: 0, chore: 0, research: 0 };
            const byApp = {};
            let aging = 0; // items in-progress or review > 7 days
            
            items.forEach(wi => {
                if (byStatus.hasOwnProperty(wi.status)) byStatus[wi.status]++;
                else if (wi.status) byStatus[wi.status] = (byStatus[wi.status] || 0) + 1;
                if (byType.hasOwnProperty(wi.type)) byType[wi.type]++;
                if (!byApp[wi.appId]) byApp[wi.appId] = 0;
                if (wi.status !== 'done' && wi.status !== 'deferred') byApp[wi.appId]++;
                if (WorkItemService.isStale(wi)) aging++;
            });
            
            return { byStatus, byType, byApp, aging, total: items.length };
        }, [globalWorkItems]);
        
        // === SESSION VELOCITY ===
        const sessionMetrics = React.useMemo(() => {
            const sessions = globalSessions || [];
            const cutoff = getTimeFilter();
            const filtered = cutoff ? sessions.filter(s => new Date(s.createdAt).getTime() > cutoff) : sessions;
            
            const byApp = {};
            const byType = {};
            const byWeek = {};
            let totalTokens = 0;
            let totalCost = 0;
            
            filtered.forEach(s => {
                // By app
                if (!byApp[s.appId]) byApp[s.appId] = 0;
                byApp[s.appId]++;
                
                // By type
                if (!byType[s.type]) byType[s.type] = 0;
                byType[s.type]++;
                
                // By week
                const d = new Date(s.createdAt);
                const weekStart = new Date(d);
                weekStart.setDate(d.getDate() - d.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                if (!byWeek[weekKey]) byWeek[weekKey] = 0;
                byWeek[weekKey]++;
                
                // Token/cost tracking
                const tokens = s.packageTokens || 0;
                totalTokens += tokens;
                
                // Calculate cost using engine registry
                const engineId = s.engineId || 'claude-sonnet-4.5';
                const engine = EngineRegistryService.ENGINES[engineId];
                if (engine && tokens > 0) {
                    // Estimate: input tokens = package, output â‰ˆ 30% of input
                    const inputCost = (tokens / 1000000) * engine.cost.input;
                    const outputTokens = tokens * 0.3;
                    const outputCost = (outputTokens / 1000000) * engine.cost.output;
                    totalCost += inputCost + outputCost;
                }
            });
            
            // Sessions per week average
            const weekKeys = Object.keys(byWeek).sort();
            const weekCount = weekKeys.length || 1;
            const avgPerWeek = (filtered.length / weekCount).toFixed(1);
            
            return { total: filtered.length, byApp, byType, byWeek, weekKeys, avgPerWeek, totalTokens, totalCost };
        }, [globalSessions, getTimeFilter]);
        
        // === DEPLOY FREQUENCY ===
        const deployMetrics = React.useMemo(() => {
            const deps = deployments || [];
            const cutoff = getTimeFilter();
            const filtered = cutoff ? deps.filter(d => new Date(d.timestamp || d.date).getTime() > cutoff) : deps;
            
            const byApp = {};
            const byTarget = { test: 0, prod: 0 };
            const byWeek = {};
            
            filtered.forEach(d => {
                const appId = d.appId || d.app;
                if (!byApp[appId]) byApp[appId] = 0;
                byApp[appId]++;
                
                if (d.target === 'prod') byTarget.prod++;
                else byTarget.test++;
                
                const dt = new Date(d.timestamp || d.date);
                const weekStart = new Date(dt);
                weekStart.setDate(dt.getDate() - dt.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                if (!byWeek[weekKey]) byWeek[weekKey] = 0;
                byWeek[weekKey]++;
            });
            
            const weekCount = Object.keys(byWeek).length || 1;
            const avgPerWeek = (filtered.length / weekCount).toFixed(1);
            
            return { total: filtered.length, byApp, byTarget, byWeek, avgPerWeek };
        }, [deployments, getTimeFilter]);
        
        // === COST BY APP ===
        const costByApp = React.useMemo(() => {
            const sessions = globalSessions || [];
            const cutoff = getTimeFilter();
            const filtered = cutoff ? sessions.filter(s => new Date(s.createdAt).getTime() > cutoff) : sessions;
            
            const costs = {};
            filtered.forEach(s => {
                const tokens = s.packageTokens || 0;
                const engineId = s.engineId || 'claude-sonnet-4.5';
                const engine = EngineRegistryService.ENGINES[engineId];
                if (engine && tokens > 0) {
                    const inputCost = (tokens / 1000000) * engine.cost.input;
                    const outputTokens = tokens * 0.3;
                    const outputCost = (outputTokens / 1000000) * engine.cost.output;
                    const sessionCost = inputCost + outputCost;
                    
                    if (!costs[s.appId]) costs[s.appId] = { sessions: 0, tokens: 0, cost: 0 };
                    costs[s.appId].sessions++;
                    costs[s.appId].tokens += tokens;
                    costs[s.appId].cost += sessionCost;
                }
            });
            
            return costs;
        }, [globalSessions, getTimeFilter]);
        
        // Maturity bar colors
        const maturityColors = {
            seed: '#64748b',
            prototype: '#d97706',
            alpha: '#ea580c',
            beta: '#3b82f6',
            production: '#22c55e',
            unset: '#334155'
        };
        
        // Helper: stat card
        const StatCard = ({ label, value, sub, icon }) => (
            <div className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                <div className="flex items-center gap-2 text-slate-400 text-xs mb-1">{icon} {label}</div>
                <div className="text-2xl font-bold">{value}</div>
                {sub && <div className="text-xs text-slate-500 mt-1">{sub}</div>}
            </div>
        );
        
        // Helper: horizontal bar
        const HBar = ({ items, total }) => {
            if (!total) return <div className="h-6 rounded bg-slate-700 w-full" />;
            return (
                <div className="h-6 rounded overflow-hidden flex w-full">
                    {items.filter(i => i.count > 0).map((item, idx) => (
                        <div key={idx} style={{ width: `${(item.count / total) * 100}%`, backgroundColor: item.color }}
                            className="h-full flex items-center justify-center text-xs font-medium text-white/90 min-w-[20px]"
                            title={`${item.label}: ${item.count}`}>
                            {item.count > 0 && (item.count / total) > 0.08 ? item.count : ''}
                        </div>
                    ))}
                </div>
            );
        };
        
        return (
            <div className="max-w-6xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                        <span className="text-2xl">ðŸ“Š</span>
                        <div>
                            <h1 className="text-2xl font-bold">Portfolio</h1>
                            <p className="text-slate-400 text-sm">Maturity, velocity, costs across all apps</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-1 bg-slate-800 rounded-lg p-1 border border-slate-700">
                        {['7d', '30d', '90d', 'all'].map(r => (
                            <button key={r} onClick={() => setTimeRange(r)}
                                className={`px-3 py-1 text-xs rounded ${timeRange === r ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}>
                                {r === 'all' ? 'All Time' : r}
                            </button>
                        ))}
                    </div>
                </div>
                
                {/* Top Stats Row (Phase 4.1: Product-focused) */}
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <StatCard icon="âœ…" label="Shipped" value={(() => {
                        const cutoff = getTimeFilter();
                        return (globalWorkItems || []).filter(wi => {
                            if (wi.status !== 'done') return false;
                            const t = new Date(wi.completedAt || wi.updatedAt || 0).getTime();
                            return cutoff ? t > cutoff : true;
                        }).length;
                    })()} sub="features completed" />
                    <StatCard icon="ðŸ“¦" label="Apps" value={configuredApps.length} sub={`${maturityData.production} in production`} />
                    <StatCard icon="ðŸ§ " label="Sessions" value={sessionMetrics.total} sub={`${sessionMetrics.avgPerWeek}/week avg`} />
                    <StatCard icon="ðŸš€" label="Deploys" value={deployMetrics.total} sub={`${deployMetrics.avgPerWeek}/week avg`} />
                    <StatCard icon="ðŸ’°" label="Est. Cost" value={`$${sessionMetrics.totalCost.toFixed(2)}`} sub={`${(sessionMetrics.totalTokens / 1000000).toFixed(1)}M tokens`} />
                </div>
                
                {/* Maturity Distribution */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-5 mb-6">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸŽ¯ App Maturity Distribution</h3>
                    <HBar total={configuredApps.length} items={[
                        { label: 'Seed', count: maturityData.seed, color: maturityColors.seed },
                        { label: 'Prototype', count: maturityData.prototype, color: maturityColors.prototype },
                        { label: 'Alpha', count: maturityData.alpha, color: maturityColors.alpha },
                        { label: 'Beta', count: maturityData.beta, color: maturityColors.beta },
                        { label: 'Production', count: maturityData.production, color: maturityColors.production },
                        { label: 'Unset', count: maturityData.unset, color: maturityColors.unset },
                    ]} />
                    <div className="flex flex-wrap gap-4 mt-3 text-xs">
                        {Object.entries(maturityData).filter(([_, v]) => v > 0).map(([stage, count]) => (
                            <div key={stage} className="flex items-center gap-1.5">
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: maturityColors[stage] }} />
                                <span className="text-slate-300 capitalize">{stage}</span>
                                <span className="text-slate-500">{count}</span>
                            </div>
                        ))}
                    </div>
                </div>
                
                {/* Two Column: Backlog Health + Session Types */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    {/* Backlog Health */}
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                        <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸ“‹ Backlog Health</h3>
                        <div className="space-y-3">
                            <div>
                                <div className="text-xs text-slate-400 mb-1.5">By Status ({backlogHealth.total} total)</div>
                                <HBar total={backlogHealth.total} items={[
                                    { label: 'Idea', count: backlogHealth.byStatus.idea, color: '#64748b' },
                                    { label: 'Ready', count: backlogHealth.byStatus.ready, color: '#3b82f6' },
                                    { label: 'In Progress', count: backlogHealth.byStatus['in-progress'], color: '#f59e0b' },
                                    { label: 'Done', count: backlogHealth.byStatus.done, color: '#22c55e' },
                                    { label: 'Deferred', count: backlogHealth.byStatus.deferred, color: '#6b7280' },
                                ]} />
                                <div className="flex flex-wrap gap-3 mt-2 text-xs">
                                    {Object.entries(backlogHealth.byStatus).filter(([_, v]) => v > 0).map(([status, count]) => (
                                        <span key={status} className="text-slate-400">{status}: <span className="text-slate-200">{count}</span></span>
                                    ))}
                                </div>
                            </div>
                            {backlogHealth.aging > 0 && (
                                <div className="flex items-center gap-2 text-xs text-amber-400 bg-amber-900/20 rounded-lg px-3 py-2">
                                    âš ï¸ {backlogHealth.aging} item{backlogHealth.aging !== 1 ? 's' : ''} in-progress for 7+ days
                                </div>
                            )}
                            {/* Top apps by open items */}
                            <div>
                                <div className="text-xs text-slate-400 mb-1.5">Open Items by App</div>
                                <div className="space-y-1">
                                    {Object.entries(backlogHealth.byApp)
                                        .filter(([_, count]) => count > 0)
                                        .sort((a, b) => b[1] - a[1])
                                        .slice(0, 8)
                                        .map(([appId, count]) => {
                                            const app = apps[appId];
                                            return (
                                                <div key={appId} className="flex items-center gap-2 text-xs">
                                                    <AppIcon icon={app?.icon} size={14} />
                                                    <span className="text-slate-300 flex-1">{app?.name || appId}</span>
                                                    <span className="text-slate-400">{count}</span>
                                                    <div className="w-20 h-2 bg-slate-700 rounded overflow-hidden">
                                                        <div className="h-full bg-indigo-500 rounded" style={{ width: `${Math.min(100, (count / Math.max(...Object.values(backlogHealth.byApp))) * 100)}%` }} />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Session Types */}
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                        <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸ§  Session Mix</h3>
                        {sessionMetrics.total === 0 ? (
                            <div className="text-slate-500 text-sm py-8 text-center">No sessions recorded yet. Use Claude Prep to start tracking.</div>
                        ) : (
                            <div className="space-y-3">
                                <HBar total={sessionMetrics.total} items={[
                                    { label: 'Build', count: sessionMetrics.byType.build || 0, color: '#3b82f6' },
                                    { label: 'Fix', count: sessionMetrics.byType.fix || 0, color: '#ef4444' },
                                    { label: 'Design', count: sessionMetrics.byType.design || 0, color: '#8b5cf6' },
                                    { label: 'Test', count: sessionMetrics.byType.test || 0, color: '#22c55e' },
                                    { label: 'Research', count: sessionMetrics.byType.research || 0, color: '#f59e0b' },
                                    { label: 'Other', count: (sessionMetrics.byType.review || 0) + (sessionMetrics.byType.polish || 0) + (sessionMetrics.byType.document || 0), color: '#64748b' },
                                ]} />
                                <div className="flex flex-wrap gap-3 text-xs">
                                    {Object.entries(sessionMetrics.byType).filter(([_, v]) => v > 0).sort((a, b) => b[1] - a[1]).map(([type, count]) => (
                                        <span key={type} className="text-slate-400 capitalize">{type}: <span className="text-slate-200">{count}</span></span>
                                    ))}
                                </div>
                                {/* Sessions by app */}
                                <div>
                                    <div className="text-xs text-slate-400 mb-1.5 mt-2">Sessions by App</div>
                                    <div className="space-y-1">
                                        {Object.entries(sessionMetrics.byApp)
                                            .sort((a, b) => b[1] - a[1])
                                            .slice(0, 8)
                                            .map(([appId, count]) => {
                                                const app = apps[appId];
                                                const appCost = costByApp[appId];
                                                return (
                                                    <div key={appId} className="flex items-center gap-2 text-xs">
                                                        <AppIcon icon={app?.icon} size={14} />
                                                        <span className="text-slate-300 flex-1">{app?.name || appId}</span>
                                                        <span className="text-slate-400">{count} sess</span>
                                                        {appCost && <span className="text-green-400/70">${appCost.cost.toFixed(2)}</span>}
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Deploy Frequency */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-5 mb-6">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸš€ Deploy Activity</h3>
                    {deployMetrics.total === 0 ? (
                        <div className="text-slate-500 text-sm py-4 text-center">No deploys in this time range.</div>
                    ) : (
                        <div className="space-y-4">
                            <div className="flex gap-6 text-sm">
                                <div><span className="text-blue-400 font-semibold">{deployMetrics.byTarget.test}</span> <span className="text-slate-400">to test</span></div>
                                <div><span className="text-green-400 font-semibold">{deployMetrics.byTarget.prod}</span> <span className="text-slate-400">to prod</span></div>
                                <div className="text-slate-500">|</div>
                                <div><span className="text-slate-200 font-semibold">{deployMetrics.avgPerWeek}</span> <span className="text-slate-400">per week</span></div>
                            </div>
                            {/* Weekly sparkline */}
                            {Object.keys(deployMetrics.byWeek).length > 1 && (() => {
                                const weeks = Object.entries(deployMetrics.byWeek).sort((a, b) => a[0].localeCompare(b[0]));
                                const maxWeek = Math.max(...weeks.map(w => w[1]));
                                return (
                                    <div>
                                        <div className="text-xs text-slate-400 mb-2">Weekly Deploy Volume</div>
                                        <div className="flex items-end gap-1 h-16">
                                            {weeks.map(([week, count]) => (
                                                <div key={week} className="flex-1 flex flex-col items-center gap-1">
                                                    <div className="w-full bg-indigo-500/70 rounded-t min-h-[2px]"
                                                        style={{ height: `${(count / maxWeek) * 100}%` }}
                                                        title={`Week of ${week}: ${count} deploys`} />
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex gap-1 mt-1">
                                            {weeks.map(([week]) => (
                                                <div key={week} className="flex-1 text-center text-[9px] text-slate-600">
                                                    {week.slice(5)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}
                            {/* Top deployed apps */}
                            <div>
                                <div className="text-xs text-slate-400 mb-1.5">Deploys by App</div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    {Object.entries(deployMetrics.byApp)
                                        .sort((a, b) => b[1] - a[1])
                                        .slice(0, 9)
                                        .map(([appId, count]) => {
                                            const app = apps[appId];
                                            return (
                                                <div key={appId} className="flex items-center gap-2 text-xs bg-slate-700/50 rounded-lg px-3 py-2">
                                                    <AppIcon icon={app?.icon} size={14} />
                                                    <span className="text-slate-300 flex-1 truncate">{app?.name || appId}</span>
                                                    <span className="text-slate-400 font-medium">{count}</span>
                                                </div>
                                            );
                                        })}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                
                {/* Cost Breakdown Table */}
                {Object.keys(costByApp).length > 0 && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-5 mb-6">
                        <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸ’° Cost Breakdown by App</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="text-left text-xs text-slate-400 border-b border-slate-700">
                                        <th className="pb-2 pl-2">App</th>
                                        <th className="pb-2 text-right">Sessions</th>
                                        <th className="pb-2 text-right">Tokens</th>
                                        <th className="pb-2 text-right">Est. Cost</th>
                                        <th className="pb-2 text-right pr-2">$/Session</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.entries(costByApp)
                                        .sort((a, b) => b[1].cost - a[1].cost)
                                        .map(([appId, data]) => {
                                            const app = apps[appId];
                                            return (
                                                <tr key={appId} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-2 pl-2 flex items-center gap-2">
                                                        <AppIcon icon={app?.icon} size={16} />
                                                        <span>{app?.name || appId}</span>
                                                        {app?.lifecycle?.currentMaturity && (
                                                            <span className="text-[10px] text-slate-500 capitalize">{app.lifecycle.currentMaturity}</span>
                                                        )}
                                                    </td>
                                                    <td className="py-2 text-right text-slate-300">{data.sessions}</td>
                                                    <td className="py-2 text-right text-slate-400">{(data.tokens / 1000).toFixed(0)}K</td>
                                                    <td className="py-2 text-right text-green-400">${data.cost.toFixed(2)}</td>
                                                    <td className="py-2 text-right pr-2 text-slate-400">${(data.cost / data.sessions).toFixed(2)}</td>
                                                </tr>
                                            );
                                        })}
                                    <tr className="font-medium">
                                        <td className="py-2 pl-2 text-slate-300">Total</td>
                                        <td className="py-2 text-right text-slate-200">{sessionMetrics.total}</td>
                                        <td className="py-2 text-right text-slate-300">{(sessionMetrics.totalTokens / 1000).toFixed(0)}K</td>
                                        <td className="py-2 text-right text-green-300">${sessionMetrics.totalCost.toFixed(2)}</td>
                                        <td className="py-2 text-right pr-2 text-slate-300">${sessionMetrics.total ? (sessionMetrics.totalCost / sessionMetrics.total).toFixed(2) : '0.00'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-3 text-xs text-slate-500">
                            ðŸ’¡ Cost estimates based on package token counts Ã— engine pricing. Actual costs depend on conversation length and output volume.
                        </div>
                    </div>
                )}
                
                {/* App Maturity Detail Table */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸŽ¯ App Status Overview</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="text-left text-xs text-slate-400 border-b border-slate-700">
                                    <th className="pb-2 pl-2">App</th>
                                    <th className="pb-2">Maturity</th>
                                    <th className="pb-2">Target</th>
                                    <th className="pb-2 text-right">Open WI</th>
                                    <th className="pb-2 text-right">Sessions</th>
                                    <th className="pb-2 text-right">Deploys</th>
                                    <th className="pb-2 text-right pr-2">Prod Ver.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {configuredApps
                                    .sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id))
                                    .map(app => {
                                        const m = app.lifecycle?.currentMaturity;
                                        const mt = app.lifecycle?.maturityTarget;
                                        const openWI = (globalWorkItems || []).filter(wi => wi.appId === app.id && !['done', 'deferred'].includes(wi.status)).length;
                                        const sessCount = sessionMetrics.byApp[app.id] || 0;
                                        const depCount = deployMetrics.byApp[app.id] || 0;
                                        const maturityBg = {
                                            seed: 'bg-slate-700 text-slate-300',
                                            prototype: 'bg-amber-900/50 text-amber-300',
                                            alpha: 'bg-orange-900/50 text-orange-300',
                                            beta: 'bg-blue-900/50 text-blue-300',
                                            production: 'bg-green-900/50 text-green-300'
                                        };
                                        
                                        return (
                                            <tr key={app.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                <td className="py-2 pl-2 flex items-center gap-2">
                                                    <AppIcon icon={app.icon} size={16} />
                                                    <span>{app.name}</span>
                                                </td>
                                                <td className="py-2">
                                                    {m ? (
                                                        <span className={`px-1.5 py-0.5 rounded text-xs capitalize ${maturityBg[m] || ''}`}>{m}</span>
                                                    ) : (
                                                        <span className="text-slate-600 text-xs">â€”</span>
                                                    )}
                                                </td>
                                                <td className="py-2">
                                                    {mt ? (
                                                        <span className="text-xs text-slate-400 capitalize">{mt}</span>
                                                    ) : (
                                                        <span className="text-slate-600 text-xs">â€”</span>
                                                    )}
                                                </td>
                                                <td className="py-2 text-right">{openWI > 0 ? <span className="text-indigo-300">{openWI}</span> : <span className="text-slate-600">0</span>}</td>
                                                <td className="py-2 text-right">{sessCount > 0 ? sessCount : <span className="text-slate-600">0</span>}</td>
                                                <td className="py-2 text-right">{depCount > 0 ? depCount : <span className="text-slate-600">0</span>}</td>
                                                <td className="py-2 text-right pr-2 text-xs font-mono">{app.currentProdVersion || <span className="text-slate-600">â€”</span>}</td>
                                            </tr>
                                        );
                                    })}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }
    function EnvironmentOptimizationView({ apps, config, globalSessions, showAlert }) {
        const [selectedAppId, setSelectedAppId] = React.useState(null);
        const [copiedSection, setCopiedSection] = React.useState(null);
        
        const configuredApps = React.useMemo(() => 
            Object.entries(apps).filter(([_, a]) => a.testRepo || a.prodRepo).map(([id, a]) => ({ id, ...a })),
            [apps]
        );
        
        // Sort apps by session count (most active first)
        const sortedApps = React.useMemo(() => {
            const sessions = globalSessions || [];
            const sessionCounts = {};
            sessions.forEach(s => { sessionCounts[s.appId] = (sessionCounts[s.appId] || 0) + 1; });
            return [...configuredApps].sort((a, b) => (sessionCounts[b.id] || 0) - (sessionCounts[a.id] || 0));
        }, [configuredApps, globalSessions]);
        
        const selectedApp = selectedAppId ? { id: selectedAppId, ...apps[selectedAppId] } : null;
        
        // === DOC CLASSIFICATION ===
        // Persistent docs: rarely change, belong in Claude Project Knowledge
        const PERSISTENT_DOCS = [
            { name: 'CONTEXT.md', desc: 'Architecture, conventions, schemas', changeFreq: 'Low â€” updated every few sessions' },
            { name: 'CLAUDE_INSTRUCTIONS.md', desc: 'AI development instructions, standards profile', changeFreq: 'Very low â€” set during scoping' },
            { name: 'ARCHITECTURE.md', desc: 'Detailed component/data flow reference', changeFreq: 'Low â€” updated on major changes' },
            { name: 'CLAUDE-PREP-STANDARD.md', desc: 'Session start/end conventions', changeFreq: 'Very low â€” ecosystem-wide standard' },
        ];
        
        // Session docs: change often, upload each time
        const SESSION_DOCS = [
            { name: 'SESSION_BRIEF.md', desc: 'Auto-generated session context with current state', changeFreq: 'Every session â€” auto-generated' },
            { name: 'PRODUCT_BRIEF.md', desc: 'Auto-generated product description in PM language', changeFreq: 'Every session â€” auto-generated' },
            { name: 'CHANGELOG.md', desc: 'Full version history', changeFreq: 'Every deploy â€” new entries added' },
            { name: 'RELEASE_NOTES.txt', desc: 'Human-readable release notes', changeFreq: 'Every deploy â€” new entries added' },
            { name: 'PROJECT_PLAN.md', desc: 'Roadmap and planned features', changeFreq: 'Moderate â€” updated as scope evolves' },
            { name: 'Source file(s)', desc: 'index.html, sw.js, etc.', changeFreq: 'Every session â€” actively modified' },
        ];
        
        // === TOKEN SAVINGS CALCULATION ===
        const getTokenSavings = React.useCallback((app) => {
            // Estimate tokens for persistent docs based on typical sizes
            const persistentTokenEstimates = {
                'CONTEXT.md': 12000,       // ~35KB typical
                'CLAUDE_INSTRUCTIONS.md': 4000,  // ~12KB typical
                'PRODUCT_BRIEF.md': 3000,  // ~8KB typical (Phase 5.5)
                'ARCHITECTURE.md': 6000,    // ~18KB typical
                'CLAUDE-PREP-STANDARD.md': 3500,  // ~10KB typical
            };
            
            // Check if app has these docs (approximate â€” we can't scan repo here)
            const hasInstructions = app.lifecycle?.scope; // If scoped, likely has CLAUDE_INSTRUCTIONS.md
            const hasArchitecture = app.lifecycle?.complexity === 'large' || app.lifecycle?.complexity === 'medium';
            
            let persistentTokens = persistentTokenEstimates['CONTEXT.md'] + persistentTokenEstimates['CLAUDE-PREP-STANDARD.md'];
            if (hasInstructions) persistentTokens += persistentTokenEstimates['CLAUDE_INSTRUCTIONS.md'];
            if (hasArchitecture) persistentTokens += persistentTokenEstimates['ARCHITECTURE.md'];
            
            // Project Knowledge docs are included for free (don't count against context)
            // But they save the time/tokens of uploading them each session
            const sessionsPerMonth = 4; // Conservative estimate
            const sessions = (globalSessions || []).filter(s => s.appId === app.id);
            const actualSessionsPerMonth = sessions.length > 0 
                ? Math.max(1, Math.round(sessions.length / Math.max(1, (Date.now() - new Date(sessions[0]?.createdAt || Date.now()).getTime()) / (30 * 24 * 60 * 60 * 1000))))
                : sessionsPerMonth;
            
            const monthlySavings = persistentTokens * actualSessionsPerMonth;
            
            // Cost savings
            const engine = EngineRegistryService.ENGINES[EngineRegistryService.getDefault()];
            const costPerToken = engine ? engine.cost.input / 1000000 : 0.003;
            const monthlyCostSavings = monthlySavings * costPerToken;
            
            return {
                persistentTokens,
                sessionsPerMonth: actualSessionsPerMonth,
                monthlySavings,
                monthlyCostSavings,
                hasCLAUDE_INSTRUCTIONS: hasInstructions,
                hasArchitecture
            };
        }, [globalSessions]);
        
        // === SKILLS RECOMMENDATIONS ===
        const getSkillRecommendations = React.useCallback((app) => {
            const category = app.lifecycle?.scope?.category || app.appType;
            const scope = app.lifecycle?.scope || {};
            const skills = [];
            
            // Project-aware: recommend skills based on project ecosystem
            const project = config?.projects?.[app.project];
            if (project) {
                // If project has a custom skill config, use it; otherwise derive from category
                if (project.skills && Array.isArray(project.skills)) {
                    project.skills.forEach(s => skills.push({ ...s, reason: `${project.name} ecosystem` }));
                } else if (app.project === 'gameshelf') {
                    // Game Shelf specific (backward compat â€” will be configurable per project later)
                    skills.push({ name: 'gs-active', desc: 'Archive structure and deployment conventions', relevance: 'high', reason: `${project.name} ecosystem` });
                }
            }
            
            // Category-driven (universal â€” not ecosystem-specific)
            if (category === 'game') {
                if (!skills.find(s => s.name === 'game-rules')) {
                    skills.push({ name: 'game-rules', desc: 'Game mechanics and rules reference', relevance: 'high', reason: 'Game app category' });
                }
                skills.push({ name: 'firebase-patterns', desc: 'Firebase RTDB structure for game data', relevance: 'high', reason: 'Game data persistence' });
                skills.push({ name: 'ui-components', desc: 'Dark mode styling, modals, buttons', relevance: 'medium', reason: 'Consistent game UI' });
            }
            
            if (category === 'tool' || category === 'admin' || category === 'dashboard') {
                skills.push({ name: 'ui-components', desc: 'Dark mode styling, modals, buttons', relevance: 'high', reason: 'Tool UI patterns' });
            }
            
            // If has Firebase
            if (scope.categoryAnswers?.multiplayer || scope.categoryAnswers?.dataPersistence === 'Firebase' || scope.categoryAnswers?.authRequired) {
                if (!skills.find(s => s.name === 'firebase-patterns')) {
                    skills.push({ name: 'firebase-patterns', desc: 'Firebase RTDB structure', relevance: 'high', reason: 'Firebase integration' });
                }
            }
            
            // Logo skill for ecosystem branding (only for GS)
            if (app.project === 'gameshelf') {
                skills.push({ name: 'gs-logos', desc: 'Game Shelf logo assets and usage', relevance: 'low', reason: 'Ecosystem branding' });
            }
            
            // Session continuity for complex apps
            if (app.lifecycle?.complexity === 'large' || app.lifecycle?.complexity === 'medium') {
                skills.push({ name: 'session-continuity', desc: 'Recovery protocol after session compaction', relevance: 'medium', reason: 'Complex app â€” long sessions likely' });
            }
            
            return skills;
        }, [config]);
        
        // === PLATFORM FEATURE RECOMMENDATIONS ===
        const getPlatformRecommendations = React.useCallback((app) => {
            const engine = EngineRegistryService.ENGINES[EngineRegistryService.getDefault()];
            const features = engine?.features || {};
            const recs = [];
            
            if (features.projects) {
                recs.push({
                    feature: 'Claude Project',
                    icon: 'ðŸ“‚',
                    status: 'recommended',
                    reason: 'Move persistent docs to Project Knowledge to save tokens every session',
                    setup: 'Create a project per app â†’ add CONTEXT.md, CLAUDE_INSTRUCTIONS.md, ARCHITECTURE.md, CLAUDE-PREP-STANDARD.md as Project Knowledge'
                });
            }
            
            if (features.skills) {
                recs.push({
                    feature: 'Custom Skills',
                    icon: 'ðŸ› ï¸',
                    status: 'recommended',
                    reason: 'Upload ecosystem-specific skills for consistent conventions across sessions',
                    setup: 'Upload skill .md files to the project\'s Custom Instructions or Skills section'
                });
            }
            
            if (features.artifacts) {
                recs.push({
                    feature: 'Artifacts',
                    icon: 'âœ¨',
                    status: 'enabled',
                    reason: 'Enables inline preview of HTML, React, and markdown outputs during build sessions',
                    setup: 'Enabled by default â€” useful for UI work and documentation'
                });
            }
            
            if (features.memory) {
                recs.push({
                    feature: 'Memory',
                    icon: 'ðŸ§ ',
                    status: 'optional',
                    reason: 'Remembers preferences across sessions, but Project Knowledge is more reliable for structured context',
                    setup: 'Enable in settings â€” useful for general preferences, not project-specific data'
                });
            }
            
            if (features.extendedThinking) {
                recs.push({
                    feature: 'Extended Thinking',
                    icon: 'ðŸ’­',
                    status: 'for design sessions',
                    reason: 'Improves architecture and design reasoning â€” enable for Design session types',
                    setup: 'Enable when doing architecture design or complex problem solving'
                });
            }
            
            if (features.computerUse) {
                recs.push({
                    feature: 'Computer Use',
                    icon: 'ðŸ–¥ï¸',
                    status: 'for build sessions',
                    reason: 'File creation and code execution for generating deploy packages',
                    setup: 'Enable when you need Claude to produce files or run tests'
                });
            }
            
            if (features.webSearch) {
                recs.push({
                    feature: 'Web Search',
                    icon: 'ðŸŒ',
                    status: 'for research sessions',
                    reason: 'Useful for research sessions to find API docs, patterns, and best practices',
                    setup: 'Enable for Research session types, disable for Build sessions to keep focus'
                });
            }
            
            return recs;
        }, []);
        
        // === SESSION TYPE ADVICE ===
        const getSessionTypeAdvice = React.useCallback(() => {
            const types = Object.entries(SESSION_TYPES);
            return types.map(([id, t]) => {
                const engine = EngineRegistryService.recommendForSessionType(id);
                return {
                    id,
                    ...t,
                    recommendedEngine: engine,
                    platformTips: id === 'build' 
                        ? 'Enable Computer Use + Artifacts. Disable Web Search. Use Sonnet for speed/quality balance.'
                        : id === 'design'
                        ? 'Enable Extended Thinking. Disable Computer Use. Use Opus for complex architecture.'
                        : id === 'fix'
                        ? 'Enable Computer Use. Include issue details in brief. Use Sonnet. Minimize context â€” skip CHANGELOG.'
                        : id === 'research'
                        ? 'Enable Web Search. Disable Computer Use. Use Haiku for cost efficiency. Skip source files.'
                        : id === 'review'
                        ? 'Enable Extended Thinking. Include full source. Use Sonnet. Focus on quality findings.'
                        : id === 'test'
                        ? 'Enable Computer Use for test execution. Include ARCHITECTURE.md. Use Sonnet.'
                        : id === 'polish'
                        ? 'Enable Artifacts for UI preview. Use Haiku for cost efficiency. Focus on specific areas.'
                        : 'Enable Computer Use. Use Haiku for routine documentation updates.'
                };
            });
        }, []);
        
        // === GENERATE PROJECT INSTRUCTIONS ===
        const generateProjectInstructions = React.useCallback((app) => {
            const scope = app.lifecycle?.scope || {};
            const maturity = app.lifecycle?.currentMaturity || 'unknown';
            const category = scope.category || app.appType || 'tool';
            
            let instructions = `# ${app.name} â€” Claude Project Instructions\n\n`;
            instructions += `## Project Overview\n`;
            instructions += `- **App ID:** ${app.id}\n`;
            instructions += `- **Category:** ${category}\n`;
            instructions += `- **Maturity:** ${maturity}\n`;
            if (scope.description) instructions += `- **Description:** ${scope.description}\n`;
            instructions += `\n`;
            
            instructions += `## Session Protocol\n`;
            instructions += `When starting a session for ${app.name}:\n`;
            instructions += `1. Read the SESSION_BRIEF.md (uploaded each session) for current state\n`;
            instructions += `2. Review any work items or issues being targeted\n`;
            instructions += `3. Confirm the session type (Build/Fix/Design/etc.) and scope\n`;
            instructions += `4. Before finishing, always:\n`;
            instructions += `   - Increment the version number in ALL locations\n`;
            instructions += `   - Update RELEASE_NOTES.txt with what changed\n`;
            instructions += `   - Update CHANGELOG.md with structured entries\n`;
            if (app.hasServiceWorker) {
                instructions += `   - Update sw.js CACHE_VERSION to match the new version\n`;
                instructions += `   - Create a FULL deploy package (index.html + sw.js + manifest.json + icons/)\n`;
            } else {
                instructions += `   - Produce the updated index.html file\n`;
            }
            instructions += `\n`;
            
            instructions += `## Architecture Constraints\n`;
            instructions += `- Single HTML file â€” all CSS, JS inline (no external files except CDN)\n`;
            instructions += `- React via CDN (no build step)\n`;
            instructions += `- Runs from file:// and GitHub Pages\n`;
            if (app.hasServiceWorker) {
                instructions += `- PWA with service worker â€” CACHE_VERSION must match app version\n`;
            }
            instructions += `- Dark mode default with CSS variables\n`;
            instructions += `- Mobile-first responsive design\n`;
            instructions += `\n`;
            
            instructions += `## Version Format\n`;
            instructions += `MAJOR.MINOR.PATCH â€” Patch for fixes, Minor for features, Major for breaking changes.\n`;
            instructions += `Version appears in: <meta name="version">, const APP_VERSION, UI display, sw.js CACHE_VERSION.\n`;
            instructions += `\n`;
            
            if (scope.startingStandards && scope.startingStandards.length > 0) {
                instructions += `## Starting Standards\n`;
                scope.startingStandards.forEach(std => {
                    const stdDesc = STANDARD_DESCRIPTIONS?.[std] || std;
                    instructions += `- ${stdDesc}\n`;
                });
                instructions += `\n`;
            }
            
            instructions += `## What NOT to Do\n`;
            instructions += `- Do not use native alert(), confirm(), or prompt() â€” use toast notifications\n`;
            instructions += `- Do not hardcode colors â€” use CSS variables\n`;
            instructions += `- Do not forget to update ALL version locations\n`;
            if (app.hasServiceWorker) {
                instructions += `- Do not output just index.html for PWA â€” always include sw.js, manifest, icons\n`;
            }
            instructions += `- Do not refactor code outside the scope of the current session\n`;
            
            return instructions;
        }, []);
        
        // === COPY HELPER ===
        const copyToClipboard = React.useCallback((text, section) => {
            navigator.clipboard.writeText(text).then(() => {
                setCopiedSection(section);
                setTimeout(() => setCopiedSection(null), 2000);
            }).catch(() => showAlert('Failed to copy to clipboard', 'error'));
        }, [showAlert]);
        
        // Helper: colored badge
        const RelevanceBadge = ({ level }) => {
            const colors = { high: 'bg-green-600/20 text-green-400 border-green-600/30', medium: 'bg-blue-600/20 text-blue-400 border-blue-600/30', low: 'bg-slate-600/20 text-slate-400 border-slate-600/30' };
            return <span className={`text-xs px-2 py-0.5 rounded border ${colors[level] || colors.low}`}>{level}</span>;
        };
        
        const StatusBadge = ({ status }) => {
            const colors = { 
                recommended: 'bg-green-600/20 text-green-400', 
                enabled: 'bg-blue-600/20 text-blue-400', 
                optional: 'bg-slate-600/20 text-slate-400',
                'for design sessions': 'bg-purple-600/20 text-purple-400',
                'for build sessions': 'bg-amber-600/20 text-amber-400',
                'for research sessions': 'bg-cyan-600/20 text-cyan-400'
            };
            return <span className={`text-xs px-2 py-0.5 rounded ${colors[status] || colors.optional}`}>{status}</span>;
        };
        
        // Copy button helper
        const CopyBtn = ({ text, section, label }) => (
            <button 
                onClick={() => copyToClipboard(text, section)}
                className={`text-xs px-3 py-1 rounded transition-colors ${copiedSection === section ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
            >
                {copiedSection === section ? 'âœ“ Copied' : (label || 'ðŸ“‹ Copy')}
            </button>
        );
        
        return (
            <div className="max-w-6xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                        <span className="text-2xl">ðŸŽ¯</span>
                        <div>
                            <h1 className="text-2xl font-bold">Setup Guide</h1>
                            <p className="text-slate-400 text-sm">Configure Claude Projects, skills, and platform features for maximum efficiency</p>
                        </div>
                    </div>
                </div>
                
                {/* App Selector */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-5 mb-6">
                    <h3 className="font-semibold mb-3 flex items-center gap-2">ðŸ“¦ Select an App</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                        {sortedApps.map(app => {
                            const sessions = (globalSessions || []).filter(s => s.appId === app.id);
                            const maturity = app.lifecycle?.currentMaturity;
                            const matColors = { seed: 'border-slate-600', prototype: 'border-amber-600', alpha: 'border-orange-600', beta: 'border-blue-600', production: 'border-green-600' };
                            return (
                                <button key={app.id}
                                    onClick={() => setSelectedAppId(app.id === selectedAppId ? null : app.id)}
                                    className={`p-3 rounded-lg border text-left transition-all ${
                                        app.id === selectedAppId 
                                            ? 'bg-indigo-600/20 border-indigo-500 ring-1 ring-indigo-500/50' 
                                            : `bg-slate-900/50 ${matColors[maturity] || 'border-slate-700'} hover:bg-slate-700/50`
                                    }`}
                                >
                                    <div className="flex items-center gap-2 mb-1">
                                        <AppIcon icon={app.icon} size={18} />
                                        <span className="font-medium text-sm truncate">{app.name}</span>
                                    </div>
                                    <div className="text-xs text-slate-500">{sessions.length} session{sessions.length !== 1 ? 's' : ''}{maturity ? ` Â· ${maturity}` : ''}</div>
                                </button>
                            );
                        })}
                    </div>
                </div>
                
                {/* No app selected â€” show overview */}
                {!selectedApp && (
                    <div className="space-y-6">
                        {/* Session Type Quick Reference */}
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                            <h3 className="font-semibold mb-4 flex items-center gap-2">âš¡ Session Type Quick Reference</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="border-b border-slate-700 text-left">
                                            <th className="py-2 px-3 text-slate-400 font-medium">Type</th>
                                            <th className="py-2 px-3 text-slate-400 font-medium">Engine</th>
                                            <th className="py-2 px-3 text-slate-400 font-medium">Platform Tips</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {getSessionTypeAdvice().map(t => (
                                            <tr key={t.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                <td className="py-2.5 px-3">
                                                    <span className="font-medium">{t.icon} {t.label}</span>
                                                    <div className="text-xs text-slate-500 mt-0.5">{t.description}</div>
                                                </td>
                                                <td className="py-2.5 px-3 text-slate-300">{t.recommendedEngine?.name || 'Sonnet'}</td>
                                                <td className="py-2.5 px-3 text-slate-400 text-xs">{t.platformTips}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        {/* General Platform Recommendations */}
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                            <h3 className="font-semibold mb-4 flex items-center gap-2">ðŸ› ï¸ Platform Feature Guide</h3>
                            <div className="space-y-3">
                                {getPlatformRecommendations({ lifecycle: {} }).map((rec, idx) => (
                                    <div key={idx} className="flex items-start gap-3 p-3 bg-slate-900/50 rounded-lg">
                                        <span className="text-xl mt-0.5">{rec.icon}</span>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="font-medium text-sm">{rec.feature}</span>
                                                <StatusBadge status={rec.status} />
                                            </div>
                                            <p className="text-xs text-slate-400 mb-1">{rec.reason}</p>
                                            <p className="text-xs text-slate-500">{rec.setup}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="text-center text-slate-500 text-sm py-4">
                            ðŸ‘† Select an app above for a detailed per-app optimization guide
                        </div>
                    </div>
                )}
                
                {/* Per-App Optimization Guide */}
                {selectedApp && (() => {
                    const savings = getTokenSavings(selectedApp);
                    const skills = getSkillRecommendations(selectedApp);
                    const platformRecs = getPlatformRecommendations(selectedApp);
                    const projectInstructions = generateProjectInstructions(selectedApp);
                    
                    return (
                        <div className="space-y-6">
                            {/* Token Savings Summary */}
                            <div className="bg-gradient-to-r from-indigo-900/30 to-purple-900/30 rounded-xl border border-indigo-700/30 p-5">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">ðŸ’° Token Savings with Claude Project</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800/60 rounded-lg p-3">
                                        <div className="text-xs text-slate-400 mb-1">Persistent Docs</div>
                                        <div className="text-xl font-bold text-green-400">{TokenRegistryService.formatTokens(savings.persistentTokens)}</div>
                                        <div className="text-xs text-slate-500">tokens saved per session</div>
                                    </div>
                                    <div className="bg-slate-800/60 rounded-lg p-3">
                                        <div className="text-xs text-slate-400 mb-1">Sessions/Month</div>
                                        <div className="text-xl font-bold">{savings.sessionsPerMonth}</div>
                                        <div className="text-xs text-slate-500">estimated average</div>
                                    </div>
                                    <div className="bg-slate-800/60 rounded-lg p-3">
                                        <div className="text-xs text-slate-400 mb-1">Monthly Savings</div>
                                        <div className="text-xl font-bold text-green-400">{TokenRegistryService.formatTokens(savings.monthlySavings)}</div>
                                        <div className="text-xs text-slate-500">tokens/month</div>
                                    </div>
                                    <div className="bg-slate-800/60 rounded-lg p-3">
                                        <div className="text-xs text-slate-400 mb-1">Cost Savings</div>
                                        <div className="text-xl font-bold text-green-400">${savings.monthlyCostSavings.toFixed(2)}</div>
                                        <div className="text-xs text-slate-500">est. per month</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Doc Classification */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Persistent Docs â†’ Project Knowledge */}
                                <div className="bg-slate-800 rounded-xl border border-green-700/30 p-5">
                                    <h3 className="font-semibold mb-3 flex items-center gap-2 text-green-400">
                                        ðŸ“Œ Project Knowledge <span className="text-xs font-normal text-slate-500">(add once, rarely update)</span>
                                    </h3>
                                    <p className="text-xs text-slate-400 mb-3">
                                        These docs rarely change and should be added to your Claude Project's Knowledge section. 
                                        They'll be available automatically in every conversation â€” no upload needed.
                                    </p>
                                    <div className="space-y-2">
                                        {PERSISTENT_DOCS.map(doc => (
                                            <div key={doc.name} className="flex items-center gap-3 p-2.5 bg-slate-900/50 rounded-lg">
                                                <span className="text-green-500">ðŸ“„</span>
                                                <div className="flex-1">
                                                    <div className="font-mono text-sm text-green-300">{doc.name}</div>
                                                    <div className="text-xs text-slate-500">{doc.desc}</div>
                                                </div>
                                                <div className="text-xs text-slate-600 text-right whitespace-nowrap">{doc.changeFreq}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Session Docs â†’ Upload Each Time */}
                                <div className="bg-slate-800 rounded-xl border border-amber-700/30 p-5">
                                    <h3 className="font-semibold mb-3 flex items-center gap-2 text-amber-400">
                                        ðŸ“¤ Upload Each Session <span className="text-xs font-normal text-slate-500">(changes frequently)</span>
                                    </h3>
                                    <p className="text-xs text-slate-400 mb-3">
                                        These docs change frequently and should be uploaded from your Claude Prep package at the start of each session.
                                        The Session Wizard bundles these automatically.
                                    </p>
                                    <div className="space-y-2">
                                        {SESSION_DOCS.map(doc => (
                                            <div key={doc.name} className="flex items-center gap-3 p-2.5 bg-slate-900/50 rounded-lg">
                                                <span className="text-amber-500">ðŸ“„</span>
                                                <div className="flex-1">
                                                    <div className="font-mono text-sm text-amber-300">{doc.name}</div>
                                                    <div className="text-xs text-slate-500">{doc.desc}</div>
                                                </div>
                                                <div className="text-xs text-slate-600 text-right whitespace-nowrap">{doc.changeFreq}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Recommended Skills */}
                            <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">ðŸ› ï¸ Recommended Skills</h3>
                                <p className="text-xs text-slate-400 mb-3">
                                    Skills are reusable instruction sets that help Claude follow ecosystem conventions. 
                                    Upload these to your Claude Project for consistent behavior across sessions.
                                </p>
                                <div className="space-y-2">
                                    {skills.map((skill, idx) => (
                                        <div key={idx} className="flex items-center gap-3 p-2.5 bg-slate-900/50 rounded-lg">
                                            <span>ðŸ“¦</span>
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-mono text-sm text-slate-200">{skill.name}</span>
                                                    <RelevanceBadge level={skill.relevance} />
                                                </div>
                                                <div className="text-xs text-slate-500">{skill.desc}</div>
                                            </div>
                                            <div className="text-xs text-slate-600 text-right">{skill.reason}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Platform Features */}
                            <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">âš¡ Platform Features for {selectedApp.name}</h3>
                                <div className="space-y-2">
                                    {platformRecs.map((rec, idx) => (
                                        <div key={idx} className="flex items-start gap-3 p-3 bg-slate-900/50 rounded-lg">
                                            <span className="text-xl mt-0.5">{rec.icon}</span>
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="font-medium text-sm">{rec.feature}</span>
                                                    <StatusBadge status={rec.status} />
                                                </div>
                                                <p className="text-xs text-slate-400 mb-1">{rec.reason}</p>
                                                <p className="text-xs text-slate-500">{rec.setup}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Generated Project Instructions */}
                            <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="font-semibold flex items-center gap-2">ðŸ“ Recommended Project Instructions</h3>
                                    <CopyBtn text={projectInstructions} section="instructions" label="ðŸ“‹ Copy Instructions" />
                                </div>
                                <p className="text-xs text-slate-400 mb-3">
                                    Paste these into your Claude Project's Custom Instructions field. 
                                    This ensures Claude follows your conventions without including it in the session package.
                                </p>
                                <div className="bg-slate-900 rounded-lg border border-slate-700 p-4 max-h-80 overflow-y-auto">
                                    <pre className="text-xs text-slate-300 whitespace-pre-wrap font-mono leading-relaxed">{projectInstructions}</pre>
                                </div>
                            </div>
                            
                            {/* Setup Checklist */}
                            <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">âœ… Setup Checklist for {selectedApp.name}</h3>
                                <div className="space-y-2">
                                    {[
                                        { step: `Create a Claude Project named "${selectedApp.name}"`, detail: 'One project per app keeps context focused and organized' },
                                        { step: 'Paste Project Instructions (above) into Custom Instructions', detail: 'Establishes session protocol, architecture constraints, versioning rules' },
                                        { step: 'Upload persistent docs as Project Knowledge', detail: `Add: ${PERSISTENT_DOCS.map(d => d.name).join(', ')}` },
                                        { step: 'Upload recommended skills as Project Knowledge', detail: `Add: ${skills.filter(s => s.relevance === 'high').map(s => s.name + '.md').join(', ')}` },
                                        { step: 'Use Claude Prep Session Wizard for each session', detail: 'Generates SESSION_BRIEF.md and bundles session docs automatically' },
                                        { step: 'Upload session docs at the start of each conversation', detail: `Upload the generated zip â€” includes: ${SESSION_DOCS.map(d => d.name).join(', ')}` },
                                    ].map((item, idx) => (
                                        <div key={idx} className="flex items-start gap-3 p-3 bg-slate-900/50 rounded-lg">
                                            <div className="w-6 h-6 rounded-full bg-indigo-600/30 border border-indigo-500/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <span className="text-xs text-indigo-300 font-bold">{idx + 1}</span>
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium">{item.step}</div>
                                                <div className="text-xs text-slate-500 mt-0.5">{item.detail}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    );
                })()}
            </div>
        );
    }
    function UsersView({ showAlert }) {
        const [userStats, setUserStats] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        
        const loadUserStats = async () => {
            if (!firebaseAuth?.currentUser) {
                setError('Sign in required');
                return;
            }
            setLoading(true);
            setError(null);
            try {
                const getUserStats = firebase.functions().httpsCallable('getUserStats');
                const result = await getUserStats();
                setUserStats({
                    ...result.data,
                    lastUpdated: new Date().toISOString()
                });
            } catch (e) {
                console.error('Failed to load user stats:', e);
                setError(e.message || 'Failed to load stats');
            }
            setLoading(false);
        };
        
        // Auto-load on mount
        React.useEffect(() => {
            loadUserStats();
        }, []);
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        ðŸ‘¥ User Statistics
                    </h2>
                    <button
                        onClick={loadUserStats}
                        disabled={loading}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                    >
                        {loading ? 'â³ Loading...' : 'ðŸ”„ Refresh'}
                    </button>
                </div>
                
                {error && (
                    <div className="bg-red-900/30 border border-red-700 rounded-lg p-4 text-red-400">
                        âš ï¸ {error}
                    </div>
                )}
                
                {!userStats && !error && !loading && (
                    <div className="bg-slate-800 rounded-xl p-8 text-center text-slate-500">
                        Click Refresh to load user statistics
                    </div>
                )}
                
                {loading && !userStats && (
                    <div className="bg-slate-800 rounded-xl p-8 text-center text-slate-400">
                        <div className="animate-pulse">Loading user statistics...</div>
                    </div>
                )}
                
                {userStats && (
                    <div className="space-y-6">
                        {/* Main Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div className="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 rounded-xl p-6 border border-indigo-700">
                                <div className="text-4xl font-bold text-indigo-400">{userStats.total?.toLocaleString() || 0}</div>
                                <div className="text-sm text-slate-400 mt-1">Total Registered Users</div>
                            </div>
                            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <div className="text-4xl font-bold text-green-400">{userStats.activeMonth || 0}</div>
                                <div className="text-sm text-slate-400 mt-1">Active (30 days)</div>
                            </div>
                            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <div className="text-4xl font-bold text-blue-400">{userStats.activeWeek || 0}</div>
                                <div className="text-sm text-slate-400 mt-1">Active (7 days)</div>
                            </div>
                            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <div className="text-4xl font-bold text-amber-400">{userStats.activeToday || 0}</div>
                                <div className="text-sm text-slate-400 mt-1">Active Today</div>
                            </div>
                        </div>
                        
                        {/* Growth Stats */}
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="font-semibold mb-4">ðŸ“ˆ Growth</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="text-center p-4 bg-slate-900 rounded-lg">
                                    <div className="text-2xl font-bold text-emerald-400">+{userStats.newToday || 0}</div>
                                    <div className="text-xs text-slate-500">New Today</div>
                                </div>
                                <div className="text-center p-4 bg-slate-900 rounded-lg">
                                    <div className="text-2xl font-bold text-teal-400">+{userStats.newWeek || 0}</div>
                                    <div className="text-xs text-slate-500">New This Week</div>
                                </div>
                                <div className="text-center p-4 bg-slate-900 rounded-lg">
                                    <div className="text-2xl font-bold text-cyan-400">
                                        {userStats.total > 0 ? Math.round((userStats.activeMonth / userStats.total) * 100) : 0}%
                                    </div>
                                    <div className="text-xs text-slate-500">30-Day Retention</div>
                                </div>
                                <div className="text-center p-4 bg-slate-900 rounded-lg">
                                    <div className="text-2xl font-bold text-violet-400">
                                        {userStats.total > 0 ? Math.round((userStats.activeWeek / userStats.total) * 100) : 0}%
                                    </div>
                                    <div className="text-xs text-slate-500">7-Day Retention</div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Last Updated */}
                        {userStats.lastUpdated && (
                            <div className="text-xs text-slate-500 text-right">
                                Last updated: {new Date(userStats.lastUpdated).toLocaleString()}
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }
    function BetaAnalyticsView({ showAlert }) {
        const [betaUsers, setBetaUsers] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [activeTab, setActiveTab] = React.useState('overview');
        const [expandedUser, setExpandedUser] = React.useState(null);
        const [surveyFilter, setSurveyFilter] = React.useState('all');
        
        const loadBetaData = async () => {
            if (!firebaseAuth?.currentUser) {
                setError('Sign in required');
                return;
            }
            setLoading(true);
            setError(null);
            try {
                const getBetaAnalytics = firebase.functions().httpsCallable('getBetaAnalytics');
                const result = await getBetaAnalytics();
                setBetaUsers(result.data.betaUsers || []);
            } catch (e) {
                console.error('Failed to load beta data:', e);
                setError(e.message || 'Failed to load beta data');
            }
            setLoading(false);
        };
        
        React.useEffect(() => { loadBetaData(); }, []);
        
        // Aggregate onboarding stats
        const onboardingStats = React.useMemo(() => {
            const stats = {
                total: betaUsers.length,
                completedOnboarding: 0,
                sources: {},
                experience: {},
                games: {},
                frequency: {},
                devices: {},
                sharing: {},
                shareWhere: {},
                hints: {},
                compete: {},
                frustrations: {},
                dailyUseResponses: [],
                otherTexts: { source: [], games: [], shareWhere: [], frustration: [] }
            };
            
            betaUsers.forEach(u => {
                const ob = u.earlyAccess?.onboarding;
                if (!ob || !ob.completedAt) return;
                stats.completedOnboarding++;
                
                // Count each field
                if (ob.source) stats.sources[ob.source] = (stats.sources[ob.source] || 0) + 1;
                if (ob.sourceOther) stats.otherTexts.source.push({ user: u.displayName, text: ob.sourceOther });
                
                if (ob.experience) stats.experience[ob.experience] = (stats.experience[ob.experience] || 0) + 1;
                
                if (Array.isArray(ob.games)) {
                    ob.games.forEach(g => { stats.games[g] = (stats.games[g] || 0) + 1; });
                }
                if (ob.gamesOther) stats.otherTexts.games.push({ user: u.displayName, text: ob.gamesOther });
                
                if (ob.frequency) stats.frequency[ob.frequency] = (stats.frequency[ob.frequency] || 0) + 1;
                if (ob.device) stats.devices[ob.device] = (stats.devices[ob.device] || 0) + 1;
                if (ob.sharing) stats.sharing[ob.sharing] = (stats.sharing[ob.sharing] || 0) + 1;
                
                if (Array.isArray(ob.shareWhere)) {
                    ob.shareWhere.forEach(s => { stats.shareWhere[s] = (stats.shareWhere[s] || 0) + 1; });
                }
                if (ob.shareWhereOther) stats.otherTexts.shareWhere.push({ user: u.displayName, text: ob.shareWhereOther });
                
                if (ob.hints) stats.hints[ob.hints] = (stats.hints[ob.hints] || 0) + 1;
                if (ob.compete) stats.compete[ob.compete] = (stats.compete[ob.compete] || 0) + 1;
                if (ob.frustration) stats.frustrations[ob.frustration] = (stats.frustrations[ob.frustration] || 0) + 1;
                if (ob.frustrationOther) stats.otherTexts.frustration.push({ user: u.displayName, text: ob.frustrationOther });
                
                if (ob.dailyUse) stats.dailyUseResponses.push({ user: u.displayName, text: ob.dailyUse });
            });
            
            return stats;
        }, [betaUsers]);
        
        // Aggregate survey stats
        const surveyStats = React.useMemo(() => {
            const allRatings = [];
            const byDate = {};
            const byUser = {};
            
            betaUsers.forEach(u => {
                const surveys = u.earlyAccess?.surveys;
                if (!surveys) return;
                byUser[u.displayName] = [];
                
                Object.entries(surveys).forEach(([date, data]) => {
                    const entry = { user: u.displayName, date, rating: data.rating, feedback: data.feedback || '' };
                    allRatings.push(entry);
                    if (!byDate[date]) byDate[date] = [];
                    byDate[date].push(entry);
                    byUser[u.displayName].push(entry);
                });
            });
            
            allRatings.sort((a, b) => b.date.localeCompare(a.date));
            
            const avg = allRatings.length > 0 
                ? (allRatings.reduce((sum, r) => sum + r.rating, 0) / allRatings.length).toFixed(1) 
                : 'â€”';
            
            const distribution = [0, 0, 0, 0, 0];
            allRatings.forEach(r => { if (r.rating >= 1 && r.rating <= 5) distribution[r.rating - 1]++; });
            
            const withFeedback = allRatings.filter(r => r.feedback);
            
            return { allRatings, byDate, byUser, avg, distribution, withFeedback, total: allRatings.length };
        }, [betaUsers]);
        
        // Helper: render a bar chart for key-value data
        const renderBarChart = (data, labelMap = null) => {
            const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
            const max = entries.length > 0 ? entries[0][1] : 1;
            return entries.map(([key, count]) => (
                <div key={key} className="flex items-center gap-2 mb-1.5">
                    <div className="text-xs text-slate-400 w-28 truncate text-right" title={labelMap?.[key] || key}>
                        {labelMap?.[key] || key}
                    </div>
                    <div className="flex-1 h-5 bg-slate-900 rounded overflow-hidden">
                        <div 
                            className="h-full bg-indigo-600 rounded flex items-center justify-end pr-1.5"
                            style={{ width: `${Math.max((count / max) * 100, 12)}%` }}
                        >
                            <span className="text-[10px] text-white font-bold">{count}</span>
                        </div>
                    </div>
                </div>
            ));
        };
        
        // Helper: format timestamp
        const fmtDate = (ts) => {
            if (!ts) return 'â€”';
            return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };
        
        const fmtDaysAgo = (ts) => {
            if (!ts) return '';
            const days = Math.floor((Date.now() - ts) / (1000 * 60 * 60 * 24));
            if (days === 0) return 'today';
            if (days === 1) return '1 day ago';
            return `${days} days ago`;
        };
        
        const tabs = [
            { id: 'overview', label: 'ðŸ“Š Overview' },
            { id: 'onboarding', label: 'ðŸ“ Onboarding' },
            { id: 'surveys', label: 'â­ Surveys' },
            { id: 'users', label: 'ðŸ‘¤ Users' },
            { id: 'goldq', label: 'ðŸ’¡ Gold Question' }
        ];
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">ðŸ§ª Beta Program Analytics</h2>
                    <button onClick={loadBetaData} disabled={loading}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50">
                        {loading ? 'â³ Loading...' : 'ðŸ”„ Refresh'}
                    </button>
                </div>
                
                {error && <div className="bg-red-900/30 border border-red-700 rounded-lg p-4 text-red-400">âš ï¸ {error}</div>}
                
                {loading && !betaUsers.length && (
                    <div className="bg-slate-800 rounded-xl p-8 text-center text-slate-400 animate-pulse">Loading beta data...</div>
                )}
                
                {/* Tabs */}
                {betaUsers.length > 0 && (
                    <div className="space-y-6">
                        <div className="flex gap-1 bg-slate-800/50 p-1 rounded-lg">
                            {tabs.map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)}
                                    className={`px-3 py-1.5 rounded text-sm font-medium transition-colors ${
                                        activeTab === t.id ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'
                                    }`}>{t.label}</button>
                            ))}
                        </div>
                        
                        {/* ---- OVERVIEW TAB ---- */}
                        {activeTab === 'overview' && (
                            <div className="space-y-6">
                                {/* Key Metrics */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 rounded-xl p-5 border border-indigo-700 text-center">
                                        <div className="text-3xl font-bold text-indigo-400">{onboardingStats.total}</div>
                                        <div className="text-xs text-slate-400 mt-1">Beta Users</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700 text-center">
                                        <div className="text-3xl font-bold text-green-400">{onboardingStats.completedOnboarding}</div>
                                        <div className="text-xs text-slate-400 mt-1">Completed Onboarding</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700 text-center">
                                        <div className="text-3xl font-bold text-amber-400">{surveyStats.total}</div>
                                        <div className="text-xs text-slate-400 mt-1">Survey Responses</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700 text-center">
                                        <div className="text-3xl font-bold text-cyan-400">{surveyStats.avg}</div>
                                        <div className="text-xs text-slate-400 mt-1">Avg Rating (1-5)</div>
                                    </div>
                                </div>
                                
                                {/* Rating Distribution */}
                                {surveyStats.total > 0 && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                        <h3 className="font-semibold mb-4">â­ Rating Distribution</h3>
                                        <div className="flex items-end gap-3 justify-center h-32">
                                            {surveyStats.distribution.map((count, i) => {
                                                const maxCount = Math.max(...surveyStats.distribution, 1);
                                                const height = (count / maxCount) * 100;
                                                const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-lime-500', 'bg-green-500'];
                                                return (
                                                    <div key={i} className="flex flex-col items-center gap-1 flex-1 max-w-16">
                                                        <span className="text-xs text-slate-400 font-bold">{count}</span>
                                                        <div className={`w-full ${colors[i]} rounded-t`}
                                                            style={{ height: `${Math.max(height, 4)}%`, minHeight: '4px' }}></div>
                                                        <span className="text-xs text-slate-500">{i + 1}â˜…</span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Recent Feedback */}
                                {surveyStats.withFeedback.length > 0 && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                        <h3 className="font-semibold mb-4">ðŸ’¬ Recent Feedback ({surveyStats.withFeedback.length})</h3>
                                        <div className="space-y-3 max-h-64 overflow-y-auto">
                                            {surveyStats.withFeedback.slice(0, 10).map((r, i) => (
                                                <div key={i} className="bg-slate-900 rounded-lg p-3">
                                                    <div className="flex items-center justify-between mb-1">
                                                        <span className="text-sm font-medium text-slate-300">{r.user}</span>
                                                        <span className="text-xs text-slate-500">{r.date} Â· {'â­'.repeat(r.rating)}</span>
                                                    </div>
                                                    <div className="text-sm text-slate-400">{r.feedback}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* ---- ONBOARDING TAB ---- */}
                        {activeTab === 'onboarding' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* How did you find GS? */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ” How did you find Game Shelf?</h3>
                                        {renderBarChart(onboardingStats.sources, {
                                            'friend': 'Friend', 'dave': 'Dave told me', 'social': 'Social Media',
                                            'search': 'Search', 'app-store': 'App Store', 'other': 'Other'
                                        })}
                                        {onboardingStats.otherTexts.source.length > 0 && (
                                            <div className="mt-2 text-xs text-slate-500">
                                                Other: {onboardingStats.otherTexts.source.map(o => `"${o.text}" (${o.user})`).join(', ')}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Experience */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">â³ How long playing daily puzzles?</h3>
                                        {renderBarChart(onboardingStats.experience, {
                                            'new': 'Brand new', 'months': 'A few months', 'year': 'About a year', 'years': '2+ years'
                                        })}
                                    </div>
                                    
                                    {/* Games played */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸŽ® What puzzles do you play?</h3>
                                        {renderBarChart(onboardingStats.games)}
                                        {onboardingStats.otherTexts.games.length > 0 && (
                                            <div className="mt-2 text-xs text-slate-500">
                                                Other: {onboardingStats.otherTexts.games.map(o => `"${o.text}" (${o.user})`).join(', ')}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Frequency */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ“Š How many puzzles per day?</h3>
                                        {renderBarChart(onboardingStats.frequency, {
                                            '1': 'Just 1', '2-3': '2-3 games', '4-5': '4-5 games', '6+': '6+ games'
                                        })}
                                    </div>
                                    
                                    {/* Device */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ“± Primary device?</h3>
                                        {renderBarChart(onboardingStats.devices, {
                                            'iphone': 'iPhone', 'android': 'Android', 'ipad': 'iPad', 
                                            'desktop': 'Desktop', 'multiple': 'Multiple'
                                        })}
                                    </div>
                                    
                                    {/* Sharing */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ“¤ Do you share results?</h3>
                                        {renderBarChart(onboardingStats.sharing, {
                                            'daily': 'Daily', 'sometimes': 'Sometimes', 'rarely': 'Rarely', 'never': 'Never'
                                        })}
                                    </div>
                                    
                                    {/* Where share */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ’¬ Where do you share?</h3>
                                        {renderBarChart(onboardingStats.shareWhere, {
                                            'imessage': 'iMessage', 'twitter': 'Twitter/X', 'discord': 'Discord',
                                            'facebook': 'Facebook', 'slack': 'Slack', 'whatsapp': 'WhatsApp', 'other': 'Other'
                                        })}
                                    </div>
                                    
                                    {/* Hints */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ’¡ Do you look up hints?</h3>
                                        {renderBarChart(onboardingStats.hints, {
                                            'never': 'Never', 'rarely': 'Rarely', 'sometimes': 'Sometimes', 'often': 'Often'
                                        })}
                                    </div>
                                    
                                    {/* Compete */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ† Do you compete with others?</h3>
                                        {renderBarChart(onboardingStats.compete, {
                                            'yes-regular': 'Yes, regularly', 'yes-casual': 'Casually', 
                                            'want-to': 'Want to', 'no': 'No'
                                        })}
                                    </div>
                                    
                                    {/* Frustrations */}
                                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                        <h3 className="font-semibold mb-3 text-sm">ðŸ˜¤ Biggest frustration?</h3>
                                        {renderBarChart(onboardingStats.frustrations, {
                                            'no-tracking': 'No tracking across games', 'scattered': 'Games scattered everywhere',
                                            'no-compare': "Can't compare with friends", 'no-hints': 'No good hints',
                                            'manual-share': 'Manual sharing is tedious', 'other': 'Other'
                                        })}
                                        {onboardingStats.otherTexts.frustration.length > 0 && (
                                            <div className="mt-2 text-xs text-slate-500">
                                                Other: {onboardingStats.otherTexts.frustration.map(o => `"${o.text}" (${o.user})`).join(', ')}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* ---- SURVEYS TAB ---- */}
                        {activeTab === 'surveys' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                                        <div className="text-2xl font-bold text-amber-400">{surveyStats.total}</div>
                                        <div className="text-xs text-slate-400">Total Responses</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                                        <div className="text-2xl font-bold text-cyan-400">{surveyStats.avg}</div>
                                        <div className="text-xs text-slate-400">Avg Rating</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                                        <div className="text-2xl font-bold text-green-400">{surveyStats.withFeedback.length}</div>
                                        <div className="text-xs text-slate-400">With Comments</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                                        <div className="text-2xl font-bold text-purple-400">{Object.keys(surveyStats.byUser).length}</div>
                                        <div className="text-xs text-slate-400">Unique Respondents</div>
                                    </div>
                                </div>
                                
                                {/* Filter */}
                                <div className="flex gap-2">
                                    {['all', 'with-feedback', 'low-rating'].map(f => (
                                        <button key={f} onClick={() => setSurveyFilter(f)}
                                            className={`px-3 py-1 rounded text-xs font-medium transition-colors ${
                                                surveyFilter === f ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'
                                            }`}>
                                            {f === 'all' ? 'All' : f === 'with-feedback' ? 'With Comments' : 'Low Ratings (1-2)'}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Survey entries */}
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-96 overflow-y-auto divide-y divide-slate-700">
                                        {surveyStats.allRatings
                                            .filter(r => {
                                                if (surveyFilter === 'with-feedback') return r.feedback;
                                                if (surveyFilter === 'low-rating') return r.rating <= 2;
                                                return true;
                                            })
                                            .map((r, i) => (
                                            <div key={i} className="px-4 py-3 flex items-start gap-3">
                                                <div className={`text-lg font-bold min-w-[2rem] text-center ${
                                                    r.rating >= 4 ? 'text-green-400' : r.rating >= 3 ? 'text-yellow-400' : 'text-red-400'
                                                }`}>{r.rating}â˜…</div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-sm font-medium text-slate-300">{r.user}</span>
                                                        <span className="text-xs text-slate-500">{r.date}</span>
                                                    </div>
                                                    {r.feedback && <div className="text-sm text-slate-400 mt-0.5">{r.feedback}</div>}
                                                </div>
                                            </div>
                                        ))}
                                        {surveyStats.total === 0 && (
                                            <div className="px-4 py-8 text-center text-slate-500">No survey responses yet</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* ---- USERS TAB ---- */}
                        {activeTab === 'users' && (
                            <div className="space-y-4">
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-[600px] overflow-y-auto divide-y divide-slate-700">
                                        {betaUsers.map(u => {
                                            const ob = u.earlyAccess?.onboarding;
                                            const surveys = u.earlyAccess?.surveys;
                                            const surveyCount = surveys ? Object.keys(surveys).length : 0;
                                            const isExpanded = expandedUser === u.uid;
                                            
                                            return (
                                                <div key={u.uid}>
                                                    <button onClick={() => setExpandedUser(isExpanded ? null : u.uid)}
                                                        className="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-700/50 transition-colors text-left">
                                                        {u.photoURL ? (
                                                            <img src={u.photoURL} className="w-8 h-8 rounded-full" alt="" />
                                                        ) : (
                                                            <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-xs">
                                                                {u.displayName.charAt(0)}
                                                            </div>
                                                        )}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="text-sm font-medium text-slate-200 truncate">{u.displayName}</div>
                                                            <div className="text-xs text-slate-500">
                                                                Joined {fmtDate(u.earlyAccess.joinedAt)}
                                                                {u.lastVisit ? ` Â· Last active ${fmtDaysAgo(u.lastVisit)}` : ''}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {ob?.completedAt && <span className="px-2 py-0.5 bg-green-900/30 text-green-400 rounded text-[10px]">Onboarded</span>}
                                                            {surveyCount > 0 && <span className="px-2 py-0.5 bg-amber-900/30 text-amber-400 rounded text-[10px]">{surveyCount} survey{surveyCount > 1 ? 's' : ''}</span>}
                                                            <span className={`text-xs transition-transform ${isExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                                                        </div>
                                                    </button>
                                                    
                                                    {isExpanded && (
                                                        <div className="px-4 pb-4 bg-slate-900/50">
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                                                                {/* Onboarding responses */}
                                                                <div className="bg-slate-800 rounded-lg p-4">
                                                                    <h4 className="text-xs font-semibold text-slate-400 mb-2 uppercase">Onboarding</h4>
                                                                    {ob?.completedAt ? (
                                                                        <div className="space-y-1.5 text-sm">
                                                                            {ob.source && <div><span className="text-slate-500">Source:</span> <span className="text-slate-300">{ob.source}{ob.sourceOther ? ` (${ob.sourceOther})` : ''}</span></div>}
                                                                            {ob.experience && <div><span className="text-slate-500">Experience:</span> <span className="text-slate-300">{ob.experience}</span></div>}
                                                                            {ob.games && <div><span className="text-slate-500">Games:</span> <span className="text-slate-300">{Array.isArray(ob.games) ? ob.games.join(', ') : ob.games}{ob.gamesOther ? ` + ${ob.gamesOther}` : ''}</span></div>}
                                                                            {ob.frequency && <div><span className="text-slate-500">Per day:</span> <span className="text-slate-300">{ob.frequency}</span></div>}
                                                                            {ob.device && <div><span className="text-slate-500">Device:</span> <span className="text-slate-300">{ob.device}</span></div>}
                                                                            {ob.sharing && <div><span className="text-slate-500">Sharing:</span> <span className="text-slate-300">{ob.sharing}{ob.shareWhere ? ` via ${Array.isArray(ob.shareWhere) ? ob.shareWhere.join(', ') : ob.shareWhere}` : ''}</span></div>}
                                                                            {ob.hints && <div><span className="text-slate-500">Hints:</span> <span className="text-slate-300">{ob.hints}</span></div>}
                                                                            {ob.compete && <div><span className="text-slate-500">Compete:</span> <span className="text-slate-300">{ob.compete}</span></div>}
                                                                            {ob.frustration && <div><span className="text-slate-500">Frustration:</span> <span className="text-slate-300">{ob.frustration}{ob.frustrationOther ? ` (${ob.frustrationOther})` : ''}</span></div>}
                                                                            {ob.dailyUse && <div className="mt-2 p-2 bg-amber-900/20 border border-amber-800/30 rounded"><span className="text-amber-400 text-xs font-semibold">ðŸ’¡ Daily use:</span> <span className="text-slate-300 text-xs">{ob.dailyUse}</span></div>}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="text-sm text-slate-500">Not completed</div>
                                                                    )}
                                                                </div>
                                                                
                                                                {/* Survey history */}
                                                                <div className="bg-slate-800 rounded-lg p-4">
                                                                    <h4 className="text-xs font-semibold text-slate-400 mb-2 uppercase">Survey History</h4>
                                                                    {surveyCount > 0 ? (
                                                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                                                            {Object.entries(surveys).sort((a, b) => b[0].localeCompare(a[0])).map(([date, data]) => (
                                                                                <div key={date} className="text-sm flex items-start gap-2">
                                                                                    <span className={`font-bold ${data.rating >= 4 ? 'text-green-400' : data.rating >= 3 ? 'text-yellow-400' : 'text-red-400'}`}>
                                                                                        {data.rating}â˜…
                                                                                    </span>
                                                                                    <div>
                                                                                        <span className="text-slate-500 text-xs">{date}</span>
                                                                                        {data.feedback && <div className="text-slate-400 text-xs mt-0.5">{data.feedback}</div>}
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="text-sm text-slate-500">No surveys yet</div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* ---- GOLD QUESTION TAB ---- */}
                        {activeTab === 'goldq' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-amber-900/30 to-yellow-900/20 rounded-xl p-6 border border-amber-700/50">
                                    <h3 className="font-semibold text-amber-400 mb-1">ðŸ’¡ "What would make you use Game Shelf every day?"</h3>
                                    <p className="text-sm text-slate-400">The most valuable onboarding question â€” raw user intent and desires.</p>
                                </div>
                                
                                <div className="space-y-3">
                                    {onboardingStats.dailyUseResponses.length > 0 ? (
                                        onboardingStats.dailyUseResponses.map((r, i) => (
                                            <div key={i} className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="text-sm font-medium text-slate-300">{r.user}</span>
                                                </div>
                                                <div className="text-slate-300 text-sm leading-relaxed">"{r.text}"</div>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="bg-slate-800 rounded-xl p-8 text-center text-slate-500">
                                            No responses to the daily use question yet
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    }
    const ProductBriefGenerator = {
        
        /**
         * Generate PRODUCT_BRIEF.md from existing CC data sources.
         * @param {Object} app - App definition from CC config
         * @param {Object} scopeData - Scope data from Firebase appScopes/{appId} (nullable)
         * @param {Object} config - CC config (for project info)
         * @param {Array} workItems - All work items (will be filtered to this app)
         * @param {Array} deployments - Deploy history
         * @param {Array} streams - Work streams (nullable)
         * @returns {string} Markdown content for PRODUCT_BRIEF.md
         */
        generate(app, scopeData, config, workItems, deployments, streams) {
            const now = new Date();
            const projectDef = config?.projects?.[app.project] || {};
            const appItems = (workItems || []).filter(wi => wi.appId === app.id);
            const appStreams = (streams || []).filter(s => s.appId === app.id);
            const appDeploys = (deployments || []).filter(d => d.appId === app.id && d.status === 'success');
            const cat = scopeData?.category ? (SCOPE_CATEGORIES[scopeData.category] || {}) : {};
            
            let md = '';
            
            // === Header ===
            md += `# ${app.name} â€” Product Brief\n\n`;
            md += `> Living document auto-generated from Command Center project data.\n`;
            md += `> Describes what the product does in PM language â€” not how it's built.\n`;
            md += `> Updated: ${now.toLocaleDateString()}\n\n`;
            
            // === Product Identity ===
            md += `## Product Identity\n\n`;
            const description = scopeData?.description || app.lifecycle?.problemStatement || '';
            if (description) {
                md += `${description}\n\n`;
            }
            md += `- **Category:** ${cat.icon || app.icon || 'ðŸ“¦'} ${cat.label || scopeData?.category || app.lifecycle?.category || 'Application'}\n`;
            if (projectDef.name) md += `- **Project:** ${projectDef.name}\n`;
            md += `- **Maturity:** ${app.lifecycle?.currentMaturity || 'unknown'}`;
            if (app.lifecycle?.maturityTarget && app.lifecycle.maturityTarget !== app.lifecycle.currentMaturity) {
                md += ` â†’ ${app.lifecycle.maturityTarget}`;
            }
            md += `\n`;
            if (app.lifecycle?.targetAudience) md += `- **Audience:** ${app.lifecycle.targetAudience}\n`;
            if (app.lifecycle?.userGoal) md += `- **User Goal:** ${app.lifecycle.userGoal}\n`;
            if (app.lifecycle?.successMetric) md += `- **Success Metric:** ${app.lifecycle.successMetric}\n`;
            
            const prodVer = app.versions?.prod || app.versions?.test || 'â€”';
            const lastDeploy = appDeploys[0];
            md += `- **Current Version:** ${prodVer}`;
            if (lastDeploy) {
                md += ` (deployed ${new Date(lastDeploy.completedAt || lastDeploy.startedAt).toLocaleDateString()})`;
            }
            md += `\n\n`;
            
            // === Key Product Decisions ===
            if (scopeData?.categoryAnswers && Object.keys(scopeData.categoryAnswers).length > 0) {
                md += `## Key Product Decisions\n\n`;
                md += this._formatProductDecisions(scopeData, cat);
                md += '\n';
            }
            
            // === Feature Inventory ===
            md += this._generateFeatureInventory(appItems, scopeData);
            
            // === Work Streams (if any) ===
            if (appStreams.length > 0) {
                md += this._generateStreamOverview(appStreams, appItems);
            }
            
            // === Recent Activity ===
            if (appDeploys.length > 0) {
                md += `## Recent Releases\n\n`;
                const recent = appDeploys.slice(0, 5);
                recent.forEach(d => {
                    const date = new Date(d.completedAt || d.startedAt).toLocaleDateString();
                    const env = (d.target || 'prod').toUpperCase();
                    md += `- **v${d.version || '?'}** (${date}, ${env})`;
                    if (d.workItemsCompleted) md += ` â€” ${d.workItemsCompleted} item${d.workItemsCompleted !== 1 ? 's' : ''} shipped`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            // === Decisions from Scoping ===
            if (scopeData?.decisions && scopeData.decisions.length > 0) {
                md += `## Open Decisions\n\n`;
                scopeData.decisions.forEach(d => {
                    md += `- ${d.title || d}`;
                    if (d.status === 'resolved') md += ` âœ…`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            md += `---\n`;
            md += `*Generated ${now.toLocaleDateString()} by Command Center v${document.querySelector('meta[name="version"]')?.content || '?'}*\n`;
            
            return md;
        },
        
        /**
         * Format scoping category answers as human-readable product decisions.
         */
        _formatProductDecisions(scopeData, cat) {
            const answers = scopeData.categoryAnswers || {};
            let md = '';
            
            // Map technical scope answers to PM-language decisions
            const decisionMap = {
                // Game
                difficulty: { label: 'Difficulty', format: v => v === 'easy-hard' ? 'Two modes (Easy & Hard)' : v === 'multiple' ? 'Multiple levels' : 'No difficulty modes' },
                scoring: { label: 'Scoring', format: v => v === 'points' ? 'Point-based scoring' : v === 'stars' ? 'Star rating' : v === 'streaks' ? 'Streak-based' : v || 'None' },
                dailyPuzzle: { label: 'Daily Content', format: v => v ? 'Yes â€” daily puzzle/challenge' : 'No â€” play anytime' },
                multiplayer: { label: 'Multiplayer', format: v => v ? 'Yes' : 'No â€” single player' },
                sharing: { label: 'Share Results', format: v => v ? 'Yes â€” shareable results' : 'No sharing' },
                
                // Tool
                multiItem: { label: 'Item Model', format: v => v === 'list' ? 'Works with a list of items' : v === 'single' ? 'Single item at a time' : v || 'Unknown' },
                dataPersistence: { label: 'Data Persistence', format: v => v === 'firebase' ? 'Saves to cloud (syncs across devices)' : v === 'localStorage' ? 'Saves locally (this device only)' : v === 'none' ? 'No save â€” session only' : v || 'Unknown' },
                exportImport: { label: 'Import/Export', format: v => v ? 'Yes' : 'No' },
                
                // Dashboard
                dataSource: { label: 'Data Source', format: v => v === 'firebase' ? 'Database' : v === 'api' ? 'External service' : v === 'manual' ? 'User input' : v || 'Unknown' },
                dataUpdates: { label: 'Data Updates', format: v => v === 'realtime' ? 'Instant (real-time)' : v === 'periodic' ? 'Periodic auto-refresh' : 'Manual refresh' },
                
                // Content
                contentType: { label: 'Content Updates', format: v => v === 'dynamic' ? 'Updates regularly' : 'Same every time' },
                navigation: { label: 'Content Size', format: v => v === 'paginated' ? 'Many pages' : v === 'multi-section' ? 'Multiple sections' : 'Single page' },
                
                // Admin
                crudOperations: { label: 'CRUD', format: v => v ? 'Create, edit, and delete records' : 'Read-only' },
                authRequired: { label: 'Authentication', format: v => v ? 'Login required' : 'No auth' }
            };
            
            for (const [key, value] of Object.entries(answers)) {
                const mapper = decisionMap[key];
                if (mapper && value !== undefined && value !== null && value !== '') {
                    md += `- **${mapper.label}:** ${mapper.format(value)}\n`;
                }
            }
            
            return md;
        },
        
        /**
         * Generate the feature inventory section from work items and scope data.
         */
        _generateFeatureInventory(appItems, scopeData) {
            let md = `## Feature Inventory\n\n`;
            
            // Shipped features (done work items)
            const shipped = appItems.filter(wi => wi.status === 'done' && (wi.type === 'feature' || wi.type === 'enhancement'));
            // In-progress
            const inProgress = appItems.filter(wi => (wi.status === 'in-progress' || wi.status === 'review') && (wi.type === 'feature' || wi.type === 'enhancement'));
            // Planned (ready)
            const planned = appItems.filter(wi => wi.status === 'ready' && (wi.type === 'feature' || wi.type === 'enhancement'));
            // Ideas
            const ideas = appItems.filter(wi => wi.status === 'idea' && (wi.type === 'feature' || wi.type === 'enhancement'));
            
            if (shipped.length > 0) {
                md += `### Shipped (${shipped.length})\n`;
                shipped.forEach(wi => {
                    md += `- âœ… ${wi.title}`;
                    if (wi.milestone) md += ` (${wi.milestone})`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (inProgress.length > 0) {
                md += `### In Progress (${inProgress.length})\n`;
                inProgress.forEach(wi => {
                    md += `- ðŸ”„ ${wi.title}`;
                    if (wi.status === 'review') md += ` â€” in review`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (planned.length > 0) {
                md += `### Planned (${planned.length})\n`;
                planned.forEach(wi => {
                    md += `- ðŸ“‹ ${wi.title}`;
                    if (wi.priority === 'must-have' || wi.priority === 'core') md += ` â­`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (ideas.length > 0) {
                md += `### Ideas (${ideas.length})\n`;
                ideas.slice(0, 10).forEach(wi => {
                    md += `- ðŸ’¡ ${wi.title}\n`;
                });
                if (ideas.length > 10) md += `- *...and ${ideas.length - 10} more ideas*\n`;
                md += '\n';
            }
            
            // Also pull from scope's future features if no work items exist yet
            if (shipped.length === 0 && inProgress.length === 0 && planned.length === 0 && scopeData?.v1Features) {
                md += `### Launch Features (from scope)\n`;
                (scopeData.v1Features || []).filter(f => f.priority !== 'out-of-scope').forEach(f => {
                    md += `- ${f.title}`;
                    if (f.priority === 'core' || f.priority === 'must-have') md += ` â­`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (shipped.length === 0 && inProgress.length === 0 && planned.length === 0 && !scopeData?.v1Features) {
                md += `*No features tracked yet. Use the Scoping flow or Backlog to define features.*\n\n`;
            }
            
            // Known bugs count
            const bugs = appItems.filter(wi => wi.type === 'bugfix' && wi.status !== 'done' && wi.status !== 'deferred');
            if (bugs.length > 0) {
                md += `### Known Issues (${bugs.length})\n`;
                bugs.forEach(wi => {
                    md += `- ðŸ› ${wi.title}`;
                    if (wi.priority === 'must-have' || wi.priority === 'critical') md += ` â—`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            return md;
        },
        
        /**
         * Generate stream overview section.
         */
        _generateStreamOverview(appStreams, appItems) {
            let md = `## Work Streams\n\n`;
            
            appStreams.forEach(stream => {
                const streamItems = appItems.filter(wi => wi.streamId === stream.id);
                const done = streamItems.filter(wi => wi.status === 'done').length;
                const total = streamItems.length;
                const pct = total > 0 ? Math.round(done / total * 100) : 0;
                
                md += `### ${stream.name}`;
                if (stream.status === 'complete') md += ` âœ…`;
                else if (stream.status === 'blocked') md += ` ðŸš«`;
                md += `\n`;
                if (stream.owner) md += `- **Owner:** ${stream.owner}\n`;
                if (stream.goal) md += `- **Goal:** ${stream.goal}\n`;
                md += `- **Progress:** ${done}/${total} items (${pct}%)\n`;
                if (stream.status !== 'active' && stream.status !== 'complete') md += `- **Status:** ${stream.status}\n`;
                md += '\n';
            });
            
            return md;
        },
        
        /**
         * Check if enough data exists to generate a useful brief.
         */
        hasData(app, scopeData, workItems) {
            const appItems = (workItems || []).filter(wi => wi.appId === app.id);
            return !!(scopeData || appItems.length > 0 || app.lifecycle?.problemStatement || app.lifecycle?.category);
        }
    };

    // =========================================================================
    // ACTIVITY FEED VIEW (extracted from SessionLogView)
    // =========================================================================
    
    function ActivityFeedView({ globalActivity, teamMembers }) {
        const activities = globalActivity || [];
        const [actFilter, setActFilter] = React.useState({ actor: '', app: '', action: '', stream: '' });
        
        const actors = [...new Set(activities.map(a => a.actor).filter(Boolean))];
        const actApps = [...new Set(activities.map(a => a.appId).filter(Boolean))];
        const actions = [...new Set(activities.map(a => a.action).filter(Boolean))];
        const actStreams = [...new Set(activities.map(a => a.streamId).filter(Boolean))];
        
        const filtered = activities.filter(evt => {
            if (actFilter.actor && evt.actor !== actFilter.actor) return false;
            if (actFilter.app && evt.appId !== actFilter.app) return false;
            if (actFilter.action && evt.action !== actFilter.action) return false;
            if (actFilter.stream && evt.streamId !== actFilter.stream) return false;
            return true;
        });
                    
                    // Group by day
                    const grouped = {};
                    filtered.forEach(evt => {
                        const day = new Date(evt.timestamp).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        if (!grouped[day]) grouped[day] = [];
                        grouped[day].push(evt);
                    });
                    
                    const actionIcons = {
                        deploy: 'ðŸš€', session_create: 'ðŸ¤–', session_complete: 'âœ…',
                        item_transition: 'ðŸ“‹', review: 'ðŸ“', scope: 'ðŸŽ¯',
                        dependency_alert: 'âš ï¸', stream_update: 'ðŸ”€'
                    };
                    
                    const actionColors = {
                        deploy: 'text-green-400', session_create: 'text-indigo-400', session_complete: 'text-emerald-400',
                        item_transition: 'text-slate-300', review: 'text-amber-400', scope: 'text-purple-400',
                        dependency_alert: 'text-orange-400', stream_update: 'text-cyan-400'
                    };
                    
                    // Per-actor stats
                    const actorStats = {};
                    activities.forEach(evt => {
                        const a = evt.actor || 'Unknown';
                        if (!actorStats[a]) actorStats[a] = { deploys: 0, sessions: 0, items: 0, total: 0 };
                        actorStats[a].total++;
                        if (evt.action === 'deploy') actorStats[a].deploys++;
                        if (evt.action === 'session_create' || evt.action === 'session_complete') actorStats[a].sessions++;
                        if (evt.action === 'item_transition') actorStats[a].items++;
                    });
                    
                    // Team member lookup
                    const memberLookup = {};
                    (teamMembers || []).forEach(m => { memberLookup[m.name || m.email] = m; });
                    
                    return (
                        <div className="space-y-4">
                            {/* Stats Row */}
                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                <div className="bg-slate-800 rounded-lg border border-slate-700 p-3 text-center">
                                    <div className="text-2xl font-bold text-white">{activities.length}</div>
                                    <div className="text-xs text-slate-400">Total Events</div>
                                </div>
                                <div className="bg-slate-800 rounded-lg border border-slate-700 p-3 text-center">
                                    <div className="text-2xl font-bold text-white">{actors.length}</div>
                                    <div className="text-xs text-slate-400">Contributors</div>
                                </div>
                                <div className="bg-slate-800 rounded-lg border border-slate-700 p-3 text-center">
                                    <div className="text-2xl font-bold text-green-400">{activities.filter(a => a.action === 'deploy').length}</div>
                                    <div className="text-xs text-slate-400">Deploys</div>
                                </div>
                                <div className="bg-slate-800 rounded-lg border border-slate-700 p-3 text-center">
                                    <div className="text-2xl font-bold text-indigo-400">{activities.filter(a => a.action === 'session_create').length}</div>
                                    <div className="text-xs text-slate-400">Sessions</div>
                                </div>
                            </div>
                            
                            {/* Per-Actor Summary (multi-person view) */}
                            {actors.length > 1 && (
                                <div className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                                    <h3 className="font-semibold mb-3 text-sm">ðŸ‘¥ Team Activity</h3>
                                    <div className="space-y-2">
                                        {Object.entries(actorStats).sort((a, b) => b[1].total - a[1].total).map(([name, stats]) => {
                                            const member = memberLookup[name];
                                            return (
                                                <div key={name} className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50">
                                                    {member?.photoURL ? (
                                                        <img src={member.photoURL} className="w-6 h-6 rounded-full" alt="" />
                                                    ) : (
                                                        <div className="w-6 h-6 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold">{name[0]}</div>
                                                    )}
                                                    <span className="text-sm font-medium flex-1">{name}</span>
                                                    <span className="text-xs text-green-400">{stats.deploys}ðŸš€</span>
                                                    <span className="text-xs text-indigo-400">{stats.sessions}ðŸ¤–</span>
                                                    <span className="text-xs text-slate-400">{stats.items}ðŸ“‹</span>
                                                    <span className="text-xs text-slate-500">{stats.total} total</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                            
                            {/* Filters */}
                            <div className="flex flex-wrap gap-2">
                                {actors.length > 1 && (
                                    <select value={actFilter.actor} onChange={e => setActFilter(f => ({...f, actor: e.target.value}))}
                                        className="px-2 py-1 bg-slate-700 border border-slate-600 rounded text-xs">
                                        <option value="">All people</option>
                                        {actors.map(a => <option key={a} value={a}>{a}</option>)}
                                    </select>
                                )}
                                <select value={actFilter.app} onChange={e => setActFilter(f => ({...f, app: e.target.value}))}
                                    className="px-2 py-1 bg-slate-700 border border-slate-600 rounded text-xs">
                                    <option value="">All apps</option>
                                    {actApps.map(a => <option key={a} value={a}>{a}</option>)}
                                </select>
                                <select value={actFilter.action} onChange={e => setActFilter(f => ({...f, action: e.target.value}))}
                                    className="px-2 py-1 bg-slate-700 border border-slate-600 rounded text-xs">
                                    <option value="">All actions</option>
                                    {actions.map(a => <option key={a} value={a}>{actionIcons[a] || 'â€¢'} {a.replace(/_/g, ' ')}</option>)}
                                </select>
                                {actStreams.length > 0 && (
                                    <select value={actFilter.stream} onChange={e => setActFilter(f => ({...f, stream: e.target.value}))}
                                        className="px-2 py-1 bg-slate-700 border border-slate-600 rounded text-xs">
                                        <option value="">All streams</option>
                                        {actStreams.map(s => {
                                            const stream = (globalStreams || []).find(st => st.id === s);
                                            return <option key={s} value={s}>{stream?.name || s}</option>;
                                        })}
                                    </select>
                                )}
                                {(actFilter.actor || actFilter.app || actFilter.action || actFilter.stream) && (
                                    <button onClick={() => setActFilter({ actor: '', app: '', action: '', stream: '' })}
                                        className="px-2 py-1 text-xs text-red-400 hover:text-red-300">âœ• Clear</button>
                                )}
                                <span className="text-xs text-slate-500 self-center ml-auto">{filtered.length} events</span>
                            </div>
                            
                            {/* Timeline grouped by day */}
                            {Object.entries(grouped).length === 0 ? (
                                <div className="text-center py-12 text-slate-500">
                                    <div className="text-4xl mb-2">ðŸ“¡</div>
                                    <div>No activity events{actFilter.actor || actFilter.app || actFilter.action ? ' matching filters' : ' yet'}</div>
                                    <div className="text-xs mt-1">Events appear when you deploy, start sessions, transition work items, or review</div>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {Object.entries(grouped).map(([day, events]) => (
                                        <div key={day}>
                                            <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 sticky top-0 bg-slate-900/80 backdrop-blur-sm py-1 z-10">{day}</div>
                                            <div className="space-y-1 border-l-2 border-slate-700 ml-2 pl-4">
                                                {events.map(evt => {
                                                    const time = new Date(evt.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                                                    const member = memberLookup[evt.actor];
                                                    return (
                                                        <div key={evt.id} className="flex items-start gap-2 py-1.5 group">
                                                            <span className="text-sm mt-0.5">{actionIcons[evt.action] || 'â€¢'}</span>
                                                            <div className="flex-1 min-w-0">
                                                                <div className={`text-sm leading-relaxed ${actionColors[evt.action] || 'text-slate-300'}`}>
                                                                    {evt.summary}
                                                                </div>
                                                                {evt.metadata && Object.keys(evt.metadata).length > 0 && (
                                                                    <div className="text-xs text-slate-500 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                        {evt.metadata.version && `v${evt.metadata.version}`}
                                                                        {evt.metadata.sessionType && ` Â· ${evt.metadata.sessionType}`}
                                                                        {evt.metadata.environment && ` â†’ ${evt.metadata.environment}`}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center gap-1.5 shrink-0">
                                                                {member?.photoURL ? (
                                                                    <img src={member.photoURL} className="w-4 h-4 rounded-full" alt="" title={evt.actor} />
                                                                ) : actors.length > 1 ? (
                                                                    <div className="w-4 h-4 rounded-full bg-slate-600 flex items-center justify-center text-[10px] font-bold" title={evt.actor}>{(evt.actor || '?')[0]}</div>
                                                                ) : null}
                                                                <span className="text-xs text-slate-500 tabular-nums">{time}</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
    }

    // =========================================================================
    // WORK STREAMS
    // =========================================================================
    function WorkStreamsView({ apps, config, globalWorkItems, globalStreams, globalInterfaces, globalDependencies, globalDependencyAlerts, showAlert, showConfirm, showPrompt, setView }) {
        const [selectedApp, setSelectedApp] = React.useState('all');
        const [editingStream, setEditingStream] = React.useState(null); // null, 'new', or stream object
        const [firebaseUser, setFirebaseUser] = React.useState(null);
        
        React.useEffect(() => {
            if (firebaseAuth) {
                return firebaseAuth.onAuthStateChanged(u => setFirebaseUser(u));
            }
        }, []);
        
        const actor = config?._userName || 'Owner';
        const appList = Object.values(apps).filter(a => a.id !== 'command-center').sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        
        const filteredStreams = selectedApp === 'all' 
            ? globalStreams 
            : WorkStreamService.filterByApp(globalStreams, selectedApp);
        
        // Group streams by app
        const streamsByApp = {};
        filteredStreams.forEach(s => {
            const key = s.appId || 'unassigned';
            if (!streamsByApp[key]) streamsByApp[key] = [];
            streamsByApp[key].push(s);
        });
        
        // Get unassigned items count per app
        const getUnassignedCount = (appId) => {
            return WorkItemService.getUnassigned(globalWorkItems, appId).length;
        };
        
        const handleCreateStream = async (streamData) => {
            if (!firebaseUser) return;
            const id = WorkStreamService.getNextId(globalStreams);
            await WorkStreamService.create(firebaseUser.uid, { ...streamData, id, createdBy: actor });
            ActivityLogService.log(firebaseUser.uid, {
                appId: streamData.appId,
                streamId: id,
                actor,
                action: 'stream_create',
                summary: `${actor} created stream "${streamData.name}" for ${apps[streamData.appId]?.name || streamData.appId}`,
                metadata: { streamId: id }
            }).catch(() => {});
            setEditingStream(null);
        };
        
        const handleUpdateStream = async (streamId, updates) => {
            if (!firebaseUser) return;
            await WorkStreamService.update(firebaseUser.uid, streamId, updates);
        };
        
        const handleDeleteStream = async (stream) => {
            if (!firebaseUser) return;
            const itemCount = WorkItemService.filterByStream(globalWorkItems, stream.id).length;
            const msg = itemCount > 0 
                ? `Delete stream "${stream.name}"? ${itemCount} work item(s) will become unassigned.`
                : `Delete stream "${stream.name}"?`;
            showConfirm(msg, 'ðŸ—‘ï¸ Delete Stream', async () => {
                // Unassign work items from this stream
                if (itemCount > 0) {
                    const items = WorkItemService.filterByStream(globalWorkItems, stream.id);
                    for (const item of items) {
                        await WorkItemService.update(firebaseUser.uid, item.id, { streamId: null });
                    }
                }
                await WorkStreamService.delete(firebaseUser.uid, stream.id);
                ActivityLogService.log(firebaseUser.uid, {
                    appId: stream.appId,
                    actor,
                    action: 'stream_delete',
                    summary: `${actor} deleted stream "${stream.name}"`,
                    metadata: { streamId: stream.id }
                }).catch(() => {});
            });
        };
        
        const handleStatusChange = async (stream, newStatus) => {
            if (!firebaseUser) return;
            await WorkStreamService.updateStatus(firebaseUser.uid, stream.id, newStatus);
            ActivityLogService.log(firebaseUser.uid, {
                appId: stream.appId,
                streamId: stream.id,
                actor,
                action: 'stream_status',
                summary: `${actor} changed "${stream.name}" to ${newStatus}`,
                metadata: { fromStatus: stream.status, toStatus: newStatus }
            }).catch(() => {});
        };
        
        // Assign work items to stream
        const handleAssignItems = async (stream) => {
            if (!firebaseUser) return;
            const unassigned = WorkItemService.getUnassigned(globalWorkItems, stream.appId);
            if (unassigned.length === 0) {
                showAlert('No unassigned work items for this app.', 'ðŸ“‹ No Items');
                return;
            }
            // For now, show a confirm with list and assign all unassigned
            const names = unassigned.slice(0, 10).map(i => `â€¢ ${i.title}`).join('\n');
            const more = unassigned.length > 10 ? `\n...and ${unassigned.length - 10} more` : '';
            showConfirm(
                `Assign ${unassigned.length} unassigned item(s) to "${stream.name}"?\n\n${names}${more}`,
                `ðŸ“‹ Assign to ${stream.name}`,
                async () => {
                    for (const item of unassigned) {
                        await WorkItemService.update(firebaseUser.uid, item.id, { streamId: stream.id });
                    }
                    showAlert(`${unassigned.length} item(s) assigned to "${stream.name}".`, 'âœ… Assigned');
                }
            );
        };
        
        // Phase 5.4: Resolve a dependency alert
        const handleResolveAlert = async (alert, resolution) => {
            if (!firebaseUser) return;
            const actor = config?.ownerName || 'Owner';
            try {
                await DependencyAlertService.resolve(firebaseUser.uid, alert.id, resolution, actor);
                
                // If resolved as 'updated', also mark the dependency as 'verified'
                if (resolution === 'updated') {
                    await DependencyService.update(firebaseUser.uid, alert.dependencyId, {
                        status: 'verified',
                        lastVerified: new Date().toISOString(),
                        lastVerifiedBy: actor
                    });
                }
                
                showAlert(`Alert resolved: ${resolution === 'updated' ? 'Updated' : 'No impact'}.`, 'âœ… Resolved');
            } catch (e) {
                showAlert(`Error: ${e.message}`, 'error');
            }
        };
        
        // Pending alerts count for summary stats
        const totalPendingAlerts = DependencyAlertService.getPending(globalDependencyAlerts || []).length;
        
        const statusColors = {
            active: 'bg-green-900/30 text-green-400 border-green-800/50',
            paused: 'bg-yellow-900/30 text-yellow-400 border-yellow-800/50',
            blocked: 'bg-red-900/30 text-red-400 border-red-800/50',
            complete: 'bg-slate-700/30 text-slate-400 border-slate-600/50'
        };
        
        const statusIcons = { active: 'ðŸŸ¢', paused: 'â¸ï¸', blocked: 'ðŸ”´', complete: 'âœ…' };
        
        return (
            <div className="max-w-6xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                    <div>
                        <h2 className="text-xl font-bold flex items-center gap-2">ðŸ”€ Work Streams</h2>
                        <p className="text-sm text-slate-400 mt-1">Named, owned, parallel tracks of work. Different people run AI sessions against different streams.</p>
                    </div>
                    <div className="flex items-center gap-3">
                        <select value={selectedApp} onChange={e => setSelectedApp(e.target.value)}
                            className="bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm">
                            <option value="all">All Apps</option>
                            {appList.map(a => (
                                <option key={a.id} value={a.id}>{a.icon === 'gs-logo' ? 'ðŸŽ®' : a.icon} {a.name}</option>
                            ))}
                        </select>
                        <button onClick={() => setEditingStream('new')}
                            className="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium">
                            + New Stream
                        </button>
                    </div>
                </div>
                
                {/* Summary stats */}
                <div className={`grid gap-4 mb-6 ${totalPendingAlerts > 0 ? 'grid-cols-5' : 'grid-cols-4'}`}>
                    {[
                        { label: 'Active Streams', value: filteredStreams.filter(s => s.status === 'active').length, color: 'text-green-400' },
                        { label: 'Blocked', value: filteredStreams.filter(s => s.status === 'blocked').length, color: 'text-red-400' },
                        { label: 'Complete', value: filteredStreams.filter(s => s.status === 'complete').length, color: 'text-slate-400' },
                        { label: 'Total Items', value: filteredStreams.reduce((sum, s) => sum + WorkItemService.filterByStream(globalWorkItems, s.id).length, 0), color: 'text-blue-400' },
                        ...(totalPendingAlerts > 0 ? [{ label: 'ðŸ”” Pending Alerts', value: totalPendingAlerts, color: 'text-amber-400' }] : [])
                    ].map(stat => (
                        <div key={stat.label} className="bg-slate-800 rounded-lg border border-slate-700 p-4 text-center">
                            <div className={`text-2xl font-bold ${stat.color}`}>{stat.value}</div>
                            <div className="text-xs text-slate-500 mt-1">{stat.label}</div>
                        </div>
                    ))}
                </div>
                
                {/* Stream cards by app */}
                {Object.keys(streamsByApp).length === 0 && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-12 text-center">
                        <div className="text-4xl mb-3">ðŸ”€</div>
                        <h3 className="text-lg font-semibold mb-2">No work streams yet</h3>
                        <p className="text-slate-400 text-sm mb-4 max-w-lg mx-auto">
                            Work streams organize your backlog into parallel tracks. Each stream has an owner, a goal, and its own set of work items. 
                            Different people can run AI sessions against different streams without stepping on each other.
                        </p>
                        <button onClick={() => setEditingStream('new')}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded font-medium">
                            Create Your First Stream
                        </button>
                    </div>
                )}
                
                {Object.entries(streamsByApp).sort((a, b) => (apps[a[0]]?.name || '').localeCompare(apps[b[0]]?.name || '')).map(([appId, streams]) => {
                    const app = apps[appId] || { name: appId, icon: 'ðŸ“¦' };
                    const unassignedCount = getUnassignedCount(appId);
                    
                    return (
                        <div key={appId} className="mb-6">
                            <div className="flex items-center gap-2 mb-3">
                                <span>{app.icon === 'gs-logo' ? 'ðŸŽ®' : app.icon}</span>
                                <h3 className="font-semibold">{app.name}</h3>
                                <span className="text-xs text-slate-500">{streams.length} stream{streams.length !== 1 ? 's' : ''}</span>
                                {unassignedCount > 0 && (
                                    <span className="px-2 py-0.5 rounded text-xs bg-amber-900/30 text-amber-400 border border-amber-800/50">
                                        {unassignedCount} unassigned item{unassignedCount !== 1 ? 's' : ''}
                                    </span>
                                )}
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {streams.map(stream => {
                                    const completion = WorkStreamService.getCompletion(stream, globalWorkItems);
                                    const streamItems = WorkItemService.filterByStream(globalWorkItems, stream.id);
                                    const isBlocked = WorkStreamService.isBlocked(stream, globalStreams);
                                    const interfaces = StreamInterfaceService.getByStream(globalInterfaces, stream.id);
                                    const consumedDeps = DependencyService.getConsumedBy(globalDependencies, stream.id);
                                    const pendingAlerts = DependencyAlertService.getPendingForStream(globalDependencyAlerts || [], globalDependencies, stream.id);
                                    
                                    return (
                                        <div key={stream.id} className={`bg-slate-800 rounded-xl border ${stream.status === 'blocked' ? 'border-red-800/50' : 'border-slate-700'} p-4`}>
                                            {/* Header */}
                                            <div className="flex items-start justify-between mb-3">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`px-2 py-0.5 rounded text-xs border ${statusColors[stream.status]}`}>
                                                            {statusIcons[stream.status]} {stream.status}
                                                        </span>
                                                        <h4 className="font-semibold">{stream.name}</h4>
                                                    </div>
                                                    {stream.goal && <p className="text-xs text-slate-400 mt-1">{stream.goal}</p>}
                                                    <div className="text-xs text-slate-500 mt-1 flex items-center gap-3">
                                                        <span>ðŸ‘¤ {stream.owner}</span>
                                                        {stream.targetRelease && <span>ðŸŽ¯ {stream.targetRelease}</span>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <button onClick={() => setEditingStream(stream)} className="p-1 hover:bg-slate-700 rounded text-slate-400 text-xs" title="Edit stream">âœï¸</button>
                                                    <button onClick={() => handleDeleteStream(stream)} className="p-1 hover:bg-slate-700 rounded text-slate-400 text-xs" title="Delete stream">ðŸ—‘ï¸</button>
                                                </div>
                                            </div>
                                            
                                            {/* Completion bar */}
                                            {completion.total > 0 && (
                                                <div className="mb-3">
                                                    <div className="flex items-center justify-between text-xs text-slate-400 mb-1">
                                                        <span>{completion.done}/{completion.total} items done</span>
                                                        <span>{completion.pct}%</span>
                                                    </div>
                                                    <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                                        <div className="h-full bg-green-500 rounded-full transition-all" style={{width: `${completion.pct}%`}}></div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Work items summary */}
                                            <div className="space-y-1 mb-3">
                                                {streamItems.filter(i => i.status !== 'done' && i.status !== 'deferred').slice(0, 5).map(item => (
                                                    <div key={item.id} className="flex items-center gap-2 text-xs">
                                                        <span>{item.status === 'in-progress' ? 'ðŸ”¨' : item.status === 'review' ? 'ðŸ‘ï¸' : item.status === 'ready' ? 'â—‰' : 'â—‹'}</span>
                                                        <span className="text-slate-300 truncate flex-1">{item.title}</span>
                                                        <span className="text-slate-500 capitalize">{item.status}</span>
                                                    </div>
                                                ))}
                                                {streamItems.filter(i => i.status !== 'done' && i.status !== 'deferred').length > 5 && (
                                                    <div className="text-xs text-slate-500">+{streamItems.filter(i => i.status !== 'done' && i.status !== 'deferred').length - 5} more</div>
                                                )}
                                                {streamItems.length === 0 && (
                                                    <div className="text-xs text-slate-500 py-2">No items assigned yet</div>
                                                )}
                                            </div>
                                            
                                            {/* Interfaces provided */}
                                            {interfaces.length > 0 && (
                                                <div className="mb-3 border-t border-slate-700 pt-2">
                                                    <div className="text-xs text-slate-500 mb-1">Provides:</div>
                                                    {interfaces.map(iface => (
                                                        <div key={iface.id} className="text-xs text-slate-400 flex items-center gap-1">
                                                            <span className="text-indigo-400">â€¢</span> {iface.description}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {/* Dependencies consumed */}
                                            {consumedDeps.length > 0 && (
                                                <div className="mb-3 border-t border-slate-700 pt-2">
                                                    <div className="text-xs text-slate-500 mb-1">Depends on:</div>
                                                    {consumedDeps.map(dep => {
                                                        const iface = globalInterfaces.find(i => i.id === dep.interfaceId);
                                                        const providerStream = globalStreams.find(s => s.id === iface?.streamId);
                                                        return (
                                                            <div key={dep.id} className="text-xs text-slate-400 flex items-center gap-1">
                                                                <span className={dep.status === 'changed' ? 'text-amber-400' : 'text-green-400'}>â€¢</span>
                                                                <span>{iface?.description || dep.interfaceId}</span>
                                                                {providerStream && <span className="text-slate-500">â† {providerStream.name}</span>}
                                                                {dep.status === 'changed' && <span className="text-amber-400 ml-1">âš  changed</span>}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                            
                                            {/* Phase 5.4: Pending dependency alerts */}
                                            {pendingAlerts.length > 0 && (
                                                <div className="mb-3 bg-amber-900/20 border border-amber-700/50 rounded-lg px-3 py-2">
                                                    <div className="text-xs font-medium text-amber-300 mb-1">
                                                        ðŸ”” {pendingAlerts.length} dependency update{pendingAlerts.length !== 1 ? 's' : ''} pending
                                                    </div>
                                                    {pendingAlerts.slice(0, 3).map(alert => {
                                                        const iface = globalInterfaces.find(i => i.id === alert.interfaceId);
                                                        return (
                                                            <div key={alert.id} className="text-xs text-amber-200/70 mb-0.5">
                                                                â€¢ {iface?.description || 'Interface'}: {alert.changeDescription}
                                                            </div>
                                                        );
                                                    })}
                                                    {pendingAlerts.length > 3 && (
                                                        <div className="text-xs text-amber-200/50">+{pendingAlerts.length - 3} more</div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Actions */}
                                            <div className="flex items-center gap-2 pt-2 border-t border-slate-700">
                                                <select value={stream.status} onChange={e => handleStatusChange(stream, e.target.value)}
                                                    className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs flex-1">
                                                    <option value="active">ðŸŸ¢ Active</option>
                                                    <option value="paused">â¸ï¸ Paused</option>
                                                    <option value="blocked">ðŸ”´ Blocked</option>
                                                    <option value="complete">âœ… Complete</option>
                                                </select>
                                                <button onClick={() => handleAssignItems(stream)}
                                                    className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs"
                                                    title="Assign unassigned items">
                                                    ðŸ“‹ Assign Items
                                                </button>
                                                <button onClick={() => { setView('backlog'); }}
                                                    className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs"
                                                    title="View in backlog">
                                                    ðŸ“‹ Backlog
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    );
                })}
                
                {/* Stream Edit Modal */}
                {editingStream && (
                    <StreamEditModal
                        stream={editingStream === 'new' ? null : editingStream}
                        apps={apps}
                        globalStreams={globalStreams}
                        config={config}
                        onSave={editingStream === 'new' ? handleCreateStream : (data) => handleUpdateStream(editingStream.id, data)}
                        onCancel={() => setEditingStream(null)}
                    />
                )}
            </div>
        );
    }
    function StreamEditModal({ stream, apps, globalStreams, config, onSave, onCancel }) {
        const isNew = !stream;
        const [name, setName] = React.useState(stream?.name || '');
        const [appId, setAppId] = React.useState(stream?.appId || '');
        const [owner, setOwner] = React.useState(stream?.owner || config?._userName || 'Owner');
        const [goal, setGoal] = React.useState(stream?.goal || '');
        const [targetRelease, setTargetRelease] = React.useState(stream?.targetRelease || '');
        const [status, setStatus] = React.useState(stream?.status || 'active');
        const [blockedBy, setBlockedBy] = React.useState(stream?.blockedBy || []);
        
        const appList = Object.values(apps).filter(a => a.id !== 'command-center').sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        const otherStreams = globalStreams.filter(s => s.id !== stream?.id);
        
        const handleSubmit = () => {
            if (!name.trim() || !appId) return;
            onSave({
                name: name.trim(),
                appId,
                owner: owner.trim() || 'Owner',
                goal: goal.trim(),
                targetRelease: targetRelease.trim(),
                status,
                blockedBy
            });
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={onCancel}>
                <div className="bg-slate-800 rounded-xl border border-slate-700 max-w-lg w-full p-6" onClick={e => e.stopPropagation()}>
                    <h3 className="text-lg font-bold mb-4">{isNew ? 'ðŸ”€ New Work Stream' : `âœï¸ Edit: ${stream.name}`}</h3>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Stream Name *</label>
                            <input value={name} onChange={e => setName(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"
                                placeholder="Core Gameplay, Help & Onboarding, Marketing..." autoFocus />
                        </div>
                        
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">App *</label>
                            <select value={appId} onChange={e => setAppId(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"
                                disabled={!isNew}>
                                <option value="">Select app...</option>
                                {appList.map(a => (
                                    <option key={a.id} value={a.id}>{a.icon === 'gs-logo' ? 'ðŸŽ®' : a.icon} {a.name}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Owner</label>
                                <input value={owner} onChange={e => setOwner(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"
                                    placeholder="Dave, Sarah..." />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Target Release</label>
                                <input value={targetRelease} onChange={e => setTargetRelease(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"
                                    placeholder="v1.0, v2.0..." />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Goal â€” what done looks like</label>
                            <textarea value={goal} onChange={e => setGoal(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm h-20"
                                placeholder="All core game mechanics working, tested, and deployed to prod..." />
                        </div>
                        
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Status</label>
                            <select value={status} onChange={e => setStatus(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm">
                                <option value="active">ðŸŸ¢ Active</option>
                                <option value="paused">â¸ï¸ Paused</option>
                                <option value="blocked">ðŸ”´ Blocked</option>
                                <option value="complete">âœ… Complete</option>
                            </select>
                        </div>
                        
                        {otherStreams.length > 0 && (
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Blocked by (other streams)</label>
                                <div className="space-y-1 max-h-32 overflow-y-auto">
                                    {otherStreams.map(s => (
                                        <label key={s.id} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-700/50 px-2 py-1 rounded">
                                            <input type="checkbox" checked={blockedBy.includes(s.id)}
                                                onChange={e => {
                                                    if (e.target.checked) setBlockedBy([...blockedBy, s.id]);
                                                    else setBlockedBy(blockedBy.filter(id => id !== s.id));
                                                }} />
                                            <span className="text-slate-300">{s.name}</span>
                                            <span className="text-xs text-slate-500">{apps[s.appId]?.name || s.appId}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-700">
                        <button onClick={onCancel} className="px-4 py-2 text-sm text-slate-400 hover:text-white">Cancel</button>
                        <button onClick={handleSubmit} disabled={!name.trim() || !appId}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium">
                            {isNew ? 'Create Stream' : 'Save Changes'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // PRODUCT BRIEF
    // =========================================================================
    function ProductBriefModal({ app, config, globalWorkItems, deployments, globalStreams, firebaseUid, onClose, showAlert }) {
        const [briefContent, setBriefContent] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        
        React.useEffect(() => {
            async function loadBrief() {
                try {
                    let scopeData = null;
                    if (firebaseUid && typeof firebaseDb !== 'undefined' && firebaseDb) {
                        try {
                            const snap = await firebaseDb.ref(`command-center/${firebaseUid}/appScopes/${app.id}`).once('value');
                            scopeData = snap.val();
                        } catch (e) { /* scope data optional */ }
                    }
                    
                    const brief = ProductBriefGenerator.generate(app, scopeData, config, globalWorkItems, deployments, globalStreams);
                    setBriefContent(brief);
                } catch (e) {
                    setBriefContent(`# Error\n\nCould not generate product brief: ${e.message}`);
                }
                setLoading(false);
            }
            loadBrief();
        }, [app.id]);
        
        const copyBrief = () => {
            if (briefContent) {
                navigator.clipboard.writeText(briefContent);
                showAlert('Product brief copied to clipboard', 'success');
            }
        };
        
        // Simple markdown renderer (reuse pattern from elsewhere in CC)
        const renderMarkdown = (md) => {
            if (!md) return null;
            const lines = md.split('\n');
            const elements = [];
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i];
                
                if (line.startsWith('# ')) {
                    elements.push(React.createElement('h1', { key: i, className: 'text-xl font-bold text-white mb-2 mt-4' }, line.slice(2)));
                } else if (line.startsWith('## ')) {
                    elements.push(React.createElement('h2', { key: i, className: 'text-lg font-semibold text-slate-200 mb-2 mt-4 border-b border-slate-700 pb-1' }, line.slice(3)));
                } else if (line.startsWith('### ')) {
                    elements.push(React.createElement('h3', { key: i, className: 'text-base font-medium text-slate-300 mb-1 mt-3' }, line.slice(4)));
                } else if (line.startsWith('> ')) {
                    elements.push(React.createElement('blockquote', { key: i, className: 'text-xs text-slate-500 italic border-l-2 border-slate-700 pl-2 mb-1' }, line.slice(2)));
                } else if (line.startsWith('- ')) {
                    elements.push(React.createElement('div', { key: i, className: 'text-sm text-slate-300 ml-3 mb-0.5' }, 'â€¢ ' + line.slice(2).replace(/\*\*([^*]+)\*\*/g, (_, t) => t)));
                } else if (line.startsWith('---')) {
                    elements.push(React.createElement('hr', { key: i, className: 'border-slate-700 my-3' }));
                } else if (line.startsWith('*') && line.endsWith('*') && !line.startsWith('**')) {
                    elements.push(React.createElement('p', { key: i, className: 'text-xs text-slate-600 italic' }, line.replace(/\*/g, '')));
                } else if (line.trim()) {
                    elements.push(React.createElement('p', { key: i, className: 'text-sm text-slate-300 mb-1' }, line.replace(/\*\*([^*]+)\*\*/g, (_, t) => t)));
                }
                i++;
            }
            return elements;
        };
        
        return React.createElement('div', {
            className: 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4',
            onClick: (e) => e.target === e.currentTarget && onClose()
        },
            React.createElement('div', { className: 'bg-slate-800 rounded-xl w-full max-w-2xl max-h-[85vh] flex flex-col border border-slate-700 shadow-2xl' },
                // Header
                React.createElement('div', { className: 'flex items-center justify-between p-4 border-b border-slate-700' },
                    React.createElement('div', { className: 'flex items-center gap-2' },
                        React.createElement('span', { className: 'text-lg' }, 'ðŸ“„'),
                        React.createElement('h2', { className: 'text-lg font-semibold text-white' }, `Product Brief â€” ${app.name}`),
                    ),
                    React.createElement('div', { className: 'flex gap-2' },
                        React.createElement('button', {
                            onClick: copyBrief,
                            className: 'px-3 py-1.5 text-sm bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition-colors',
                            title: 'Copy markdown to clipboard'
                        }, 'ðŸ“‹ Copy'),
                        React.createElement('button', {
                            onClick: onClose,
                            className: 'p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors'
                        }, 'âœ•')
                    )
                ),
                // Content
                React.createElement('div', { className: 'flex-1 overflow-y-auto p-4' },
                    loading
                        ? React.createElement('div', { className: 'flex items-center justify-center py-12 text-slate-400' }, 'â³ Generating brief...')
                        : renderMarkdown(briefContent)
                )
            )
        );
    }

    // =========================================================================
    // MAIN APP
    // =========================================================================
    
    function AnalyticsApp() {
        const [activeTab, setActiveTab] = React.useState('portfolio');
        const [dialog, setDialog] = React.useState(null);
        
        // GitHub API (from shared secrets)
        const githubToken = CC.getGitHubToken();
        
        // Firebase auth state
        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [firebaseUid, setFirebaseUid] = React.useState(CC.getFirebaseUid());
        
        React.useEffect(() => {
            if (!firebaseAuth) return;
            const unsub = firebaseAuth.onAuthStateChanged(u => {
                setFirebaseUser(u);
                if (u) setFirebaseUid(u.uid);
            });
            return () => unsub();
        }, []);
        
        // Config from CC Core
        const config = React.useMemo(() => CC.getConfig(), []);
        const apps = React.useMemo(() => {
            if (!config.apps) return {};
            const result = {};
            Object.entries(config.apps).forEach(([id, app]) => {
                result[id] = { ...app, id };
            });
            return result;
        }, [config]);
        
        // Deployments from localStorage
        const [deployments, setDeployments] = React.useState(() => DeployService.load());
        
        // Firebase live data
        const [globalWorkItems, setGlobalWorkItems] = React.useState([]);
        const [globalSessions, setGlobalSessions] = React.useState([]);
        const [globalStreams, setGlobalStreams] = React.useState([]);
        const [globalInterfaces, setGlobalInterfaces] = React.useState([]);
        const [globalDependencies, setGlobalDependencies] = React.useState([]);
        const [globalDependencyAlerts, setGlobalDependencyAlerts] = React.useState([]);
        const [globalActivity, setGlobalActivity] = React.useState([]);
        const [teamMembers, setTeamMembers] = React.useState([]);
        const [teamMembership, setTeamMembership] = React.useState(null);
        
        // Product brief modal state
        const [viewBriefApp, setViewBriefApp] = React.useState(null);
        
        React.useEffect(() => {
            if (!firebaseAuth) return;
            const unsubs = [];
            const unsub = firebaseAuth.onAuthStateChanged(u => {
                if (!u || !firebaseDb) return;
                
                unsubs.push(WorkItemService.listen(u.uid, setGlobalWorkItems));
                unsubs.push(SessionService.listen(u.uid, setGlobalSessions));
                unsubs.push(WorkStreamService.listen(u.uid, setGlobalStreams));
                unsubs.push(StreamInterfaceService.listen(u.uid, setGlobalInterfaces));
                unsubs.push(DependencyService.listen(u.uid, setGlobalDependencies));
                unsubs.push(DependencyAlertService.listen(u.uid, setGlobalDependencyAlerts));
                unsubs.push(ActivityLogService.listen(u.uid, setGlobalActivity));
                unsubs.push(TeamService.listen(u.uid, setTeamMembers));
                unsubs.push(TeamService.listenMemberships(u.uid, setTeamMembership));
            });
            return () => { unsub(); unsubs.forEach(fn => fn()); };
        }, []);
        
        // Cross-app navigation stub â€” opens CC Core views in new tab
        const setView = (viewName) => {
            const coreUrl = CC.getCoreUrl();
            if (coreUrl) {
                window.open(`${coreUrl}#view=${viewName}`, '_blank');
            }
        };
        
        // Alert/Confirm/Prompt â€” Promise-based (matching CC Core pattern)
        const showAlert = (message, title) => {
            return new Promise((resolve) => {
                setDialog({ type: 'alert', title, message, onConfirm: () => resolve(true) });
            });
        };
        
        const showConfirm = (message, title) => {
            return new Promise((resolve) => {
                setDialog({ type: 'confirm', title, message, onConfirm: () => resolve(true), onCancel: () => resolve(false) });
            });
        };
        
        const showPrompt = (message, defaultValue = '', title) => {
            return new Promise((resolve) => {
                setDialog({ type: 'prompt', title, message, defaultValue, onConfirm: (val) => resolve(val), onCancel: () => resolve(null) });
            });
        };
        
        // Check credentials
        if (!githubToken && !firebaseUid) {
            return <MissingCredentials title="Analytics" />;
        }
        
        const tabs = [
            { id: 'portfolio', label: 'ðŸ“Š Portfolio' },
            { id: 'optimize', label: 'ðŸŽ¯ Setup Guide' },
            { id: 'users', label: 'ðŸ‘¥ Users' },
            { id: 'beta', label: 'ðŸ§ª Beta Program' },
            { id: 'streams', label: 'ðŸ”€ Streams' },
            { id: 'briefs', label: 'ðŸ“„ Product Briefs' },
            { id: 'activity', label: 'ðŸ“¡ Activity Feed' },
        ];
        
        return (
            <div className="min-h-screen bg-slate-900">
                <SatelliteHeader title="Analytics" />
                
                {/* Tab bar */}
                <div className="bg-slate-800/50 border-b border-slate-700 px-4 overflow-x-auto">
                    <div className="max-w-7xl mx-auto flex gap-1 py-2">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${
                                    activeTab === tab.id
                                        ? 'bg-indigo-600/30 text-indigo-300 border border-indigo-500/30'
                                        : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>
                </div>
                
                {/* Tab content */}
                <div className="max-w-7xl mx-auto p-6">
                    {activeTab === 'portfolio' && (
                        <PortfolioView
                            apps={apps}
                            config={config}
                            globalWorkItems={globalWorkItems}
                            globalSessions={globalSessions}
                            deployments={deployments}
                            showAlert={showAlert}
                        />
                    )}
                    
                    {activeTab === 'optimize' && (
                        <EnvironmentOptimizationView
                            apps={apps}
                            config={config}
                            globalSessions={globalSessions}
                            showAlert={showAlert}
                        />
                    )}
                    
                    {activeTab === 'users' && (
                        <UsersView showAlert={showAlert} />
                    )}
                    
                    {activeTab === 'beta' && (
                        <BetaAnalyticsView showAlert={showAlert} />
                    )}
                    
                    {activeTab === 'streams' && (
                        <WorkStreamsView
                            apps={apps}
                            config={config}
                            globalWorkItems={globalWorkItems}
                            globalStreams={globalStreams}
                            globalInterfaces={globalInterfaces}
                            globalDependencies={globalDependencies}
                            globalDependencyAlerts={globalDependencyAlerts || []}
                            showAlert={showAlert}
                            showConfirm={showConfirm}
                            showPrompt={showPrompt}
                            setView={setView}
                        />
                    )}
                    
                    {activeTab === 'briefs' && (() => {
                        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
                        return (
                            <div>
                                <div className="flex items-center gap-3 mb-6">
                                    <span className="text-2xl">ðŸ“„</span>
                                    <div>
                                        <h1 className="text-2xl font-bold">Product Briefs</h1>
                                        <p className="text-slate-400 text-sm">Auto-generated product documentation from your app data</p>
                                    </div>
                                </div>
                                <div className="grid gap-3">
                                    {configuredApps.map(app => {
                                        const scopeData = config.apps?.[app.id]?.scope;
                                        const hasData = ProductBriefGenerator.hasData(app, scopeData, globalWorkItems);
                                        return (
                                            <div key={app.id} className="bg-slate-800 rounded-lg border border-slate-700 p-4 flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xl">{app.icon || 'ðŸ“±'}</span>
                                                    <div>
                                                        <div className="font-medium">{app.name}</div>
                                                        <div className="text-xs text-slate-400">
                                                            {hasData ? 'âœ… Brief data available' : 'âš ï¸ No scope data â€” run scoping in CC Core'}
                                                        </div>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => setViewBriefApp(app)}
                                                    disabled={!hasData}
                                                    className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm font-medium"
                                                >
                                                    View Brief
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })()}
                    
                    {activeTab === 'activity' && (
                        <ActivityFeedView
                            globalActivity={globalActivity}
                            teamMembers={teamMembers}
                        />
                    )}
                </div>
                
                {/* Product Brief Modal */}
                {viewBriefApp && (
                    <ProductBriefModal
                        app={viewBriefApp}
                        config={config}
                        globalWorkItems={globalWorkItems}
                        deployments={deployments || []}
                        globalStreams={globalStreams}
                        firebaseUid={firebaseUid}
                        onClose={() => setViewBriefApp(null)}
                        showAlert={showAlert}
                    />
                )}
                
                {/* Dialog overlay */}
                {dialog && (
                    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={() => { if (dialog.onCancel) dialog.onCancel(); setDialog(null); }}>
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-6 max-w-md w-full shadow-xl" onClick={e => e.stopPropagation()}>
                            {dialog.title && <h3 className="text-lg font-semibold mb-2">{dialog.title}</h3>}
                            <p className="text-sm text-slate-300 mb-4 whitespace-pre-wrap">{dialog.message}</p>
                            
                            {dialog.type === 'prompt' && (() => {
                                const [val, setVal] = React.useState(dialog.defaultValue || '');
                                return (
                                    <input type="text" value={val} onChange={e => setVal(e.target.value)}
                                        onKeyDown={e => { if (e.key === 'Enter') { dialog.onConfirm(val); setDialog(null); } }}
                                        autoFocus
                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm mb-4 focus:border-indigo-500 focus:outline-none" />
                                );
                            })()}
                            
                            <div className="flex justify-end gap-2">
                                {(dialog.type === 'confirm' || dialog.type === 'prompt') && (
                                    <button onClick={() => { if (dialog.onCancel) dialog.onCancel(); setDialog(null); }}
                                        className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">Cancel</button>
                                )}
                                <button onClick={() => {
                                    if (dialog.type === 'prompt') {
                                        const input = document.querySelector('.dialog-input');
                                        dialog.onConfirm(input?.value || dialog.defaultValue || '');
                                    } else {
                                        dialog.onConfirm();
                                    }
                                    setDialog(null);
                                }} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium">OK</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }
    
    ReactDOM.render(<AnalyticsApp />, document.getElementById('root'));
    </script>
</body>
</html>
